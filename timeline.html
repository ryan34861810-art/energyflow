import pandas as pd
from pyecharts import options as opts
from pyecharts.charts import Sankey, Tab
import glob
import re
from pathlib import Path

# ------------------------
# 過濾部門層級
# ------------------------
def filter_to_department_level(data):
    department_level = {
        '工業部門', '運輸部門', '農業部門', '服務業部門',
        '住宅部門', '轉換效率損失', '商業部門'
    }
    filtered_data = []
    for _, row in data.iterrows():
        source, target = row['Source'], row['Target']
        if source in department_level and target not in department_level:
            continue
        filtered_data.append(row)
    return pd.DataFrame(filtered_data)

# ------------------------
# 讀取 CSV
# ------------------------
def read_csv(file_path):
    encodings = ['big5', 'cp950', 'utf-8', 'utf-8-sig']
    for enc in encodings:
        try:
            df = pd.read_csv(file_path, encoding=enc)
            return df
        except:
            continue
    return None

# ------------------------
# 準備桑基圖資料
# ------------------------
def prepare_sankey_data(data):
    nodes = [{"name": n} for n in sorted(set(data['Source']).union(data['Target']))]
    links = []
    for _, row in data.iterrows():
        value = float(row['Value(KLOE)'] / 1000)  # 轉 kKLOE
        links.append({"source": row['Source'], "target": row['Target'], "value": value})
    return nodes, links

# ------------------------
# 建立桑基圖
# ------------------------
def create_sankey_chart(nodes, links, year):
    sankey = (
        Sankey()
        .add(
            series_name=f"{year}年能源流向",
            nodes=nodes,
            links=links,
            linestyle_opt=opts.LineStyleOpts(opacity=0.3, curve=0.5, color="source"),
            label_opts=opts.LabelOpts(position="right", font_size=12)
        )
        .set_global_opts(
            title_opts=opts.TitleOpts(
                title=f"台灣能源流向圖 ({year}年)",
                subtitle="單位：千公噸油當量",
                pos_left="center"
            )
        )
    )
    return sankey

# ------------------------
# 主程式
# ------------------------
def main():
    tab = Tab()
    for i in range(73, 114):  # template073 ~ template113
        file_path = f"template{i}.csv"
        if not Path(file_path).exists():
            print(f"跳過不存在的檔案：{file_path}")
            continue

        df = read_csv(file_path)
        if df is None:
            print(f"讀取失敗：{file_path}")
            continue

        # 部門層級過濾（可修改為 False 使用完整資料）
        df = filter_to_department_level(df)

        # 檢查必要欄位
        if not {'Source','Target','Value(KLOE)'}.issubset(df.columns):
            print(f"缺少必要欄位：{file_path}")
            continue

        nodes, links = prepare_sankey_data(df)
        sankey = create_sankey_chart(nodes, links, year=f"{2000+i}" if i<100 else f"{1900+i}")
        tab.add(sankey, f"{2000+i}" if i<100 else f"{1900+i}")

    # 輸出單一 HTML
    tab.render("taiwan_energy_sankey_all_years.html")
    print("✅ 已生成 taiwan_energy_sankey_all_years.html")

if __name__ == "__main__":
    main()
