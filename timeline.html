<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>èƒ½æºæµè¦–è¦ºåŒ– - Timeline</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-sankey/0.12.3/d3-sankey.min.js"></script>
  <style>
    body {
      font-family: "Noto Sans TC", "Microsoft JhengHei", sans-serif;
      margin: 0;
      background-color: #f5f5f5;
    }
    #timeline-container {
      padding: 15px 30px;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    #events-display {
      position: absolute;
      top: -80px;
      left: 0;
      right: 0;
      height: 75px;
      pointer-events: none;
    }
    .event-item {
      position: absolute;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      animation: eventFadeIn 0.4s ease;
    }
    @keyframes eventFadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .event-name {
      font-size: 11px;
      font-weight: 600;
      color: #333;
      white-space: nowrap;
      text-align: center;
      background: rgba(255, 255, 255, 0.95);
      padding: 3px 7px;
      border-radius: 3px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
      z-index: 2;
      position: relative;
    }
    .event-bar-container {
      width: 100%;
      position: relative;
      height: 8px;
    }
    .event-bar {
      height: 8px;
      background: linear-gradient(90deg, #668ab9, #7099cf);
      border-radius: 4px;
      position: absolute;
      left: 0;
      right: 0;
      box-shadow: 0 2px 4px rgba(102, 138, 185, 0.3);
    }
    .event-bar::before,
    .event-bar::after {
      content: '';
      position: absolute;
      width: 2px;
      height: 24px;
      background: rgba(102, 138, 185, 0.8);
      top: -8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .event-bar::before {
      left: 0;
      background: linear-gradient(to bottom, rgba(102, 138, 185, 0.3), rgba(102, 138, 185, 0.9));
    }
    .event-bar::after {
      right: 0;
      background: linear-gradient(to bottom, rgba(112, 153, 207, 0.3), rgba(112, 153, 207, 0.9));
    }
    .event-years {
      font-size: 9px;
      color: #666;
      white-space: nowrap;
      background: rgba(255, 255, 255, 0.95);
      padding: 2px 5px;
      border-radius: 2px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      margin-top: 1px;
    }
    #slider-container {
      display: flex;
      align-items: center;
      gap: 15px;
      width: 100%;
      position: relative;
      padding-top: 85px;
    }
    #slider-wrapper {
      flex: 1;
      position: relative;
    }
    #yearSlider {
      width: 100%;
      margin: 0;
      padding: 0;
      -webkit-appearance: none;
      appearance: none;
      height: 8px;
      background: linear-gradient(to right, #ddd 0%, #ddd 100%);
      border-radius: 4px;
      outline: none;
    }
    #yearSlider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      background: #7099cf;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      transition: all 0.2s;
      margin-top: -6px;
    }
    #yearSlider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      background: #7099cf;
      border-radius: 50%;
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      transition: all 0.2s;
    }
    #yearSlider::-webkit-slider-runnable-track {
      width: 100%;
      height: 8px;
      background: transparent;
      border-radius: 4px;
    }
    #yearSlider::-moz-range-track {
      width: 100%;
      height: 8px;
      background: transparent;
      border-radius: 4px;
    }
    #slider-container label {
      white-space: nowrap;
    }
    #slider-container #yearSlider {
      flex: 1;
      min-width: 200px;
      width: 100%;
    }
    #slider-container #yearDisplay {
      font-size: 20px;
      font-weight: bold;
      min-width: 60px;
    }
    #timeline-container label {
      white-space: nowrap;
    }
    #yearSlider {
      flex: 1;
      min-width: 200px;
    }
    #yearDisplay {
      font-size: 20px;
      font-weight: bold;
      min-width: 60px;
    }
    #stats-container {
      padding: 15px 20px;
      background: linear-gradient(135deg, #668ab9 0%, #7099cf 100%);
      color: white;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      position: relative;
    }
    #stats-grid {
      display: flex;
      justify-content: space-around;
      align-items: center;
      gap: 20px;
    }
    #stats-year {
      opacity: 0;
      animation: fadeInUp 0.5s ease forwards;
      font-weight: 300;
      font-size: 32px;
    }
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 0.95;
        transform: translateY(0);
      }
    }
    .stat-item {
      text-align: center;
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 80px;
    }
    .stat-value {
      font-size: 28px;
      font-weight: bold;
      margin: 3px 0;
      line-height: 1.2;
    }
    .stat-label {
      font-size: 12px;
      opacity: 0.9;
      line-height: 1.2;
    }
    #chart {
      width: 100%;
      height: 88vh;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: -50px;
    }
    .node rect {
      stroke: #333;
      stroke-width: 2px;
      rx: 4;
      ry: 4;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.15));
    }
    .node text {
      font-size: 14px;
      pointer-events: all;
    }
    .node.clickable text {
      font-weight: bold;
      fill: #ff6b35;
    }
    .node {
      pointer-events: all;
    }
    .node-hitarea {
      fill: transparent;
      stroke-opacity: 0;
    }
    .link {
      fill: none;
      stroke-opacity: 0.4;
    }
    .link:hover {
      stroke-opacity: 0.7;
    }
    #tooltip {
      position: absolute;
      background: white;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 5px;
      display: none;
      pointer-events: none;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      z-index: 1001;
    }
    
    #modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    #modal-content {
      background: white;
      border-radius: 15px;
      padding: 30px;
      width: 85%;
      max-width: 1400px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      position: relative;
      animation: modalFadeIn 0.3s ease;
    }
    
    @keyframes modalFadeIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    
    #modal-close {
      position: absolute;
      top: 15px;
      right: 15px;
      width: 35px;
      height: 35px;
      background: #333;
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.3s;
      z-index: 10;
    }
    
    #modal-close:hover {
      background: #000;
    }
    
    #modal-title {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 20px;
      color: #333;
      padding-right: 50px;
    }
    
    #modal-sankey {
      width: 100%;
      height: 600px;
      margin-top: 20px;
    }
    
    .modal-link {
      cursor: pointer;
    }
    
    .modal-link:hover {
      fill-opacity: 0.7 !important;
    }
    
    .modal-node rect {
      stroke: #333;
      stroke-width: 2px;
      rx: 4;
      ry: 4;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.15));
    }
    
    .modal-node text {
      font-size: 13px;
      pointer-events: none;
    }
    
    #trend-container {
      background: white;
      padding: 30px;
      margin: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    #trend-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    #trend-title {
      font-size: 22px;
      font-weight: bold;
      color: #333;
    }
    
    #trend-controls {
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .data-selector {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .data-selector label {
      font-size: 14px;
      color: #666;
      font-weight: 500;
    }
    
    .data-selector select {
      padding: 8px 12px;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      background: white;
      cursor: pointer;
      transition: border-color 0.3s;
      min-width: 180px;
    }
    
    .data-selector select:hover {
      border-color: #7099cf;
    }
    
    .data-selector select:focus {
      outline: none;
      border-color: #7099cf;
    }
    
    #trend-chart {
      width: 100%;
      height: 400px;
      margin-top: 10px;
    }
    
    .trend-line {
      fill: none;
      stroke-width: 3;
      transition: stroke-width 0.3s;
    }
    
    .trend-line:hover {
      stroke-width: 5;
    }
    
    .trend-dot {
      fill: white;
      stroke-width: 2;
      cursor: pointer;
      transition: r 0.3s;
    }
    
    .trend-dot:hover {
      r: 6;
    }
    
    .axis-label {
      font-size: 12px;
      fill: #666;
    }
    
    .legend {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin-top: 15px;
      flex-wrap: wrap;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #333;
    }
    
    .legend-color {
      width: 30px;
      height: 4px;
      border-radius: 2px;
    }
    
    #loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.95);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 20px;
    }
    
    #loading-overlay.hidden {
      display: none;
    }
    
    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 5px solid #e0e0e0;
      border-top: 5px solid #7099cf;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      font-size: 18px;
      color: #333;
      font-weight: 500;
    }
    
    .loading-progress {
      width: 300px;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
    }
    
    .loading-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #668ab9, #7099cf);
      width: 0%;
      transition: width 0.3s;
      border-radius: 4px;
    }
  </style>
</head>
<body>

  <div id="loading-overlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">è¼‰å…¥èƒ½æºæ•¸æ“šä¸­...</div>
    <div class="loading-progress">
      <div class="loading-progress-bar" id="loading-bar"></div>
    </div>
  </div>

  <div id="timeline-container">
    <div id="slider-container">
      <label for="yearSlider">å¹´ä»½ï¼š</label>
      <div id="slider-wrapper">
        <div id="events-display"></div>
        <input type="range" id="yearSlider" name="yearSlider" min="1984" max="2024" value="1984" step="1" style="width: 100%;" />
      </div>
      <span id="yearDisplay">1984</span>
    </div>
  </div>

  <div id="stats-container">
    <div id="stats-grid">
      <div class="stat-item">
        <div class="stat-value" id="stats-year">1984</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">ç¸½èƒ½æºä¾›çµ¦</div>
        <div class="stat-value" id="totalEnergy">-</div>
        <div class="stat-label">ktoe</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">ç…¤åŠç…¤ç”¢å“ä½”æ¯”</div>
        <div class="stat-value" id="coalPercent">-</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">ğŸŒ±å†ç”Ÿèƒ½æºä½”æ¯”</div>
        <div class="stat-value" id="renewablePercent">-</div>
      </div>
    </div>
  </div>

  <div id="chart"></div>
  <div id="tooltip"></div>
  
  <div id="trend-container">
    <div id="trend-header">
      <div id="trend-title">æ­·å¹´æ•¸æ“šè¶¨å‹¢åˆ†æ</div>
      <div id="trend-controls">
        <div class="data-selector">
          <label for="data1">æ•¸æ“š1ï¼š</label>
          <select id="data1">
            <option value="ç…¤åŠç…¤ç”¢å“">ç…¤åŠç…¤ç”¢å“</option>
            <option value="åŸæ²¹åŠçŸ³æ²¹ç”¢å“">åŸæ²¹åŠçŸ³æ²¹ç”¢å“</option>
            <option value="å¤©ç„¶æ°£">å¤©ç„¶æ°£</option>
            <option value="æ ¸èƒ½">æ ¸èƒ½</option>
            <option value="æ°´åŠ›">æ°´åŠ›</option>
            <option value="åœ°ç†±">åœ°ç†±</option>
            <option value="å¤ªé™½å…‰é›»">å¤ªé™½å…‰é›»</option>
            <option value="é¢¨åŠ›">é¢¨åŠ›</option>
            <option value="ç”Ÿè³ªèƒ½åŠå»¢æ£„ç‰©">ç”Ÿè³ªèƒ½åŠå»¢æ£„ç‰©</option>
            <option value="å†ç”Ÿèƒ½æº" selected>å†ç”Ÿèƒ½æº</option>
            <option value="å·¥æ¥­éƒ¨é–€">å·¥æ¥­éƒ¨é–€</option>
            <option value="é‹è¼¸éƒ¨é–€">é‹è¼¸éƒ¨é–€</option>
            <option value="ä½å®…éƒ¨é–€">ä½å®…éƒ¨é–€</option>
            <option value="æœå‹™æ¥­éƒ¨é–€">æœå‹™æ¥­éƒ¨é–€</option>
            <option value="è¾²æ¥­éƒ¨é–€">è¾²æ¥­éƒ¨é–€</option>
          </select>
        </div>
        <div class="data-selector">
          <label for="data2">æ•¸æ“š2ï¼š</label>
          <select id="data2">
            <option value="ç…¤åŠç…¤ç”¢å“" selected>ç…¤åŠç…¤ç”¢å“</option>
            <option value="åŸæ²¹åŠçŸ³æ²¹ç”¢å“">åŸæ²¹åŠçŸ³æ²¹ç”¢å“</option>
            <option value="å¤©ç„¶æ°£">å¤©ç„¶æ°£</option>
            <option value="æ ¸èƒ½">æ ¸èƒ½</option>
            <option value="æ°´åŠ›">æ°´åŠ›</option>
            <option value="åœ°ç†±">åœ°ç†±</option>
            <option value="å¤ªé™½å…‰é›»">å¤ªé™½å…‰é›»</option>
            <option value="é¢¨åŠ›">é¢¨åŠ›</option>
            <option value="ç”Ÿè³ªèƒ½åŠå»¢æ£„ç‰©">ç”Ÿè³ªèƒ½åŠå»¢æ£„ç‰©</option>
            <option value="å†ç”Ÿèƒ½æº">å†ç”Ÿèƒ½æº</option>
            <option value="å·¥æ¥­éƒ¨é–€">å·¥æ¥­éƒ¨é–€</option>
            <option value="é‹è¼¸éƒ¨é–€">é‹è¼¸éƒ¨é–€</option>
            <option value="ä½å®…éƒ¨é–€">ä½å®…éƒ¨é–€</option>
            <option value="æœå‹™æ¥­éƒ¨é–€">æœå‹™æ¥­éƒ¨é–€</option>
            <option value="è¾²æ¥­éƒ¨é–€">è¾²æ¥­éƒ¨é–€</option>
          </select>
        </div>
      </div>
    </div>
    <div id="trend-chart"></div>
    <div class="legend">
      <div class="legend-item">
        <div class="legend-color" style="background: #2e8b57;"></div>
        <span id="legend1">å†ç”Ÿèƒ½æº</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: #013982;"></div>
        <span id="legend2">ç…¤åŠç…¤ç”¢å“</span>
      </div>
    </div>
  </div>
  
  <div id="modal-overlay">
    <div id="modal-content">
      <button id="modal-close" type="button">Ã—</button>
      <div id="modal-title"></div>
      <div id="modal-sankey"></div>
    </div>
  </div>

<script>
const clickableDepartments = ["å·¥æ¥­éƒ¨é–€","é‹è¼¸éƒ¨é–€","è¾²æ¥­éƒ¨é–€","æœå‹™æ¥­éƒ¨é–€","ä½å®…éƒ¨é–€"];
const departments = ["å·¥æ¥­éƒ¨é–€","é‹è¼¸éƒ¨é–€","è¾²æ¥­éƒ¨é–€","æœå‹™æ¥­éƒ¨é–€","ä½å®…éƒ¨é–€","è½‰æ›æ•ˆç‡æå¤±"];
const energySources = ["ç…¤åŠç…¤ç”¢å“","åŸæ²¹åŠçŸ³æ²¹ç”¢å“","å¤©ç„¶æ°£","å†ç”Ÿèƒ½æº"];
const chart = d3.select("#chart");
const tooltip = d3.select("#tooltip");
const modalOverlay = d3.select("#modal-overlay");
const modalTitle = d3.select("#modal-title");
const modalSankey = d3.select("#modal-sankey");
const modalClose = d3.select("#modal-close");
const width = window.innerWidth * 0.95;
const height = window.innerHeight * 0.85;
const svg = chart.append("svg").attr("width", width).attr("height", height);

const sankey = d3.sankey()
  .nodeWidth(35)
  .nodePadding(25)
  .extent([[200, 80], [width - 200, height - 80]])
  .nodeAlign(d3.sankeyLeft)
  .nodeSort((a, b) => {
    if (a.layer !== b.layer) return a.layer - b.layer;
    return a.name.localeCompare(b.name);
  });

const colorMap = {
  "ç…¤åŠç…¤ç”¢å“": "#013982",
  "åŸæ²¹åŠçŸ³æ²¹ç”¢å“": "#ade6e7",
  "å¤©ç„¶æ°£": "#dcdda3",
  "æ ¸èƒ½": "#c4a3c5",
  "æ°´åŠ›": "#1e90ff",
  "åœ°ç†±": "#dc143c",
  "å¤ªé™½å…‰é›»": "#ffa500",
  "é¢¨åŠ›": "#00ced1",
  "ç”Ÿè³ªèƒ½åŠå»¢æ£„ç‰©": "#8b4513",
  "å†ç”Ÿèƒ½æº": "#2e8b57",
  "é›»åŠ›ç³»çµ±": "#ffed9f",
  "ç…¤ç‚­çš„è£½é€ èˆ‡åˆ†éŠ·": "#013982",
  "åŸæ²¹åŠçŸ³æ²¹çš„è£½é€ èˆ‡åˆ†éŠ·": "#ade6e7",
  "å¤©ç„¶æ°£çš„ç”Ÿç”¢èˆ‡åˆ†éŠ·": "#dcdda3",
  "èƒ½æºéƒ¨é–€è‡ªç”¨": "#bcbcbc",
  "é›»ç¶²æè€—": "#8c8c8c",
  "å·¥æ¥­éƒ¨é–€": "#1f77b4",
  "é‹è¼¸éƒ¨é–€": "#ff7f0e",
  "ä½å®…éƒ¨é–€": "#2ca02c",
  "æœå‹™æ¥­éƒ¨é–€": "#d62728",
  "è¾²æ¥­éƒ¨é–€": "#9467bd",
  "è½‰æ›æ•ˆç‡æå¤±": "#7f7f7f",
  "éèƒ½æºæ¶ˆè²»": "#aaaaaa"
};

function showDepartmentModal(departmentName, year) {
  const rawData = dataByYear[year] || [];
  
  const subItems = rawData.filter(d => {
    if (!d.Target || !d.Source) return false;
    
    const valueStr = d["Value(kKLOE)"];
    if (!valueStr) return false;
    
    const value = parseFloat(valueStr);
    if (isNaN(value) || value <= 0) return false;
    
    return d.Source === departmentName;
  });
  
  modalTitle.text(`${departmentName}è©³ç´°èƒ½æºæµ (${year})`);
  modalSankey.html("");
  
  modalOverlay.style("display", "flex");
  
  if (subItems.length === 0) {
    modalSankey.append("div")
      .style("text-align", "center")
      .style("padding", "50px")
      .style("color", "#999")
      .style("font-size", "16px")
      .html(`æ­¤éƒ¨é–€ç„¡è©³ç´°èƒ½æºè¼¸å‡ºæµå‘è³‡æ–™<br/><small style="color: #ccc; margin-top: 10px; display: block;">ï¼ˆå¯èƒ½æ‰€æœ‰èƒ½æºéƒ½ç›´æ¥åœ¨éƒ¨é–€å…§æ¶ˆè€—ï¼‰</small>`);
    return;
  }
  
  const sankeyNodes = [];
  const sankeyLinks = [];
  const nodeMap = new Map();
  
  let nodeIndex = 0;
  
  const sources = new Set();
  const targets = new Set();
  
  subItems.forEach(d => {
    sources.add(d.Source);
    targets.add(d.Target);
  });
  
  sources.forEach(source => {
    sankeyNodes.push({ name: source, layer: 0 });
    nodeMap.set(source, nodeIndex++);
  });
  
  targets.forEach(target => {
    sankeyNodes.push({ name: target, layer: 1 });
    nodeMap.set(target, nodeIndex++);
  });
  
  subItems.forEach(d => {
    if (nodeMap.has(d.Source) && nodeMap.has(d.Target)) {
      sankeyLinks.push({
        source: nodeMap.get(d.Source),
        target: nodeMap.get(d.Target),
        value: +d["Value(kKLOE)"]
      });
    }
  });
  
  if (sankeyLinks.length === 0) {
    modalSankey.append("div")
      .style("text-align", "center")
      .style("padding", "50px")
      .style("color", "#999")
      .text("ç„¡æœ‰æ•ˆé€£çµè³‡æ–™");
    return;
  }
  
  setTimeout(() => {
    const modalWidth = modalSankey.node().offsetWidth;
    const modalHeight = 600;
    
    if (modalWidth === 0) {
      modalSankey.append("div")
        .style("text-align", "center")
        .style("padding", "50px")
        .style("color", "#f00")
        .text("è¦–çª—å¯¬åº¦éŒ¯èª¤ï¼Œç„¡æ³•æ¸²æŸ“åœ–è¡¨");
      return;
    }
    
    const modalSvg = modalSankey.append("svg")
      .attr("width", modalWidth)
      .attr("height", modalHeight);
    
    const leftX = 100;
    const rightX = modalWidth - 150;
    const subItemPadding = 20;
    
    const totalValue = d3.sum(sankeyLinks, l => l.value);
    const availableHeight = modalHeight - 80;
    const totalPadding = subItemPadding * (sankeyNodes.filter(n => n.layer === 1).length - 1);
    const usableHeight = availableHeight - totalPadding;
    const heightScale = usableHeight / totalValue;
    
    sankeyNodes.forEach(n => {
      if (n.layer === 0) {
        const outgoingValue = d3.sum(sankeyLinks.filter(l => sankeyNodes[l.source].name === n.name), l => l.value);
        const nodeHeight = outgoingValue * heightScale;
        
        n.x0 = leftX;
        n.x1 = leftX + 35;
        n.y0 = (modalHeight - nodeHeight) / 2;
        n.y1 = n.y0 + nodeHeight;
      }
    });
    
    const rightNodes = sankeyNodes.filter(n => n.layer === 1);
    let currentY = 40;
    
    rightNodes.forEach((n, i) => {
      const incomingValue = d3.sum(sankeyLinks.filter(l => sankeyNodes[l.target].name === n.name), l => l.value);
      const nodeHeight = incomingValue * heightScale;
      
      n.x0 = rightX;
      n.x1 = rightX + 35;
      n.y0 = currentY;
      n.y1 = currentY + nodeHeight;
      currentY += nodeHeight + subItemPadding;
    });
    
    // æŒ‰ç›®æ¨™ç¯€é»çš„ y ä½ç½®æ’åºé€£çµï¼Œç¢ºä¿é€£çµé †åºæ­£ç¢º
    sankeyLinks.sort((a, b) => {
      const targetA = sankeyNodes[a.target];
      const targetB = sankeyNodes[b.target];
      return targetA.y0 - targetB.y0;
    });
    
    const nodeOffsets = new Map();
    sankeyNodes.forEach(n => {
      nodeOffsets.set(n.name, { source: n.y0, target: n.y0 });
    });
    
    const sankeyLinks2 = sankeyLinks.map(link => {
      const source = sankeyNodes[link.source];
      const target = sankeyNodes[link.target];
      const linkHeight = link.value * heightScale;
      
      const sourceOffset = nodeOffsets.get(source.name);
      const targetOffset = nodeOffsets.get(target.name);
      
      const result = {
        source: source,
        target: target,
        value: link.value,
        y0: sourceOffset.source + linkHeight / 2,
        y1: targetOffset.target + linkHeight / 2,
        width: linkHeight
      };
      
      sourceOffset.source += linkHeight;
      targetOffset.target += linkHeight;
      
      return result;
    });
    
    const departmentNode = sankeyNodes.find(n => n.layer === 0);
    const linkColor = colorMap[departmentNode.name] || "#999";
    
    modalSvg.append("g")
      .selectAll("path")
      .data(sankeyLinks2)
      .join("path")
      .attr("class", "modal-link")
      .attr("d", d => {
        const x0 = d.source.x1;
        const x1 = d.target.x0;
        const y0 = d.y0;
        const y1 = d.y1;
        const hw = d.width / 2;
        const xi = d3.interpolateNumber(x0, x1);
        const x2 = xi(0.5);
        
        return `M${x0},${y0 - hw} C${x2},${y0 - hw} ${x2},${y1 - hw} ${x1},${y1 - hw} L${x1},${y1 + hw} C${x2},${y1 + hw} ${x2},${y0 + hw} ${x0},${y0 + hw} Z`;
      })
      .attr("fill", linkColor)
      .attr("fill-opacity", 0.5);
    
    const node = modalSvg.append("g")
      .selectAll("g")
      .data(sankeyNodes)
      .join("g")
      .attr("class", "modal-node");
    
    node.append("rect")
      .attr("x", d => d.x0)
      .attr("y", d => d.y0)
      .attr("height", d => d.y1 - d.y0)
      .attr("width", d => d.x1 - d.x0)
      .attr("rx", 4)
      .attr("ry", 4)
      .attr("fill", linkColor)
      .style("filter", "drop-shadow(0 2px 4px rgba(0, 0, 0, 0.15))");
    
    node.append("text")
      .attr("x", d => d.x0 < modalWidth / 2 ? d.x1 + 6 : d.x0 - 6)
      .attr("y", d => (d.y1 + d.y0) / 2)
      .attr("dy", "0.35em")
      .attr("text-anchor", d => d.x0 < modalWidth / 2 ? "start" : "end")
      .text(d => d.name)
      .style("font-size", "15px")
      .each(function(d) {
        const self = d3.select(this);
        const textLength = self.node().getComputedTextLength();
        const availableWidth = d.x0 < modalWidth / 2 ? modalWidth - d.x1 - 20 : d.x0 - 20;
        
        if (textLength > availableWidth) {
          let text = d.name;
          while (self.node().getComputedTextLength() > availableWidth && text.length > 0) {
            text = text.slice(0, -1);
            self.text(text + "...");
          }
        }
      });
    
    node.on("mousemove", (event, d) => {
      const value = d3.sum(sankeyLinks.filter(l => 
        sankeyNodes[l.source].name === d.name || sankeyNodes[l.target].name === d.name
      ), l => l.value);
      const percentage = ((value / totalValue) * 100).toFixed(1);
      
      tooltip
        .style("display", "block")
        .style("left", (event.pageX + 15) + "px")
        .style("top", (event.pageY + 15) + "px")
        .html(`<strong>${d.name}</strong><br/>æ•¸å€¼ï¼š${value.toLocaleString()} kKLOE<br/>ä½”æ¯”ï¼š${percentage}%`);
    })
    .on("mouseout", () => tooltip.style("display", "none"));
  }, 50);
}

function closeModal() {
  modalOverlay.style("display", "none");
}

modalClose.on("click", closeModal);
modalOverlay.on("click", function(event) {
  if (event.target === modalOverlay.node()) {
    closeModal();
  }
});

const csvBase = "https://raw.githubusercontent.com/ryan34861810-art/energyflow/main/";
const years = d3.range(1984, 2025);
let dataByYear = {};
let eventsData = [];
let historicalData = [];

// è¼‰å…¥äº‹ä»¶è³‡æ–™çš„å‡½æ•¸
async function loadEvents() {
  try {
    const response = await fetch(`${csvBase}events.csv`);
    if (response.ok) {
      const text = await response.text();
      eventsData = d3.csvParse(text);
      console.log('Events loaded:', eventsData);
    }
  } catch (e) {
    console.log('No events file found or error loading events:', e);
  }
}

// æ›´æ–°äº‹ä»¶é¡¯ç¤º
function updateEventsDisplay(year) {
  const eventsDisplay = d3.select("#events-display");
  eventsDisplay.html("");
  
  if (!eventsData || eventsData.length === 0) return;
  
  const activeEvents = eventsData.filter(e => {
    const start = +e.start;
    const end = +e.end;
    return year >= start && year <= end;
  });
  
  const slider = document.getElementById("yearSlider");
  const minYear = +slider.min;
  const maxYear = +slider.max;
  const yearRange = maxYear - minYear;
  
  // å–å¾—æ»‘æ¡¿çš„å¯¦éš›å°ºå¯¸
  const sliderRect = slider.getBoundingClientRect();
  const sliderWidth = sliderRect.width;
  
  // thumb å¯¬åº¦ç‚º 20pxï¼Œæ»‘æ¡¿çš„æœ‰æ•ˆç¯„åœéœ€è¦æ‰£é™¤å…©ç«¯å„ 10px
  const thumbRadius = 10;
  const effectiveWidth = sliderWidth - (thumbRadius * 2);
  
  // å°äº‹ä»¶æŒ‰é–‹å§‹å¹´ä»½æ’åº
  activeEvents.sort((a, b) => +a.start - +b.start);
  
  // è¨ˆç®—å‚ç›´åˆ†å±¤ï¼Œé¿å…é‡ç–Š
  const layers = [];
  
  activeEvents.forEach((event) => {
    const start = +event.start;
    const end = +event.end;
    
    // æ‰¾åˆ°ç¬¬ä¸€å€‹ä¸é‡ç–Šçš„å±¤
    let layerIndex = 0;
    while (layerIndex < layers.length) {
      const canFit = layers[layerIndex].every(e => {
        const eStart = +e.start;
        const eEnd = +e.end;
        return end < eStart - 2 || start > eEnd + 2;
      });
      if (canFit) break;
      layerIndex++;
    }
    
    if (layerIndex === layers.length) {
      layers.push([]);
    }
    layers[layerIndex].push(event);
    
    // è¨ˆç®—å¹´ä»½åœ¨æ»‘æ¡¿ä¸Šçš„æ¯”ä¾‹ä½ç½®
    const startRatio = (start - minYear) / yearRange;
    const endRatio = (end - minYear) / yearRange;
    
    // è½‰æ›ç‚ºå¯¦éš›åƒç´ ä½ç½®ï¼ˆåŠ ä¸Šå·¦å´åç§»ï¼‰
    const leftPx = thumbRadius + (startRatio * effectiveWidth);
    const rightPx = thumbRadius + (endRatio * effectiveWidth);
    const widthPx = rightPx - leftPx;
    
    const eventItem = eventsDisplay.append("div")
      .attr("class", "event-item")
      .style("left", `${leftPx}px`)
      .style("width", `${widthPx}px`)
      .style("bottom", `${layerIndex * 28}px`);
    
    eventItem.append("div")
      .attr("class", "event-name")
      .text(event.event);
    
    const barContainer = eventItem.append("div")
      .attr("class", "event-bar-container");
    
    barContainer.append("div")
      .attr("class", "event-bar");
    
    eventItem.append("div")
      .attr("class", "event-years")
      .text(`${event.start} - ${event.end}`);
  });
}

async function loadAllCSV() {
  // å…ˆè¼‰å…¥äº‹ä»¶è³‡æ–™
  await loadEvents();
  
  const totalYears = years.length;
  let loadedYears = 0;
  
  for (const y of years) {
    const rocYear = y - 1911;
    const urls = [
      `${csvBase}template${String(rocYear).padStart(3,"0")}.csv`,
      `${csvBase}template${rocYear}.csv`
    ];
    
    for (const url of urls) {
      try {
        const response = await fetch(url);
        if (!response.ok) continue;
        
        let text = await response.text();
        
        if (text.includes('ï¿½') || text.match(/[\u0080-\u009F]/)) {
          const blob = await (await fetch(url)).blob();
          text = await new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.readAsText(blob, 'Big5');
          });
        }
        
        const data = d3.csvParse(text);
        if (data && data.length > 0) {
          dataByYear[y] = data;
          break;
        }
      } catch (e) {
        console.error(`Failed to load ${url}:`, e);
      }
    }
    
    loadedYears++;
    const progress = (loadedYears / totalYears) * 100;
    d3.select("#loading-bar").style("width", progress + "%");
  }
  
  // è¨ˆç®—æ­·å¹´çµ±è¨ˆæ•¸æ“š
  calculateHistoricalData();
  
  // éš±è—è¼‰å…¥ç•«é¢
  d3.select("#loading-overlay").classed("hidden", true);
  
  updateChart(1984);
  updateEventsDisplay(1984);
  updateTrendChart();
}

// è¨ˆç®—æ­·å¹´æ•¸æ“š - æ”¹ç‚ºè¨ˆç®—å„ç¯€é»çš„æ•¸å€¼
function calculateHistoricalData() {
  historicalData = [];
  
  const nodeNames = [
    "ç…¤åŠç…¤ç”¢å“", "åŸæ²¹åŠçŸ³æ²¹ç”¢å“", "å¤©ç„¶æ°£", "æ ¸èƒ½", 
    "æ°´åŠ›", "åœ°ç†±", "å¤ªé™½å…‰é›»", "é¢¨åŠ›", "ç”Ÿè³ªèƒ½åŠå»¢æ£„ç‰©", "å†ç”Ÿèƒ½æº",
    "å·¥æ¥­éƒ¨é–€", "é‹è¼¸éƒ¨é–€", "ä½å®…éƒ¨é–€", "æœå‹™æ¥­éƒ¨é–€", "è¾²æ¥­éƒ¨é–€"
  ];
  
  years.forEach(year => {
    const yearData = { year };
    const currentData = filterDepartmentLevel(dataByYear[year] || []);
    const allData = dataByYear[year] || [];
    
    nodeNames.forEach(nodeName => {
      // è¨ˆç®—è©²ç¯€é»ç›¸é—œçš„æ‰€æœ‰æµé‡
      let value = 0;
      
      // å°æ–¼èƒ½æºä¾†æºï¼Œè¨ˆç®—å¾è©²ä¾†æºæµå‡ºçš„ç¸½é‡
      if (["ç…¤åŠç…¤ç”¢å“", "åŸæ²¹åŠçŸ³æ²¹ç”¢å“", "å¤©ç„¶æ°£", "æ ¸èƒ½", "æ°´åŠ›", "åœ°ç†±", "å¤ªé™½å…‰é›»", "é¢¨åŠ›", "ç”Ÿè³ªèƒ½åŠå»¢æ£„ç‰©"].includes(nodeName)) {
        value = d3.sum(allData.filter(d => 
          d.Source && d.Source.includes(nodeName.substring(0, 3)) && +d["Value(kKLOE)"] > 0
        ), d => +d["Value(kKLOE)"]);
      }
      // å°æ–¼å†ç”Ÿèƒ½æºï¼Œç‰¹æ®Šè™•ç†
      else if (nodeName === "å†ç”Ÿèƒ½æº") {
        const renewableKeywords = ["æ°´åŠ›", "åœ°ç†±", "å¤ªé™½", "é¢¨åŠ›", "ç”Ÿè³ª"];
        value = d3.sum(allData.filter(d => 
          d.Source && renewableKeywords.some(keyword => d.Source.includes(keyword)) && +d["Value(kKLOE)"] > 0
        ), d => +d["Value(kKLOE)"]);
      }
      // å°æ–¼éƒ¨é–€ï¼Œè¨ˆç®—æµå…¥è©²éƒ¨é–€çš„ç¸½é‡
      else if (["å·¥æ¥­éƒ¨é–€", "é‹è¼¸éƒ¨é–€", "ä½å®…éƒ¨é–€", "æœå‹™æ¥­éƒ¨é–€", "è¾²æ¥­éƒ¨é–€"].includes(nodeName)) {
        value = d3.sum(allData.filter(d => 
          d.Target === nodeName && +d["Value(kKLOE)"] > 0
        ), d => +d["Value(kKLOE)"]);
      }
      
      yearData[nodeName] = value;
    });
    
    historicalData.push(yearData);
  });
  
  console.log("Historical data calculated:", historicalData.slice(0, 3));
}

function filterDepartmentLevel(data) {
  return data.filter(d => {
    if (!d.Source || !d.Target) return false;
    
    const valueStr = d["Value(kKLOE)"];
    if (!valueStr) return false;
    
    const value = parseFloat(valueStr);
    if (isNaN(value) || value <= 0) return false;
    
    if (departments.includes(d.Target)) return true;
    
    if (d.Target.includes("ç³»çµ±") || 
        d.Target.includes("è£½é€ èˆ‡åˆ†éŠ·") || 
        d.Target.includes("ç”Ÿç”¢èˆ‡åˆ†éŠ·") ||
        d.Target.includes("èƒ½æºéƒ¨é–€è‡ªç”¨") ||
        d.Target.includes("é›»ç¶²æè€—")) return true;
    
    if (d.Source.includes("é›»åŠ›ç³»çµ±") || d.Source.includes("ç³»çµ±")) return true;
    
    const sourceKeywords = ["ç…¤", "åŸæ²¹", "çŸ³æ²¹", "å¤©ç„¶æ°£", "æ ¸èƒ½", "æ°´åŠ›", "åœ°ç†±", "å¤ªé™½", "é¢¨åŠ›", "ç”Ÿè³ª"];
    if (sourceKeywords.some(keyword => d.Source.includes(keyword))) return true;
    
    return false;
  });
}

function buildSankeyData(data) {
  const nodes = Array.from(new Set(data.flatMap(d => [d.Source, d.Target]))).map(name => ({ name }));
  const nodeMap = new Map(nodes.map((d, i) => [d.name, i]));
  const links = data.map(d => ({
    source: nodeMap.get(d.Source),
    target: nodeMap.get(d.Target),
    value: +d["Value(kKLOE)"]
  }));

  nodes.forEach(n => {
    if (energySources.some(s => n.name.includes(s.substring(0, 3))) ||
        n.name.includes("æ ¸èƒ½") || n.name.includes("æ°´åŠ›") || 
        n.name.includes("åœ°ç†±") || n.name.includes("å¤ªé™½") || 
        n.name.includes("é¢¨åŠ›") || n.name.includes("ç”Ÿè³ª")) {
      n.layer = 0;
    } 
    else if (departments.includes(n.name)) {
      n.layer = 2;
    } 
    else {
      n.layer = 1;
    }
  });

  return { nodes, links };
}

function updateChart(year) {
  const yearElement = d3.select("#stats-year");
  yearElement.style("animation", "none");
  setTimeout(() => {
    yearElement.text(year).style("animation", "fadeInUp 0.5s ease forwards");
  }, 10);
  
  d3.select("#yearDisplay").text(year);
  
  svg.selectAll("*").remove();

  const rawData = dataByYear[year] || [];
  const currentData = filterDepartmentLevel(rawData);
  const prevData = filterDepartmentLevel(dataByYear[year - 1] || []);

  if (!currentData.length) {
    return;
  }

  const allData = dataByYear[year] || [];
  
  const energySourceKeywords = ["ç…¤", "åŸæ²¹", "çŸ³æ²¹", "å¤©ç„¶æ°£", "æ ¸èƒ½", "æ°´åŠ›", "åœ°ç†±", "å¤ªé™½", "é¢¨åŠ›", "ç”Ÿè³ª", "æ½®æ±"];
  const totalEnergy = d3.sum(allData.filter(d => 
    energySourceKeywords.some(keyword => d.Source && d.Source.includes(keyword)) &&
    +d["Value(kKLOE)"] > 0
  ), d => +d["Value(kKLOE)"]);
  
  const coalEnergy = d3.sum(allData.filter(d => 
    d.Source && d.Source.includes("ç…¤") && +d["Value(kKLOE)"] > 0
  ), d => +d["Value(kKLOE)"]);
  
  const renewableKeywords = ["æ°´åŠ›", "åœ°ç†±", "å¤ªé™½", "é¢¨åŠ›", "ç”Ÿè³ª"];
  const renewableEnergy = d3.sum(allData.filter(d => 
    d.Source && renewableKeywords.some(keyword => d.Source.includes(keyword)) &&
    +d["Value(kKLOE)"] > 0
  ), d => +d["Value(kKLOE)"]);
  
  const coalPercent = totalEnergy > 0 ? ((coalEnergy / totalEnergy) * 100).toFixed(1) : 0;
  const renewablePercent = totalEnergy > 0 ? ((renewableEnergy / totalEnergy) * 100).toFixed(1) : 0;

  d3.select("#totalEnergy").text(totalEnergy.toLocaleString());
  d3.select("#coalPercent").text(coalPercent + "%");
  d3.select("#renewablePercent").text(renewablePercent + "%");

  const graphData = buildSankeyData(currentData);
  
  const layerX = {
    0: 200,
    1: width / 2,
    2: width - 250
  };
  
  graphData.nodes.forEach(n => {
    n.fixedX = layerX[n.layer];
  });
  
  const sankeyData = sankey(graphData);
  
  sankeyData.nodes.forEach(n => {
    const targetX = layerX[n.layer];
    n.x0 = targetX;
    n.x1 = targetX + 35;
  });

  svg.append("g")
    .attr("fill", "none")
    .selectAll("path")
    .data(sankeyData.links)
    .join("path")
    .attr("d", d3.sankeyLinkHorizontal())
    .attr("stroke", "#aaa")
    .attr("stroke-width", d => Math.max(1, d.width))
    .attr("class", "link");

  const node = svg.append("g")
    .selectAll("g")
    .data(sankeyData.nodes)
    .join("g")
    .attr("class", d => clickableDepartments.includes(d.name) ? "node clickable" : "node");

  node.append("rect")
    .attr("x", d => d.x0)
    .attr("y", d => d.y0)
    .attr("height", d => d.y1 - d.y0)
    .attr("width", d => d.x1 - d.x0)
    .attr("rx", 4)
    .attr("ry", 4)
    .attr("fill", d => colorMap[d.name] || d3.schemeCategory10[d.index % 10])
    .style("filter", "drop-shadow(0 2px 4px rgba(0, 0, 0, 0.15))");

  node.append("rect")
    .attr("class", "node-hitarea")
    .attr("x", d => d.x0 - 10)
    .attr("y", d => d.y0 - 5)
    .attr("height", d => (d.y1 - d.y0) + 10)
    .attr("width", d => (d.x1 - d.x0) + 20);

  node.append("text")
    .attr("x", d => d.x0 < width / 2 ? d.x1 + 6 : d.x0 - 6)
    .attr("y", d => (d.y1 + d.y0) / 2)
    .attr("dy", "0.35em")
    .attr("text-anchor", d => d.x0 < width / 2 ? "start" : "end")
    .text(d => d.name);

  node.on("mousemove", (event, d) => {
    const currentVal = d3.sum(currentData.filter(row => row.Source === d.name || row.Target === d.name),
                             r => +r["Value(kKLOE)"]);
    const prevVal = d3.sum(prevData.filter(row => row.Source === d.name || row.Target === d.name),
                           r => +r["Value(kKLOE)"]);
    const change = prevVal ? (((currentVal - prevVal) / prevVal) * 100).toFixed(1) : "N/A";
    
    let tooltipText = `<strong>${d.name}</strong><br/>
        ${year} ç¸½é‡ï¼š${currentVal.toLocaleString()} kKLOE<br/>
        èˆ‡å‰ä¸€å¹´è®ŠåŒ–ï¼š${change === "N/A" ? "ç„¡è³‡æ–™" : (change > 0 ? `å¢åŠ  ${change}%` : `ä¸‹é™ ${Math.abs(change)}%`)}`;
    
    if (clickableDepartments.includes(d.name)) {
      tooltipText += `<br/><em style="color: #ff6b35;">é»æ“ŠæŸ¥çœ‹è©³ç´°è³‡æ–™</em>`;
    }
    
    tooltip
      .style("display", "block")
      .style("left", (event.pageX + 15) + "px")
      .style("top", (event.pageY + 15) + "px")
      .html(tooltipText);
  })
  .on("mouseout", () => tooltip.style("display", "none"))
  .on("click", (event, d) => {
    if (clickableDepartments.includes(d.name)) {
      event.stopPropagation();
      showDepartmentModal(d.name, year);
    }
  })
  .style("cursor", d => clickableDepartments.includes(d.name) ? "pointer" : "default");
}

d3.select("#yearSlider").on("input", function() {
  const year = +this.value;
  updateChart(year);
  updateEventsDisplay(year);
});

// è¶¨å‹¢åœ–æ›´æ–°
function updateTrendChart() {
  const data1Type = d3.select("#data1").property("value");
  const data2Type = d3.select("#data2").property("value");
  
  // æ›´æ–°åœ–ä¾‹
  d3.select("#legend1").text(data1Type);
  d3.select("#legend2").text(data2Type);
  
  // æ›´æ–°åœ–ä¾‹é¡è‰²
  const color1 = colorMap[data1Type] || "#2e8b57";
  const color2 = colorMap[data2Type] || "#013982";
  d3.selectAll(".legend-color").nodes()[0].style.background = color1;
  d3.selectAll(".legend-color").nodes()[1].style.background = color2;
  
  const trendChart = d3.select("#trend-chart");
  trendChart.html("");
  
  if (historicalData.length === 0) return;
  
  const containerWidth = trendChart.node().offsetWidth;
  const containerHeight = 400;
  const margin = { top: 20, right: 80, bottom: 50, left: 80 };
  const chartWidth = containerWidth - margin.left - margin.right;
  const chartHeight = containerHeight - margin.top - margin.bottom;
  
  const trendSvg = trendChart.append("svg")
    .attr("width", containerWidth)
    .attr("height", containerHeight);
  
  const g = trendSvg.append("g")
    .attr("transform", `translate(${margin.left},${margin.top})`);
  
  // Xè»¸æ¯”ä¾‹å°º
  const xScale = d3.scaleLinear()
    .domain([1984, 2024])
    .range([0, chartWidth]);
  
  // Yè»¸æ¯”ä¾‹å°º - æ•¸æ“š1
  const data1Values = historicalData.map(d => d[data1Type] || 0);
  const y1Scale = d3.scaleLinear()
    .domain([0, d3.max(data1Values) * 1.1 || 100])
    .range([chartHeight, 0]);
  
  // Yè»¸æ¯”ä¾‹å°º - æ•¸æ“š2
  const data2Values = historicalData.map(d => d[data2Type] || 0);
  const y2Scale = d3.scaleLinear()
    .domain([0, d3.max(data2Values) * 1.1 || 100])
    .range([chartHeight, 0]);
  
  // ç¹ªè£½ç¶²æ ¼ç·š
  g.append("g")
    .attr("class", "grid")
    .attr("opacity", 0.1)
    .call(d3.axisLeft(y1Scale)
      .tickSize(-chartWidth)
      .tickFormat(""));
  
  // Xè»¸
  g.append("g")
    .attr("transform", `translate(0,${chartHeight})`)
    .call(d3.axisBottom(xScale).tickFormat(d3.format("d")).ticks(10))
    .selectAll("text")
    .style("font-size", "12px");
  
  // å·¦å´Yè»¸ - æ•¸æ“š1
  g.append("g")
    .call(d3.axisLeft(y1Scale).ticks(8))
    .selectAll("text")
    .style("font-size", "12px")
    .style("fill", color1);
  
  // å³å´Yè»¸ - æ•¸æ“š2
  g.append("g")
    .attr("transform", `translate(${chartWidth},0)`)
    .call(d3.axisRight(y2Scale).ticks(8))
    .selectAll("text")
    .style("font-size", "12px")
    .style("fill", color2);
  
  // å·¦å´Yè»¸æ¨™ç±¤
  g.append("text")
    .attr("transform", "rotate(-90)")
    .attr("y", -60)
    .attr("x", -chartHeight / 2)
    .attr("text-anchor", "middle")
    .attr("class", "axis-label")
    .style("fill", color1)
    .style("font-weight", "bold")
    .text(data1Type);
  
  // å³å´Yè»¸æ¨™ç±¤
  g.append("text")
    .attr("transform", "rotate(-90)")
    .attr("y", chartWidth + 60)
    .attr("x", -chartHeight / 2)
    .attr("text-anchor", "middle")
    .attr("class", "axis-label")
    .style("fill", color2)
    .style("font-weight", "bold")
    .text(data2Type);
  
  // ç·šæ¢ç”Ÿæˆå™¨ - æ•¸æ“š1
  const line1 = d3.line()
    .x(d => xScale(d.year))
    .y(d => y1Scale(d[data1Type] || 0))
    .curve(d3.curveMonotoneX);
  
  // ç·šæ¢ç”Ÿæˆå™¨ - æ•¸æ“š2
  const line2 = d3.line()
    .x(d => xScale(d.year))
    .y(d => y2Scale(d[data2Type] || 0))
    .curve(d3.curveMonotoneX);
  
  // ç¹ªè£½æ•¸æ“š1ç·šæ¢
  g.append("path")
    .datum(historicalData)
    .attr("class", "trend-line")
    .attr("d", line1)
    .attr("stroke", color1);
  
  // ç¹ªè£½æ•¸æ“š2ç·šæ¢
  g.append("path")
    .datum(historicalData)
    .attr("class", "trend-line")
    .attr("d", line2)
    .attr("stroke", color2);
  
  // æ•¸æ“š1åœ“é»
  g.selectAll(".dot1")
    .data(historicalData)
    .join("circle")
    .attr("class", "trend-dot")
    .attr("cx", d => xScale(d.year))
    .attr("cy", d => y1Scale(d[data1Type] || 0))
    .attr("r", 4)
    .attr("stroke", color1)
    .on("mousemove", (event, d) => {
      tooltip
        .style("display", "block")
        .style("left", (event.pageX + 15) + "px")
        .style("top", (event.pageY + 15) + "px")
        .html(`<strong>${d.year}å¹´</strong><br/>${data1Type}ï¼š${(d[data1Type] || 0).toLocaleString()} ktoe`);
    })
    .on("mouseout", () => tooltip.style("display", "none"));
  
  // æ•¸æ“š2åœ“é»
  g.selectAll(".dot2")
    .data(historicalData)
    .join("circle")
    .attr("class", "trend-dot")
    .attr("cx", d => xScale(d.year))
    .attr("cy", d => y2Scale(d[data2Type] || 0))
    .attr("r", 4)
    .attr("stroke", color2)
    .on("mousemove", (event, d) => {
      tooltip
        .style("display", "block")
        .style("left", (event.pageX + 15) + "px")
        .style("top", (event.pageY + 15) + "px")
        .html(`<strong>${d.year}å¹´</strong><br/>${data2Type}ï¼š${(d[data2Type] || 0).toLocaleString()} ktoe`);
    })
    .on("mouseout", () => tooltip.style("display", "none"));
}

// ç›£è½ä¸‹æ‹‰é¸å–®è®ŠåŒ– - ç«‹å³åˆ·æ–°
d3.select("#data1").on("change", updateTrendChart);
d3.select("#data2").on("change", updateTrendChart);

loadAllCSV(); / 2)
    .attr("text-anchor", "middle")
    .attr("class", "axis-label")
    .style("fill", "#7099cf")
    .style("font-weight", "bold")
    .text(dataLabels[data2Type]);
  
  // ç·šæ¢ç”Ÿæˆå™¨ - æ•¸æ“š1
  const line1 = d3.line()
    .x(d => xScale(d.year))
    .y(d => y1Scale(d[data1Type]))
    .curve(d3.curveMonotoneX);
  
  // ç·šæ¢ç”Ÿæˆå™¨ - æ•¸æ“š2
  const line2 = d3.line()
    .x(d => xScale(d.year))
    .y(d => y2Scale(d[data2Type]))
    .curve(d3.curveMonotoneX);
  
  // ç¹ªè£½æ•¸æ“š1ç·šæ¢
  g.append("path")
    .datum(historicalData)
    .attr("class", "trend-line")
    .attr("d", line1)
    .attr("stroke", "#2e8b57");
  
  // ç¹ªè£½æ•¸æ“š2ç·šæ¢
  g.append("path")
    .datum(historicalData)
    .attr("class", "trend-line")
    .attr("d", line2)
    .attr("stroke", "#7099cf");
  
  // æ•¸æ“š1åœ“é»
  g.selectAll(".dot1")
    .data(historicalData)
    .join("circle")
    .attr("class", "trend-dot")
    .attr("cx", d => xScale(d.year))
    .attr("cy", d => y1Scale(d[data1Type]))
    .attr("r", 4)
    .attr("stroke", "#2e8b57")
    .on("mousemove", (event, d) => {
      tooltip
        .style("display", "block")
        .style("left", (event.pageX + 15) + "px")
        .style("top", (event.pageY + 15) + "px")
        .html(`<strong>${d.year}å¹´</strong><br/>${dataLabels[data1Type]}ï¼š${d[data1Type].toLocaleString()}${data1Type.includes("Percent") ? "%" : " ktoe"}`);
    })
    .on("mouseout", () => tooltip.style("display", "none"));
  
  // æ•¸æ“š2åœ“é»
  g.selectAll(".dot2")
    .data(historicalData)
    .join("circle")
    .attr("class", "trend-dot")
    .attr("cx", d => xScale(d.year))
    .attr("cy", d => y2Scale(d[data2Type]))
    .attr("r", 4)
    .attr("stroke", "#7099cf")
    .on("mousemove", (event, d) => {
      tooltip
        .style("display", "block")
        .style("left", (event.pageX + 15) + "px")
        .style("top", (event.pageY + 15) + "px")
        .html(`<strong>${d.year}å¹´</strong><br/>${dataLabels[data2Type]}ï¼š${d[data2Type].toLocaleString()}${data2Type.includes("Percent") ? "%" : " ktoe"}`);
    })
    .on("mouseout", () => tooltip.style("display", "none"));
}

// ç›£è½ä¸‹æ‹‰é¸å–®è®ŠåŒ–
d3.select("#data1").on("change", updateTrendChart);
d3.select("#data2").on("change", updateTrendChart);

loadAllCSV();
</script>

</body>
</html>
