import pandas as pd
from pyecharts import options as opts
from pyecharts.charts import Sankey, Tab
import glob
import re
from pathlib import Path

# ------------------- 過濾部門層級 -------------------
def filter_to_department_level(data):
    department_level = {
        '工業部門', '運輸部門', '農業部門', '服務業部門',
        '住宅部門', '轉換效率損失', '商業部門'
    }

    filtered_data = []
    for _, row in data.iterrows():
        source, target = row['Source'], row['Target']
        if source in department_level and target not in department_level:
            continue
        filtered_data.append(row)
    return pd.DataFrame(filtered_data)

# ------------------- 讀取 CSV -------------------
def read_csv(file_path):
    encodings = ['utf-8-sig', 'utf-8', 'big5', 'cp950', 'gbk']
    for enc in encodings:
        try:
            return pd.read_csv(file_path, encoding=enc)
        except:
            continue
    print(f"❌ 無法讀取 {file_path}")
    return None

# ------------------- 準備桑基圖資料 -------------------
def prepare_sankey_data(data):
    nodes = [{"name": n} for n in sorted(set(data['Source']).union(set(data['Target'])))]
    links = []
    for _, row in data.iterrows():
        value = float(row['Value(KLOE)']/1000)
        links.append({"source": row['Source'], "target": row['Target'], "value": value})
    return nodes, links

# ------------------- 生成單年桑基圖 -------------------
def create_sankey_chart(nodes, links, year):
    return (
        Sankey(init_opts=opts.InitOpts(width="1200px", height="700px", theme='westeros'))
        .add(
            series_name=f"{year}年能源流向",
            nodes=nodes,
            links=links,
            linestyle_opt=opts.LineStyleOpts(opacity=0.3, curve=0.5, color="source"),
            label_opts=opts.LabelOpts(position="right", font_size=12),
            node_gap=20
        )
        .set_global_opts(
            title_opts=opts.TitleOpts(
                title=f"台灣能源流向圖 ({year}年)",
                subtitle="資料來源：能源統計資料 | 單位：千公噸油當量",
                pos_top="10px",
                pos_left="center",
                title_textstyle_opts=opts.TextStyleOpts(font_size=18),
                subtitle_textstyle_opts=opts.TextStyleOpts(font_size=12)
            ),
            legend_opts=opts.LegendOpts(orient="horizontal", pos_top="bottom", pos_left="center")
        )
    )

# ------------------- 主程式 -------------------
def main():
    tab = Tab()
    csv_files = glob.glob("template*.csv")
    csv_files.sort()

    for file_path in csv_files:
        match = re.search(r'template(\d+)', file_path)
        if not match:
            continue
        year_raw = match.group(1)
        year = str(int(year_raw)+1911) if len(year_raw)<=3 else year_raw  # 民國轉西元

        data = read_csv(file_path)
        if data is None or 'Source' not in data.columns or 'Target' not in data.columns or 'Value(KLOE)' not in data.columns:
            continue

        # 過濾部門層級
        data = filter_to_department_level(data)

        nodes, links = prepare_sankey_data(data)
        sankey_chart = create_sankey_chart(nodes, links, year)

        tab.add(sankey_chart, f"{year}年")

    if len(tab.options) == 0:
        print("❌ 沒有有效的資料可生成圖表")
        return

    output_file = "taiwan_energy_sankey_multi_year.html"
    tab.render(output_file)
    print(f"🎉 成功生成多年份互動桑基圖 HTML：{output_file}")

if __name__ == "__main__":
    main()
