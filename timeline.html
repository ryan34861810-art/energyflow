<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>èƒ½æºæµè¦–è¦ºåŒ–</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-sankey/0.12.3/d3-sankey.min.js"></script>
  <style>
    body {
      font-family: "Noto Sans TC", "Microsoft JhengHei", sans-serif;
      margin: 0;
      background-color: #f5f5f5;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    
    #timeline-sidebar {
      width: 350px;
      background: #fff;
      box-shadow: 2px 0 6px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      z-index: 10;
    }
    
    #timeline-header {
      padding: 20px;
      background: linear-gradient(135deg, #668ab9 0%, #7099cf 100%);
      color: white;
      flex-shrink: 0;
      height: 90px;
      box-sizing: border-box;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    #timeline-header h2 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      line-height: 1.2;
      position: absolute;
      left: 20px;
      top: 20px;
    }
    
    #yearDisplay {
      font-size: 26px;
      font-weight: bold;
      text-align: center;
      line-height: 1.2;
      margin: 0;
    }
    
    #timeline-content {
      flex: 1;
      display: flex;
      overflow: hidden;
      position: relative;
      padding: 30px 0;
    }
    
    #slider-column {
      width: 20px;
      position: relative;
      display: flex;
      justify-content: center;
      align-items: stretch;
      padding: 0;
      flex-shrink: 0;
      margin: 0 0 0 15px;
    }
    
    #yearSlider {
      width: 100%;
      height: 100%;
      background: transparent;
      outline: none;
      writing-mode: vertical-lr;
      direction: ltr;
      -webkit-appearance: slider-vertical;
      margin: 0;
      padding: 0;
        accent-color: #668ab9;  /* åŠ é€™è¡Œ */


    }
    
    #yearSlider::-webkit-slider-runnable-track {
      width: 4px;
      background: #ddd;
      border-radius: 2px;
      cursor: pointer;
      
    }
    
    #yearSlider::-moz-range-track {
      width: 4px;
      background: #ddd;
      border-radius: 2px;
      cursor: pointer;
    }
    
    #yearSlider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 8px;
      height: 8px;
      background: #6C92C6;
      border-radius: 40%;
      cursor: grab;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      margin-left: -5.5px;  /* â† é€™è£¡!èª¿æ•´æŒ‰éˆ•æ°´å¹³ä½ç½® */


    }
    
    #yearSlider:active::-webkit-slider-thumb {
      cursor: grabbing;
      background: #6D95C9;
    }
    
    #yearSlider::-moz-range-thumb {
      width: 12px;
      height: 12px;
      background: #8bb2e5;
      border-radius: 50%;
      cursor: grab;
      border: none;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      margin-left: -5.5px;  /* â† é€™è£¡!èª¿æ•´æŒ‰éˆ•æ°´å¹³ä½ç½® */

    }
    
    #yearSlider:active::-moz-range-thumb {
      cursor: grabbing;
      background: #6d95c9;
    }
    
    #events-column {
      flex: 1;
      padding: 0 10px 0 25px;
      overflow: visible;
      position: relative;
      display: flex;
      flex-direction: column;
    }
    
    .event-item {
      position: absolute;
      left: 0;
      display: flex;
      flex-direction: row;
      align-items: flex-start;
      gap: 10px;
      z-index: 2;
      opacity: 0;
      animation: eventFadeIn 0.3s ease forwards;
    }
    
    @keyframes eventFadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }
    
    .event-bar {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      box-shadow: 0 2px 4px rgba(102, 138, 185, 0.3);
      position: relative;
      flex-shrink: 0;
    }
    
    .event-bar.multi-year {
      width: 6px;
      border-radius: 3px;
    }
    
    .event-bar::before,
    .event-bar::after {
      display: none;
    }
    
    .event-content {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 2px;
      text-align: left;
      align-self: flex-start;  /* åŠ é€™è¡Œ */

    }
    
    .event-year-row {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 0;
    }
    
    .event-year-number {
      font-size: 10px;
      font-weight: bold;
      color: #333;
      writing-mode: vertical-rl;
      line-height: 1.2;
    }
    
    .event-year-number.hidden {
      visibility: hidden;
    }
    
    .event-name {
      font-size: 11px;
      font-weight: 600;
      color: #333;
      background: rgba(255, 255, 255, 0.95);
      padding: 4px 8px;
      border-radius: 3px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
      border: 1px solid #ddd;
      white-space: nowrap;
      writing-mode: vertical-rl;
      text-orientation: upright;
      margin-left: 15px;
      margin-top: -60px;

    }
    
    .event-years {
      display: none;
    }
    
    #main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      overflow-x: hidden;
      position: relative;
    }
    #events-hint {
  position: absolute;
  top: -30px;
  left: 0;
  right: 0;
  text-align: center;
  font-size: 11px;
  color: #666;
  font-weight: 500;
  opacity: 0.8;
  padding: 5px;
  background: rgba(255, 255, 255, 0.9);
  border-radius: 3px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    #data-source {
      position: absolute;
      top: 100px;
      right: 20px;
      font-size: 11px;
      color: #666;
      z-index: 5;
      background: rgba(255, 255, 255, 0.9);
      padding: 5px 10px;
      border-radius: 3px;
    }
    
    #stats-container {
      padding: 15px 20px;
      background: linear-gradient(135deg, #668ab9 0%, #7099cf 100%);
      color: white;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      flex-shrink: 0;
      box-sizing: border-box;
    }
    
    #stats-grid {
      display: flex;
      justify-content: space-around;
      align-items: flex-start;
      gap: 20px;
      height: 60px;
    }
    
    .stat-item {
      text-align: center;
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      position: relative;
      padding-top: 0;
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      margin: 3px 0;
      line-height: 1.2;
    }
    
    .stat-label {
      font-size: 11px;
      opacity: 0.9;
      line-height: 1.2;
      display: flex;
      align-items: center;
      gap: 5px;
      justify-content: center;
      height: 16px;
    }
    
    .info-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 14px;
      height: 14px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      font-size: 10px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      color: white;
    }
    
    .info-icon:hover {
      background: rgba(255, 255, 255, 0.5);
      transform: scale(1.1);
    }
    
    #chart {
      flex: 1;
      min-height: 500px;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      background: white;
    }
    
    #trend-container {
      padding: 20px 30px;
      background: white;
      box-shadow: 0 -2px 6px rgba(0,0,0,0.1);
      min-height: 400px;
    }
    
    #trend-controls {
      display: flex;
      gap: 20px;
      align-items: center;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    
    .trend-selector {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .trend-selector label {
      font-weight: 600;
      color: #333;
      min-width: 70px;
      font-size: 13px;
    }
    
    .trend-selector select {
      padding: 6px 10px;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 13px;
      background: white;
      cursor: pointer;
      min-width: 180px;
      transition: border-color 0.3s;
    }
    
    .trend-selector select:hover {
      border-color: #7099cf;
    }
    
    .trend-selector select:focus {
      outline: none;
      border-color: #668ab9;
    }
    
    #trend-chart {
      width: 100%;
      height: 280px;
      position: relative;
      opacity: 0;
      transition: opacity 0.5s ease;
    }
    
    #trend-chart.visible {
      opacity: 1;
    }
    
    .trend-line {
      fill: none;
      stroke-width: 3;
      transition: stroke-width 0.3s;
    }
    
    .trend-line.animated {
      animation: drawLine 1.5s ease-out forwards;
    }
    
    @keyframes drawLine {
      to {
        stroke-dashoffset: 0;
      }
    }
    
    .trend-line:hover {
      stroke-width: 5;
    }
    
    .trend-dot {
      cursor: pointer;
      opacity: 0;
      animation: fadeInDot 0.5s ease forwards;
    }
    
    @keyframes fadeInDot {
      from {
        opacity: 0;
        transform: scale(0);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    
    .trend-dot:hover {
      r: 6;
    }
    
    .trend-legend {
      display: flex;
      gap: 25px;
      justify-content: center;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: #333;
    }
    
    .legend-color {
      width: 25px;
      height: 4px;
      border-radius: 2px;
    }
    
    .node rect {
      stroke: #333;
      stroke-width: 2px;
      rx: 4;
      ry: 4;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.15));
    }
    
    .node text {
      font-size: 14px;
      pointer-events: all;
    }
    
    .node.clickable text {
      font-weight: bold;
      fill: #ff6b35;
    }
    
    .node {
      pointer-events: all;
    }
    
    .node-hitarea {
      fill: transparent;
      stroke-opacity: 0;
    }
    
    .link {
      fill: none;
      stroke-opacity: 0.4;
    }
    
    .link:hover {
      stroke-opacity: 0.7;
    }
    
    #tooltip {
      position: absolute;
      background: white;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 5px;
      display: none;
      pointer-events: none;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      z-index: 1001;
    }
    
    #modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    #info-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }
    
    #info-modal-content {
      background: white;
      border-radius: 10px;
      padding: 25px;
      max-width: 800px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      position: relative;
      animation: modalFadeIn 0.3s ease;
    }
    
    #info-modal-close {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 28px;
      height: 28px;
      background: #333;
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.3s;
    }
    
    #info-modal-close:hover {
      background: #000;
    }
    
    #info-modal-text {
      font-size: 16px;
      color: #333;
      line-height: 1.6;
    }
    
    #modal-content {
      background: white;
      border-radius: 15px;
      padding: 30px;
      width: 85%;
      max-width: 1400px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      position: relative;
      animation: modalFadeIn 0.3s ease;
    }
    
    @keyframes modalFadeIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    
    #modal-close {
      position: absolute;
      top: 15px;
      right: 15px;
      width: 35px;
      height: 35px;
      background: #333;
      color: white;
      border: none;
      border-radius: 50%;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.3s;
      z-index: 10;
    }
    
    #modal-close:hover {
      background: #000;
    }
    
    #modal-title {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 20px;
      color: #333;
      padding-right: 50px;
    }
    
    #modal-sankey {
      width: 100%;
      height: 600px;
      margin-top: 20px;
    }
    
    .modal-link {
      cursor: pointer;
    }
    
    .modal-link:hover {
      fill-opacity: 0.7 !important;
    }
    
    .modal-node rect {
      stroke: #333;
      stroke-width: 2px;
      rx: 4;
      ry: 4;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.15));
    }
    
    .modal-node text {
      font-size: 13px;
      pointer-events: none;
    }
  </style>
</head>
<body>

  <div id="timeline-sidebar">
    <div id="timeline-header">
      <h2>å¹´ä»½</h2>
      <div id="yearDisplay">1982</div>
    </div>
    <div id="timeline-content">
      <div id="slider-column">
        <input type="range" id="yearSlider" name="yearSlider" min="1982" max="2024" value="1982" step="1" />
      </div>
      <div id="events-column">
    <div id="events-hint">ğŸ’¡ é»æ“Šäº‹ä»¶æŸ¥çœ‹æ›´å¤šè³‡è¨Š</div>
</div>
    </div>
  </div>

  <div id="main-content">
    <div id="data-source">è³‡æ–™ä¾†æº:ç¶“æ¿Ÿéƒ¨èƒ½æºç½²èƒ½æºçµ±è¨ˆå¹´å ±(å¹³è¡¡è¡¨)</div>
    
    <div id="stats-container">
      <div id="stats-grid">
        <div class="stat-item">
          <div class="stat-label">ç¸½èƒ½æºä¾›çµ¦</div>
          <div class="stat-value" id="totalEnergy">-</div>
          <div class="stat-label">
            ktoe
            <span class="info-icon" data-info="ç¸½èƒ½æºä¾›çµ¦">?</span>
          </div>
        </div>
        <div class="stat-item">
          <div class="stat-label">ç…¤åŠç…¤ç”¢å“ä½”æ¯”</div>
          <div class="stat-value" id="coalPercent">-</div>
          <div class="stat-label">&nbsp;</div>
        </div>
        <div class="stat-item">
          <div class="stat-label">ğŸŒ±å†ç”Ÿèƒ½æºä½”æ¯”</div>
          <div class="stat-value" id="renewablePercent">-</div>
          <div class="stat-label">
            <span class="info-icon" data-info="å†ç”Ÿèƒ½æºä½”æ¯”">?</span>
          </div>
        </div>
      </div>
    </div>

    <div id="chart"></div>
    
    <div id="trend-container">
      <div id="trend-controls">
        <div class="trend-selector">
          <label for="data1-select">æ•¸æ“š 1ï¼š</label>
          <select id="data1-select">
            <option value="">è«‹é¸æ“‡...</option>
          </select>
        </div>
        <div class="trend-selector">
          <label for="data2-select">æ•¸æ“š 2ï¼š</label>
          <select id="data2-select">
            <option value="">è«‹é¸æ“‡...</option>
          </select>
        </div>
      </div>
      <div id="trend-chart"></div>
      <div class="trend-legend" id="trend-legend"></div>
    </div>
  </div>
  
  <div id="tooltip"></div>
  
  <div id="modal-overlay">
    <div id="modal-content">
      <button id="modal-close" type="button">Ã—</button>
      <div id="modal-title"></div>
      <div id="modal-sankey"></div>
    </div>
  </div>
  
  <div id="info-modal-overlay">
    <div id="info-modal-content">
      <button id="info-modal-close" type="button">Ã—</button>
      <div id="info-modal-text"></div>
    </div>
  </div>

<script>
const clickableDepartments = ["å·¥æ¥­éƒ¨é–€","é‹è¼¸éƒ¨é–€","è¾²æ¥­éƒ¨é–€","æœå‹™æ¥­éƒ¨é–€"];
const departments = ["å·¥æ¥­éƒ¨é–€","é‹è¼¸éƒ¨é–€","è¾²æ¥­éƒ¨é–€","æœå‹™æ¥­éƒ¨é–€","ä½å®…éƒ¨é–€","è½‰æ›æ•ˆç‡æå¤±"];
const energySources = ["ç…¤åŠç…¤ç”¢å“","åŸæ²¹åŠçŸ³æ²¹ç”¢å“","å¤©ç„¶æ°£","å†ç”Ÿèƒ½æº"];
const chart = d3.select("#chart");
const tooltip = d3.select("#tooltip");
const modalOverlay = d3.select("#modal-overlay");
const modalTitle = d3.select("#modal-title");
const modalSankey = d3.select("#modal-sankey");
const modalClose = d3.select("#modal-close");

const infoMessages = {
  "ç¸½èƒ½æºä¾›çµ¦": "KTOEï¼ˆKilo Tonne of Oil Equivalentï¼Œåƒå™¸æ²¹ç•¶é‡ï¼‰æ˜¯å°‡å„ç¨®èƒ½æºçµ±ä¸€æ›ç®—ç‚ºåŸæ²¹èƒ½é‡ç­‰å€¼çš„å–®ä½ã€‚1 KTOE ä»£è¡¨ç‡ƒç‡’ 1000 å™¸åŸæ²¹æ‰€é‡‹æ”¾çš„èƒ½é‡ï¼Œç´„ç­‰æ–¼ 41.868 å¤ªç„¦è€³ï¼ˆTJï¼‰æˆ–ç´„ 11.63 GWhã€‚æ­¤å–®ä½å¸¸ç”¨æ–¼æ¯”è¼ƒä¸åŒèƒ½æºç¨®é¡æˆ–è¨ˆç®—èƒ½æºå æ¯”ã€‚",
  "å†ç”Ÿèƒ½æºä½”æ¯”": "å†ç”Ÿèƒ½æºä½”æ¯”ï¼šæ­¤æ¯”ä¾‹è¨ˆç®—åŒ…æ‹¬æ°´åŠ›ã€åœ°ç†±ã€å¤ªé™½å…‰é›»ã€é¢¨åŠ›ä»¥åŠç”Ÿè³ªèƒ½èˆ‡å»¢æ£„ç‰©ç­‰äº”é …èƒ½æºåœ¨ç¸½èƒ½æºä¾›çµ¦ç«¯æ‰€ä½”æ¯”ä¾‹ã€‚æ­¤æ¯”ä¾‹åæ˜ å†ç”Ÿèƒ½æºåœ¨å…¨èƒ½æºé«”ç³»ä¸­çš„åœ°ä½ï¼Œé¡¯ç¤ºæˆ‘åœ‹èƒ½æºçµæ§‹ä»ä»¥åŒ–çŸ³ç‡ƒæ–™ç‚ºä¸»,å†ç”Ÿèƒ½æºé›–æŒçºŒæˆé•·ï¼Œä½†åœ¨æ•´é«”èƒ½æºä¾›çµ¦ä¸­å æ¯”ä»ç›¸å°æœ‰é™ã€‚"
};

  const genreMessages = {
  "æ ¸èƒ½": `
<h2 style="font-size: 28px; font-weight: bold; color: #2c3e50; margin-bottom: 20px; border-bottom: 3px solid #3498db; padding-bottom: 10px;">æ ¸èƒ½</h2>

<h3 style="font-size: 20px; font-weight: 600; color: #34495e; margin-top: 25px; margin-bottom: 12px;">1970å¹´ä»£ï¼šæ—©æœŸç™¼å±•</h3>
<ul style="line-height: 1.8; margin-left: 20px;">
  <li style="margin-bottom: 8px;">å› æ‡‰èƒ½æºéœ€æ±‚ï¼Œå°ç£é–‹å§‹ç™¼å±•æ ¸é›»ã€‚</li>
  <li style="margin-bottom: 8px;"><strong style="color: #e74c3c;">1971</strong>ï½œèˆˆå»ºç¬¬ä¸€åº§æ ¸é›»å» ï¼ˆæ ¸ä¸€å» ï¼‰ã€‚</li>
  <li style="margin-bottom: 8px;"><strong style="color: #e74c3c;">1973</strong>ï½œå—çŸ³æ²¹å±æ©Ÿå½±éŸ¿ï¼Œæ ¸é›»å» è¢«åˆ—ç‚ºã€Œåå¤§å»ºè¨­ã€é …ç›®,åŠ é€Ÿç™¼å±•ã€‚</li>
  <li style="margin-bottom: 8px;"><strong style="color: #e74c3c;">1978â€“1979</strong>ï½œæ ¸ä¸€æ©Ÿçµ„å•Ÿç”¨å•†è½‰</li>
</ul>

<h3 style="font-size: 20px; font-weight: 600; color: #34495e; margin-top: 25px; margin-bottom: 12px;">1980å¹´ä»£ï¼šç©©å®šç™¼é›»æœŸ</h3>
<ul style="line-height: 1.8; margin-left: 20px;">
  <li style="margin-bottom: 8px;"><strong style="color: #e74c3c;">1981â€“1983</strong>ï½œæ ¸äºŒæ©Ÿçµ„å•Ÿç”¨å•†è½‰</li>
  <li style="margin-bottom: 8px;"><strong style="color: #e74c3c;">1984â€“1985</strong>ï½œæ ¸ä¸‰æ©Ÿçµ„å•Ÿç”¨å•†è½‰</li>
</ul>

<h3 style="font-size: 20px; font-weight: 600; color: #34495e; margin-top: 25px; margin-bottom: 12px;">2011â€“2025å¹´ï¼šé€æ­¥é€€å‡ºæœŸ</h3>
<ul style="line-height: 1.8; margin-left: 20px;">
  <li style="margin-bottom: 8px;"><strong style="color: #e74c3c;">2011â€“2016</strong>ï½œç¦å³¶æ ¸ç½å¾Œæ ¸å››å°å­˜ï¼Œæ¨å‹•ã€Š2025éæ ¸å®¶åœ’æ³•ã€‹</li>
  <li style="margin-bottom: 8px;"><strong style="color: #e74c3c;">2018â€“2019</strong>ï½œç¬¬ä¸€æ ¸èƒ½é›»å» åœæ©Ÿé™¤å½¹</li>
  <li style="margin-bottom: 8px;"><strong style="color: #e74c3c;">2021</strong>ï½œç¬¬å››æ ¸èƒ½é›»å» é‡å•Ÿå…¬æŠ•ä¸é€šé</li>
  <li style="margin-bottom: 8px;"><strong style="color: #e74c3c;">2021â€“2023</strong>ï½œç¬¬äºŒæ ¸èƒ½é›»å» åœæ©Ÿé™¤å½¹</li>
  <li style="margin-bottom: 8px;"><strong style="color: #e74c3c;">2024â€“2025</strong>ï½œç¬¬ä¸‰æ ¸èƒ½é›»å» åœæ©Ÿé™¤å½¹ï¼Œæ­£å¼é€²å…¥0æ ¸é›»æ™‚ä»£</li>
</ul>
`,

  "ç«åŠ›": `
<h2 style="font-size: 28px; font-weight: bold; color: #2c3e50; margin-bottom: 20px; border-bottom: 3px solid #3498db; padding-bottom: 10px;">ç«åŠ›ç™¼é›»</h2>

<h3 style="font-size: 20px; font-weight: 600; color: #34495e; margin-top: 25px; margin-bottom: 12px;">1950â€“1970å¹´ä»£åˆï¼šå·¥æ¥­åŒ–èµ·æ­¥æœŸ</h3>
<ul style="line-height: 1.8; margin-left: 20px;">
  <li style="margin-bottom: 8px;"><strong style="color: #e74c3c;">1950å¹´ä»£</strong>ï½œåœ‹å…§ä¸»è¦ä¾è³´ç«åŠ›èˆ‡æ°´åŠ›ä¸¦è¡Œï¼Œç«åŠ›ä»¥ç‡ƒç…¤ç‚ºä¸»ã€‚</li>
  <li style="margin-bottom: 8px;"><strong style="color: #e74c3c;">1960å¹´ä»£</strong>ï½œå°ä¸­ã€å’Œå¹³ã€éº¥å¯®ç­‰åœ°é™¸çºŒè¦åŠƒå¤§å‹ç«åŠ›é›»å» åŸºåœ°ã€‚</li>
</ul>

<h3 style="font-size: 20px; font-weight: 600; color: #34495e; margin-top: 25px; margin-bottom: 12px;">1970å¹´ä»£æœ«â€“1990å¹´ä»£ï¼šçŸ³æ²¹å±æ©Ÿå¾Œçš„ç‡ƒç…¤å¾©èˆˆæœŸ</h3>
<ul style="line-height: 1.8; margin-left: 20px;">
  <li style="margin-bottom: 8px;"><strong style="color: #e74c3c;">1973ã€1979</strong>ï½œå…©æ¬¡çŸ³æ²¹å±æ©Ÿï¼Œä¿ƒä½¿æ”¿åºœæ¨å‹•ã€Œç‡ƒç…¤æ›¿ä»£çŸ³æ²¹ã€æ”¿ç­–ã€‚</li>
  <li style="margin-bottom: 8px;"><strong style="color: #e74c3c;">1989â€“1992</strong>ï½œå°ä¸­ç«åŠ›ç™¼é›»å» (ä¸­ç«)å®Œå·¥å•†è½‰ã€‚</li>
  <li style="margin-bottom: 8px;"><strong style="color: #e74c3c;">1990å¹´ä»£</strong>ï½œå’Œå¹³é›»å» ã€éº¥å¯®é›»å» ç­‰ç›¸ç¹¼èˆˆå»ºï¼Œç‡ƒç…¤ç™¼é›»æˆç‚ºä¸»åŠ›ã€‚</li>
</ul>

<h3 style="font-size: 20px; font-weight: 600; color: #34495e; margin-top: 25px; margin-bottom: 12px;">2000â€“2010å¹´ä»£ï¼šç’°ä¿å£“åŠ›èˆ‡ç©ºæ±™çˆ­è­°</h3>
<ul style="line-height: 1.8; margin-left: 20px;">
  <li style="margin-bottom: 8px;"><strong style="color: #e74c3c;">2000å¹´å¾Œ</strong>ï½œé–‹æ”¾æ°‘é–“ç¶“ç‡Ÿç™¼é›»æ¥­ï¼Œç‡ƒç…¤ç™¼é›»é‡é”æ­·å²é«˜å³°ã€‚</li>
  <li style="margin-bottom: 8px;"><strong style="color: #e74c3c;">2004â€“2006</strong>ï½œå°ä¸­ç«åŠ›ç™¼é›»å» å¢è¨­å…©éƒ¨æ±½åŠ›ç™¼é›»æ©Ÿçµ„ï¼Œæˆç‚ºä¸–ç•Œæœ€å¤§çš„ç«åŠ›ç™¼é›»å» </li>
  <li style="margin-bottom: 8px;"><strong style="color: #e74c3c;">2010å¹´å¾Œ</strong>ï½œä¸­ç«æ’æ”¾èˆ‡ç©ºæ±™çˆ­è­°å‡é«˜ï¼Œå¼•ç™¼ç¤¾æœƒé—œæ³¨ã€‚</li>
  <li style="margin-bottom: 8px;">æ”¿åºœæ¨å‹•ã€Œéæ ¸å®¶åœ’ã€ï¼Œç‡ƒç…¤ä»ç¶­æŒä¸»åŠ›ä¾›é›»åœ°ä½ã€‚</li>
</ul>

<h3 style="font-size: 20px; font-weight: 600; color: #34495e; margin-top: 25px; margin-bottom: 12px;">2020å¹´ä»£ï¼šæ·¨é›¶è½‰å‹èˆ‡ç‡ƒç…¤é€€å ´</h3>
<ul style="line-height: 1.8; margin-left: 20px;">
  <li style="margin-bottom: 8px;"><strong style="color: #e74c3c;">2021</strong>ï½œæ”¿åºœå®£å¸ƒã€Œ2050æ·¨é›¶æ’æ”¾ã€ã€‚</li>
  <li style="margin-bottom: 8px;"><strong style="color: #e74c3c;">2022èµ·</strong>ï½œå°ä¸­ã€èˆˆé”ç­‰ç«åŠ›é›»å» è¦åŠƒæ¸›ç…¤ã€è½‰ç‡ƒæ°£æˆ–é€€å½¹ã€‚</li>
</ul>
`,

  "æ°´åŠ›": `
<h2 style="font-size: 28px; font-weight: bold; color: #2c3e50; margin-bottom: 20px; border-bottom: 3px solid #3498db; padding-bottom: 10px;">æ°´åŠ›</h2>

<h3 style="font-size: 20px; font-weight: 600; color: #34495e; margin-top: 25px; margin-bottom: 12px;">1985â€“ç¾ä»Šï¼šå¤§å°å‹æ°´åŠ›ä¸¦é€²ï¼Œæ°´åŠ›ç™¼é›»æŒçºŒèª¿å³°ã€‚</h3>
<ul style="line-height: 1.8; margin-left: 20px;">
  <li style="margin-bottom: 8px;">å¤§å‹æ°´åŠ›ç™¼é›»</li>
  <p style="margin-bottom: 8px;">ç™¼å±•æ–¹å‘ï¼šæŒçºŒè©•ä¼°èˆ‡é–‹ç™¼ä¸­å¤§å‹æ°´åŠ›è¨ˆç•«ï¼Œåˆ©ç”¨ç¾æœ‰æ°´åº«é€²è¡ŒæŠ½è“„ç™¼é›»ã€‚</li>
  <li style="margin-bottom: 8px;">å°å‹æ°´åŠ›ç™¼é›»</li>
  <p style="margin-bottom: 8px;">ç™¼å±•æ–¹å‘ï¼šåˆ©ç”¨ç¾æœ‰æ°´åˆ©è¨­æ–½ï¼Œä»¥é™ä½ç’°å¢ƒè¡æ“Šï¼Œä¸¦é”æˆã€Œä¸€æ°´å¤šç”¨ã€çš„æ•ˆç›Šã€‚</li>
  <li style="margin-bottom: 8px;"><strong style="color: #e74c3c;">1985</strong>ï½œæ˜æ¹–æŠ½è“„å¼æ°´åŠ›ç™¼é›»å» å®Œå·¥å•†è½‰ã€‚</li>
  <li style="margin-bottom: 8px;"><strong style="color: #e74c3c;">1994â€“1995</strong>ï½œæ˜æ½­æŠ½è“„å¼æ°´åŠ›é›»å» å®Œå·¥å•†è½‰ï¼Œç‚ºè‡ºç£è£ç½®å®¹é‡æœ€å¤§çš„æ°´åŠ›èª¿å³°é›»æºã€‚</li>
</ul>
`,

  "å¤ªé™½èƒ½": `
<h2 style="font-size: 28px; font-weight: bold; color: #2c3e50; margin-bottom: 20px; border-bottom: 3px solid #3498db; padding-bottom: 10px;">å¤ªé™½èƒ½</h2>

<h3 style="font-size: 20px; font-weight: 600; color: #34495e; margin-top: 25px; margin-bottom: 12px;">2000â€“2009å¹´ï¼šæ—©æœŸæ¨å»£èˆ‡ç¤ºç¯„ã€‚</h3>
<ul style="line-height: 1.8; margin-left: 20px;">
  <li style="margin-bottom: 8px;"><strong style="color: #e74c3c;">2000å¹´</strong>ï½œè¡Œæ”¿é™¢æ¨è¡Œã€Œé™½å…‰å±‹é ‚ã€åè¬æˆ¶è¨­ç½®å¤ªé™½èƒ½è¨­å‚™</li>
</ul>

<h3 style="font-size: 20px; font-weight: 600; color: #34495e; margin-top: 25px; margin-bottom: 12px;">2009â€“2012ï¼šå¤ªé™½èƒ½è£ç½®é‡çˆ†ç™¼å¼æˆé•·ã€‚</h3>
<ul style="line-height: 1.8; margin-left: 20px;">
  <li style="margin-bottom: 8px;"><strong style="color: #e74c3c;">2009å¹´</strong>ï½œå†ç”Ÿèƒ½æºç™¼å±•æ¢ä¾‹é€šéï¼Œå¯¦æ–½FITèº‰è³¼åˆ¶åº¦</li>
</ul>

<h3 style="font-size: 20px; font-weight: 600; color: #34495e; margin-top: 25px; margin-bottom: 12px;">2012â€“ç¾ä»Šï¼šæ¨å‹•å¤ªé™½å…‰é›»æ™®åŠåŒ–ï¼Œå¤ªé™½èƒ½è£ç½®å®¹é‡å¿«é€Ÿæˆé•·ã€‚</h3>
<ul style="line-height: 1.8; margin-left: 20px;">
  <li style="margin-bottom: 8px;"><strong style="color: #e74c3c;">2012</strong>ï½œå•Ÿå‹•é™½å…‰å±‹é ‚ç™¾è¬åº§è¨ˆç•«ï¼Œè¨­å®š2020å¹´é”æˆ1020MWå…‰é›»è¨­ç½®é‡ï¼Œä»¥åŠ é€Ÿå¤ªé™½èƒ½ç™¼å±•ã€‚</li>
  <li style="margin-bottom: 8px;"><strong style="color: #e74c3c;">2014â€“2018</strong>ï½œå±‹é ‚èˆ‡åœ°é¢å¤§å‹å ´åŸŸå¿«é€Ÿæ“´å¼µï¼ˆé¾äº•ã€é‡‘æ¹–ç­‰ç¤ºç¯„èˆ‡å¤§é‡å®‰è£ï¼‰</li>
</ul>
`,

  "é¢¨åŠ›": `
<h2 style="font-size: 28px; font-weight: bold; color: #2c3e50; margin-bottom: 20px; border-bottom: 3px solid #3498db; padding-bottom: 10px;">é¢¨åŠ›</h2>

<h3 style="font-size: 20px; font-weight: 600; color: #34495e; margin-top: 25px; margin-bottom: 12px;">2000â€“2005å¹´ï¼šé™¸ä¸Šé¢¨å ´ç¤ºç¯„å•Ÿå‹•èˆ‡æŠ€è¡“æ“´å¢æœŸ</h3>
<ul style="line-height: 1.8; margin-left: 20px;">
  <li style="margin-bottom: 8px;"><strong style="color: #e74c3c;">2007å¹´</strong>ï½œå½°åŒ–å½°æ¿±å·¥æ¥­å€é¢¨åŠ›ç™¼é›»å ´ï¼ˆå¤šåº§å¤§å‹é¢¨æ©Ÿï¼‰ï¼Œè‡ºç£é¦–åº§å¤§å‹å•†ç”¨é™¸åŸŸé¢¨å ´å•Ÿå‹•å•†è½‰ã€‚</li>
  <li style="margin-bottom: 8px;"><strong style="color: #e74c3c;">2012å¹´</strong>ï½œå…¬å¸ƒã€Œé¢¨åŠ›ç™¼é›»é›¢å²¸ç³»çµ±ç¤ºç¯„çå‹µè¾¦æ³•ã€å•Ÿå‹•é›¢å²¸é¢¨é›»é–‹ç™¼ã€‚</li>
</ul>

<h3 style="font-size: 20px; font-weight: 600; color: #34495e; margin-top: 25px; margin-bottom: 12px;">2016â€“ç¾ä»Šï¼šé›¢å²¸é¢¨é›»å¿«é€Ÿæ“´å±•æœŸ</h3>
<ul style="line-height: 1.8; margin-left: 20px;">
  <li style="margin-bottom: 8px;"><strong style="color: #e74c3c;">2005â€“2009</strong>ï½œå½°æ¿±å·¥æ¥­å€é¢¨åŠ›ç™¼é›»å ´è¨­ç½®å®Œæˆ</li>
  <li style="margin-bottom: 8px;"><strong style="color: #e74c3c;">2017</strong>ï½œæµ·æ´‹ç«¹å—é¢¨åŠ›ç™¼é›»å ´ç¬¬ä¸€æœŸå•†è½‰</li>
    <li style="margin-bottom: 8px;"><strong style="color: #e74c3c;">2017â€“2019</strong>ï½œå…¨è‡ºé¦–åº§å•†æ¥­è¦æ¨¡é›¢å²¸é¢¨é›»å ´ã€ŒFormosa 1ã€å®Œå·¥å•Ÿå‹•å•†è½‰ï¼Œå±•ç¾é›¢å²¸é¢¨é›»ç”¢æ¥­åŒ–æˆæœã€‚</li>
  <li style="margin-bottom: 8px;"><strong style="color: #e74c3c;">2023</strong>ï½œæµ·èƒ½é›¢å²¸é¢¨åŠ›ç™¼é›»å ´æ­£å¼å•†è½‰ï¼Œæˆç‚ºå°ç£è£ç½®å®¹é‡æœ€å¤§é›¢å²¸é¢¨é›»</li>
</ul>
`,

  "åœ°ç†±": `
<h2 style="font-size: 28px; font-weight: bold; color: #2c3e50; margin-bottom: 20px; border-bottom: 3px solid #3498db; padding-bottom: 10px;">åœ°ç†±</h2>

<h3 style="font-size: 20px; font-weight: 600; color: #34495e; margin-top: 25px; margin-bottom: 12px;">1966â€“1993å¹´ï¼šåˆæœŸæ¢å‹˜èˆ‡æ—©æœŸé–‹ç™¼</h3>
<ul style="line-height: 1.8; margin-left: 20px;">
  <li style="margin-bottom: 8px;"><strong style="color: #e74c3c;">1973å¹´</strong>ï½œ1973å¹´ç™¼ç”Ÿå…¨çƒçŸ³æ²¹å±æ©Ÿï¼Œé–‹å§‹å¯¦æ–½è©³ç´°èª¿æŸ¥æ¢å‹˜</li>
  <li style="margin-bottom: 8px;"><strong style="color: #e74c3c;">1977å¹´</strong>ï½œå»ºé€ ç¬¬ä¸€åº§1,500 kWeå…ˆé©…å‹åœ°ç†±è©¦é©—é›»å» ï¼Œä¾›å„é …è©¦é©—ç ”ç©¶èˆ‡ç¤ºç¯„ã€‚</li>
  <li style="margin-bottom: 8px;"><strong style="color: #e74c3c;">1993å¹´</strong>ï½œæ¸…æ°´åœ°ç†±ç™¼é›»å» åœæ­¢ç™¼é›»è©¦é©—ã€‚</li>
</ul>

<h3 style="font-size: 20px; font-weight: 600; color: #34495e; margin-top: 25px; margin-bottom: 12px;">1994â€“2005å¹´ï¼šé–‹ç™¼åœæ»¯æœŸ</h3>
<ul style="line-height: 1.8; margin-left: 20px;">
  <li style="margin-bottom: 8px;">éš¨è‘—æ¸…æ°´åœ°ç†±é›»å» ç™¼é›»é‡ä¸‹æ»‘è€Œåœæ­¢ç‡Ÿé‹ï¼Œå°ç£åœ°ç†±ç™¼å±•é€²å…¥é•·æ™‚é–“çš„åœæ»¯æœŸã€‚</li>
</ul>

<h3 style="font-size: 20px; font-weight: 600; color: #34495e; margin-top: 25px; margin-bottom: 12px;">2006â€“2019å¹´ï¼šé–‹ç™¼å†ç”ŸæœŸ</h3>
<ul style="line-height: 1.8; margin-left: 20px;">
  <li style="margin-bottom: 8px;"><strong style="color: #e74c3c;">2006</strong>ï½œå·¥ç ”é™¢åœ¨æ¸…æ°´åœ°ç†±å€é€²è¡Œåœ°ç†±è³‡æºé–‹ç™¼å†ç”Ÿè¨ˆç•«ã€‚</li>
  <li style="margin-bottom: 8px;"><strong style="color: #e74c3c;">2021</strong>ï½œæ¸…æ°´åœ°ç†±ç™¼é›»å» å•Ÿç”¨ï¼Œæ˜¯å…¨å°é¦–å€‹æ°‘é–“ç‡Ÿé‹MWï¼ˆç™¾è¬ç“¦ï¼‰ç­‰ç´šåœ°ç†±é›»å» </li>
</ul>
`,

  "ç”Ÿè³ªèƒ½": `
<h2 style="font-size: 28px; font-weight: bold; color: #2c3e50; margin-bottom: 20px; border-bottom: 3px solid #3498db; padding-bottom: 10px;">ç”Ÿè³ªèƒ½</h2>

<h3 style="font-size: 20px; font-weight: 600; color: #34495e; margin-top: 25px; margin-bottom: 12px;">1986â€“ç¾ä»Šï¼šç”Ÿè³ªèƒ½ç™¼é›»é€æ­¥å¢åŠ ã€‚</h3>
<ul style="line-height: 1.8; margin-left: 20px;">
  <li style="margin-bottom: 8px;"><strong style="color: #e74c3c;">1986</strong>ï½œé¦–åº§æ²¼æ°£ç™¼é›»ç¤ºç¯„å» å•Ÿç”¨</li>
  <li style="margin-bottom: 8px;"><strong style="color: #e74c3c;">1989</strong>ï½œç”Ÿè³ªèƒ½é¦–æ¬¡åœ¨èƒ½æºä¾›æ‡‰ä¸­å‡ºç¾</li>
  <li style="margin-bottom: 8px;"><strong style="color: #e74c3c;">2010</strong>ï½œå±æ±ç¸£å…­å¡Šåå»ºç½®å»šé¤˜æ²¼æ°£ç™¼é›»ç¤ºç¯„å ´ï¼ˆå…¨è‡ºé¦–åº§å»šé¤˜æ²¼æ°£å ´ï¼‰ï¼Œå°‡å»šé¤˜è½‰åŒ–ç‚ºæ²¼æ°£ç™¼é›»ï¼Œæé«˜å»šé¤˜è³‡æºåŒ–åˆ©ç”¨</li>
</ul>
`,

  "å¤©ç„¶æ°£": `
<h2 style="font-size: 28px; font-weight: bold; color: #2c3e50; margin-bottom: 20px; border-bottom: 3px solid #3498db; padding-bottom: 10px;">å¤©ç„¶æ°£</h2>

<h3 style="font-size: 20px; font-weight: 600; color: #34495e; margin-top: 25px; margin-bottom: 12px;">1960â€“1980å¹´ä»£ï¼šæ²¹æ°£ç™¼ç¾é«˜å³°æœŸ</h3>
<ul style="line-height: 1.8; margin-left: 20px;">
  <p style="margin-bottom: 8px;">å°ç£æœ€æ—©é–‹æ¡å¤©ç„¶æ°£å¯è¿½æº¯åˆ°æ¸…é ˜æ™‚æœŸï¼Œç¶“1960-1980å¹´ä»£çš„æ²¹æ°£ç™¼ç¾é«˜å³°æœŸï¼Œè¿ä¾†å¤©ç„¶æ°£ç”¢é‡çš„å…¨ç››æœŸï¼Œæœ€é«˜æ—¥ç”¢å¤©ç„¶æ°£å¯é”äº”ç™¾é¤˜è¬ç«‹æ–¹å…¬å°ºï¼Œå¹´ç”¢é‡æ¥è¿‘20å„„ç«‹æ–¹å…¬å°ºã€‚</li>
</ul>

<h3 style="font-size: 20px; font-weight: 600; color: #34495e; margin-top: 25px; margin-bottom: 12px;">1990â€“2010å¹´ä»£ï¼šç©©å¥æˆé•·æœŸ</h3>
<ul style="line-height: 1.8; margin-left: 20px;">
  <li style="margin-bottom: 8px;"><strong style="color: #e74c3c;">1990å¹´</strong>ï½œæ°¸å®‰æ¶²åŒ–å¤©ç„¶æ°£æ¥æ”¶ç«™ï¼ˆä¸€æ¥ï¼‰å•Ÿç”¨ï¼Œé–‹å§‹é€²å£æ¶²åŒ–å¤©ç„¶æ°£ï¼Œè‡ªç”¢å¤©ç„¶æ°£çš„å¸‚å ´æ¯”ä¾‹é€å¹´ä¸‹é™ã€‚</li>
  <li style="margin-bottom: 8px;"><strong style="color: #e74c3c;">2006å¹´</strong>ï½œå¤§æ½­å¤©ç„¶æ°£ç™¼é›»å» é–‹å§‹å•†è½‰ï¼Œæˆç‚ºå¤©ç„¶æ°£ä¸»åŠ›é›»å» ã€‚</li>
  <li style="margin-bottom: 8px;"><strong style="color: #e74c3c;">2009å¹´</strong>ï½œå°ä¸­æ¶²åŒ–å¤©ç„¶æ°£æ¥æ”¶ç«™ï¼ˆäºŒæ¥ï¼‰å•Ÿç”¨ã€‚</li>
</ul>

<h3 style="font-size: 20px; font-weight: 600; color: #34495e; margin-top: 25px; margin-bottom: 12px;">2011â€“ç¾ä»Šï¼šæ¥æ”¶ç«™æ“´å±•æœŸ</h3>
<ul style="line-height: 1.8; margin-left: 20px;">
  <li style="margin-bottom: 8px;"><strong style="color: #e74c3c;">2011å¹´</strong>ï½œå®£å¸ƒ2025ã€Œéæ ¸å®¶åœ’ã€æ§‹æƒ³ï¼Œå–Šè©±2025å¹´ã€Œ532ã€ç™¼é›»èƒ½æºé…æ¯”ï¼Œå³å¤©ç„¶æ°£50%ã€ç‡ƒç…¤30%ã€å†ç”Ÿèƒ½æº20%ã€‚</li>
  <li style="margin-bottom: 8px;"><strong style="color: #e74c3c;">2011å¹´â€“ç¾ä»Š</strong>ï½œæ”¿ç­–ç¢ºç«‹å¾Œï¼Œé–‹å§‹è¦åŠƒå¢åŠ å¤©ç„¶æ°£ä¾›æ‡‰èƒ½åŠ›ï¼Œé™¸çºŒè¦åŠƒã€Œä¸‰æ¥ã€ï¼ˆç¬¬ä¸‰å¤©ç„¶æ°£æ¥æ”¶ç«™ï¼‰åˆ°ã€Œä¸ƒæ¥ã€ï¼ˆç¬¬ä¸ƒå¤©ç„¶æ°£æ¥æ”¶ç«™ï¼‰åœ¨æœªä¾†å–ä»£éƒ¨åˆ†ç‡ƒç…¤èˆ‡æ ¸èƒ½é›»åŠ›ï¼Œä»¥é”æˆç‡ƒæ°£ç™¼é›»å æ¯”50%ç›®æ¨™ã€‚</li>
</ul>
`
};



function showInfoModal(key) {
  const infoModalOverlay = d3.select("#info-modal-overlay");
  const infoModalText = d3.select("#info-modal-text");
  const message = infoMessages[key] || genreMessages[key] || "ç„¡èªªæ˜";
  infoModalText.html(message);
  infoModalOverlay.style("display", "flex");
}

function closeInfoModal() {
  d3.select("#info-modal-overlay").style("display", "none");
}

d3.select("#info-modal-close").on("click", closeInfoModal);
d3.select("#info-modal-overlay").on("click", function(event) {
  if (event.target === d3.select("#info-modal-overlay").node()) {
    closeInfoModal();
  }
});

d3.selectAll(".info-icon").on("click", function() {
  const key = d3.select(this).attr("data-info");
  showInfoModal(key);
});

const chartContainer = document.getElementById('chart');
let chartWidth = 0;
let chartHeight = 0;

function initChart() {
  chartWidth = chartContainer.offsetWidth - 40;
  chartHeight = chartContainer.offsetHeight - 40;
}

initChart();

const svg = chart.append("svg")
  .attr("width", chartWidth)
  .attr("height", chartHeight)
  .style("display", "block")
  .style("margin", "0 auto");

let sankey = d3.sankey()
  .nodeWidth(35)
  .nodePadding(25)
  .extent([[100, 50], [chartWidth - 100, chartHeight - 50]])
  .nodeAlign(d3.sankeyLeft)
  .nodeSort((a, b) => {
    if (a.layer !== b.layer) return a.layer - b.layer;
    return a.name.localeCompare(b.name);
  });

const colorMap = {
  "ç…¤åŠç…¤ç”¢å“": "#013982",
  "åŸæ²¹åŠçŸ³æ²¹ç”¢å“": "#ade6e7",
  "å¤©ç„¶æ°£": "#dcdda3",
  "æ ¸èƒ½": "#c4a3c5",
  "æ°´åŠ›": "#1e90ff",
  "åœ°ç†±": "#dc143c",
  "å¤ªé™½å…‰é›»": "#ffa500",
  "é¢¨åŠ›": "#00ced1",
  "ç”Ÿè³ªèƒ½åŠå»¢æ£„ç‰©": "#8b4513",
  "å†ç”Ÿèƒ½æº": "#2e8b57",
  "é›»åŠ›ç³»çµ±": "#ffed9f",
  "ç…¤ç‚­çš„è£½é€ èˆ‡åˆ†éŠ·": "#013982",
  "åŸæ²¹åŠçŸ³æ²¹çš„è£½é€ èˆ‡åˆ†éŠ·": "#ade6e7",
  "å¤©ç„¶æ°£çš„ç”Ÿç”¢èˆ‡åˆ†éŠ·": "#dcdda3",
  "èƒ½æºéƒ¨é–€è‡ªç”¨": "#bcbcbc",
  "é›»ç¶²æè€—": "#fcd001",
  "å·¥æ¥­éƒ¨é–€": "#1f77b4",
  "é‹è¼¸éƒ¨é–€": "#ff7f0e",
  "ä½å®…éƒ¨é–€": "#2ca02c",
  "æœå‹™æ¥­éƒ¨é–€": "#d62728",
  "è¾²æ¥­éƒ¨é–€": "#9467bd",
  "è½‰æ›æ•ˆç‡æå¤±": "#494646",
  "éèƒ½æºæ¶ˆè²»": "#f084ff"
};

const csvBase = "https://raw.githubusercontent.com/ryan34861810-art/energyflow/main/csv/";
const years = d3.range(1982, 2025);
let dataByYear = {};
let eventsData = [];
let categoryData = {};

function showDepartmentModal(departmentName, year) {
  const rawData = dataByYear[year] || [];
  const subItems = rawData.filter(d => {
    if (!d.Target || !d.Source) return false;
    const valueStr = d["Value(kKLOE)"];
    if (!valueStr) return false;
    const value = parseFloat(valueStr);
    if (isNaN(value) || value <= 0) return false;
    return d.Source === departmentName;
  });
  
  modalTitle.text(`${departmentName}è©³ç´°èƒ½æºæµ (${year})`);
  modalSankey.html("");
  modalOverlay.style("display", "flex");
  
  if (subItems.length === 0) {
    modalSankey.append("div").style("text-align", "center").style("padding", "50px").style("color", "#999").style("font-size", "16px").html(`æ­¤éƒ¨é–€ç„¡è©³ç´°èƒ½æºè¼¸å‡ºæµå‘è³‡æ–™`);
    return;
  }
  
  const sankeyNodes = [];
  const sankeyLinks = [];
  const nodeMap = new Map();
  let nodeIndex = 0;
  
  const departmentTotal = d3.sum(subItems, d => +d["Value(kKLOE)"]);
  
  if (departmentName === "å·¥æ¥­éƒ¨é–€") {
    const categorizedItems = {};
    subItems.forEach(d => {
      const target = d.Target;
      const category = categoryData[target] || "å…¶ä»–";
      
      if (!categorizedItems[category]) {
        categorizedItems[category] = 0;
      }
      categorizedItems[category] += +d["Value(kKLOE)"];
    });
    
    sankeyNodes.push({ name: departmentName, layer: 0 });
    nodeMap.set(departmentName, nodeIndex++);
    
    const categories = Object.keys(categorizedItems).sort();
    categories.forEach(category => {
      sankeyNodes.push({ name: category, layer: 1 });
      nodeMap.set(category, nodeIndex++);
    });
    
    categories.forEach(category => {
      sankeyLinks.push({
        source: nodeMap.get(departmentName),
        target: nodeMap.get(category),
        value: categorizedItems[category]
      });
    });
  } else {
    const sources = new Set();
    const targets = new Set();
    
    subItems.forEach(d => {
      sources.add(d.Source);
      targets.add(d.Target);
    });
    
    sources.forEach(source => {
      sankeyNodes.push({ name: source, layer: 0 });
      nodeMap.set(source, nodeIndex++);
    });
    
    targets.forEach(target => {
      sankeyNodes.push({ name: target, layer: 1 });
      nodeMap.set(target, nodeIndex++);
    });
    
    subItems.forEach(d => {
      if (nodeMap.has(d.Source) && nodeMap.has(d.Target)) {
        sankeyLinks.push({
          source: nodeMap.get(d.Source),
          target: nodeMap.get(d.Target),
          value: +d["Value(kKLOE)"]
        });
      }
    });
  }
  
  if (sankeyLinks.length === 0) {
    modalSankey.append("div").style("text-align", "center").style("padding", "50px").style("color", "#999").text("ç„¡æœ‰æ•ˆé€£çµè³‡æ–™");
    return;
  }
  
  setTimeout(() => {
    const modalWidth = modalSankey.node().offsetWidth;
    const modalHeight = modalSankey.node().offsetHeight;
    const modalSvg = modalSankey.append("svg").attr("width", modalWidth).attr("height", modalHeight);
    const leftX = 100;
    const rightX = modalWidth - 150;
    const subItemPadding = 20;
    const totalValue = d3.sum(sankeyLinks, l => l.value);
    const availableHeight = modalHeight - 80;
    const totalPadding = subItemPadding * (sankeyNodes.filter(n => n.layer === 1).length - 1);
    const usableHeight = availableHeight - totalPadding;
    const heightScale = usableHeight / totalValue;
    
    sankeyNodes.forEach(n => {
      if (n.layer === 0) {
        const outgoingValue = d3.sum(sankeyLinks.filter(l => sankeyNodes[l.source].name === n.name), l => l.value);
        const nodeHeight = outgoingValue * heightScale;
        n.x0 = leftX;
        n.x1 = leftX + 35;
        n.y0 = (modalHeight - nodeHeight) / 2;
        n.y1 = n.y0 + nodeHeight;
      }
    });
    
    const rightNodes = sankeyNodes.filter(n => n.layer === 1);
    let currentY = 40;
    rightNodes.forEach(n => {
      const incomingValue = d3.sum(sankeyLinks.filter(l => sankeyNodes[l.target].name === n.name), l => l.value);
      const nodeHeight = incomingValue * heightScale;
      n.x0 = rightX;
      n.x1 = rightX + 35;
      n.y0 = currentY;
      n.y1 = currentY + nodeHeight;
      currentY += nodeHeight + subItemPadding;
    });
    
    const nodeOffsets = new Map();
    sankeyNodes.forEach(n => {
      nodeOffsets.set(n.name, { source: n.y0, target: n.y0 });
    });
    
    const sankeyLinks2 = sankeyLinks.map(link => {
      const source = sankeyNodes[link.source];
      const target = sankeyNodes[link.target];
      const linkHeight = link.value * heightScale;
      const sourceOffset = nodeOffsets.get(source.name);
      const targetOffset = nodeOffsets.get(target.name);
      const result = {
        source: source,
        target: target,
        value: link.value,
        y0: sourceOffset.source + linkHeight / 2,
        y1: targetOffset.target + linkHeight / 2,
        width: linkHeight
      };
      sourceOffset.source += linkHeight;
      targetOffset.target += linkHeight;
      return result;
    });
    
    const departmentNode = sankeyNodes.find(n => n.layer === 0);
    const linkColor = colorMap[departmentNode.name] || "#999";
    
    modalSvg.append("g").selectAll("path").data(sankeyLinks2).join("path").attr("class", "modal-link").attr("d", d => {
      const x0 = d.source.x1;
      const x1 = d.target.x0;
      const y0 = d.y0;
      const y1 = d.y1;
      const hw = d.width / 2;
      const xi = d3.interpolateNumber(x0, x1);
      const x2 = xi(0.5);
      return `M${x0},${y0 - hw} C${x2},${y0 - hw} ${x2},${y1 - hw} ${x1},${y1 - hw} L${x1},${y1 + hw} C${x2},${y1 + hw} ${x2},${y0 + hw} ${x0},${y0 + hw} Z`;
    }).attr("fill", linkColor).attr("fill-opacity", 0.5).on("mousemove", function(event, d) {
      const percentage = ((d.value / departmentTotal) * 100).toFixed(1);
      tooltip.style("display", "block").style("left", (event.pageX + 15) + "px").style("top", (event.pageY + 15) + "px").html(`<strong>${d.target.name}</strong><br/>æ•¸å€¼ï¼š${d.value.toLocaleString()} ktoe<br/>ä½”${departmentName}ï¼š${percentage}%`);
    }).on("mouseout", () => tooltip.style("display", "none"));
    
    const node = modalSvg.append("g").selectAll("g").data(sankeyNodes).join("g").attr("class", "modal-node");
    node.append("rect").attr("x", d => d.x0).attr("y", d => d.y0).attr("height", d => d.y1 - d.y0).attr("width", d => d.x1 - d.x0).attr("rx", 4).attr("ry", 4).attr("fill", linkColor);
    node.append("text").attr("x", d => d.x0 < modalWidth / 2 ? d.x1 + 6 : d.x0 - 6).attr("y", d => (d.y1 + d.y0) / 2).attr("dy", "0.35em").attr("text-anchor", d => d.x0 < modalWidth / 2 ? "start" : "end").text(d => d.name).style("font-size", "13px");
    node.on("mousemove", (event, d) => {
      const value = d3.sum(sankeyLinks.filter(l => sankeyNodes[l.source].name === d.name || sankeyNodes[l.target].name === d.name), l => l.value);
      const percentage = ((value / departmentTotal) * 100).toFixed(1);
      tooltip.style("display", "block").style("left", (event.pageX + 15) + "px").style("top", (event.pageY + 15) + "px").html(`<strong>${d.name}</strong><br/>æ•¸å€¼ï¼š${value.toLocaleString()} ktoe<br/>ä½”${departmentName}ï¼š${percentage}%`);
    }).on("mouseout", () => tooltip.style("display", "none"));
  }, 50);
}

function closeModal() {
  modalOverlay.style("display", "none");
}

modalClose.on("click", closeModal);
modalOverlay.on("click", function(event) {
  if (event.target === modalOverlay.node()) closeModal();
});

function collectAllNodeNames() {
  const layer0Nodes = new Set();
  const layer1Nodes = new Set();
  const layer2Nodes = new Set();
  
  Object.values(dataByYear).forEach(yearData => {
    const filtered = filterDepartmentLevel(yearData);
    filtered.forEach(d => {
      const sourceName = d.Source;
      const targetName = d.Target;
      if (energySources.some(s => sourceName.includes(s.substring(0, 3))) || sourceName.includes("æ ¸èƒ½") || sourceName.includes("æ°´åŠ›") || sourceName.includes("åœ°ç†±") || sourceName.includes("å¤ªé™½") || sourceName.includes("é¢¨åŠ›") || sourceName.includes("ç”Ÿè³ª")) {
        layer0Nodes.add(sourceName);
      } else if (departments.includes(sourceName)) {
        layer2Nodes.add(sourceName);
      } else {
        layer1Nodes.add(sourceName);
      }
      if (energySources.some(s => targetName.includes(s.substring(0, 3))) || targetName.includes("æ ¸èƒ½") || targetName.includes("æ°´åŠ›") || targetName.includes("åœ°ç†±") || targetName.includes("å¤ªé™½") || targetName.includes("é¢¨åŠ›") || targetName.includes("ç”Ÿè³ª")) {
        layer0Nodes.add(targetName);
      } else if (departments.includes(targetName)) {
        layer2Nodes.add(targetName);
      } else {
        layer1Nodes.add(targetName);
      }
    });
  });
  
  const sortedNames = ["ç¸½èƒ½æºä¾›çµ¦", "å†ç”Ÿèƒ½æºç¸½é‡", ...Array.from(layer0Nodes).sort(), ...Array.from(layer1Nodes).sort(), ...Array.from(layer2Nodes).sort()];
  const select1 = d3.select("#data1-select");
  const select2 = d3.select("#data2-select");
  select1.selectAll("option:not(:first-child)").remove();
  select2.selectAll("option:not(:first-child)").remove();
  sortedNames.forEach(name => {
    select1.append("option").attr("value", name).text(name);
    select2.append("option").attr("value", name).text(name);
  });
  if (sortedNames.includes("ç…¤åŠç…¤ç”¢å“")) select1.property("value", "ç…¤åŠç…¤ç”¢å“");
  if (sortedNames.includes("å†ç”Ÿèƒ½æºç¸½é‡")) select2.property("value", "å†ç”Ÿèƒ½æºç¸½é‡");
  updateTrendChart();
}

function getNodeValue(nodeName, year) {
  const yearData = dataByYear[year];
  if (!yearData) return 0;
  
  if (nodeName === "ç¸½èƒ½æºä¾›çµ¦") {
    const primaryEnergySources = ["ç…¤åŠç…¤ç”¢å“", "åŸæ²¹åŠçŸ³æ²¹ç”¢å“", "å¤©ç„¶æ°£", "æ ¸èƒ½", "æ°´åŠ›", "åœ°ç†±", "å¤ªé™½å…‰é›»", "é¢¨åŠ›", "ç”Ÿè³ªèƒ½åŠå»¢æ£„ç‰©"];
    return d3.sum(primaryEnergySources, nodeName => {
      return d3.sum(yearData.filter(d => d.Source === nodeName && +d["Value(kKLOE)"] > 0), d => +d["Value(kKLOE)"]);
    });
  }
  
  if (nodeName === "å†ç”Ÿèƒ½æºç¸½é‡") {
    const renewableSources = ["æ°´åŠ›", "åœ°ç†±", "å¤ªé™½å…‰é›»", "é¢¨åŠ›", "ç”Ÿè³ªèƒ½åŠå»¢æ£„ç‰©"];
    return d3.sum(renewableSources, nodeName => {
      return d3.sum(yearData.filter(d => d.Source === nodeName && +d["Value(kKLOE)"] > 0), d => +d["Value(kKLOE)"]);
    });
  }
  
  const filtered = filterDepartmentLevel(yearData);
  return d3.sum(filtered.filter(d => d.Source === nodeName || d.Target === nodeName), d => +d["Value(kKLOE)"]);
}

function updateTrendChart() {
  const data1Name = d3.select("#data1-select").property("value");
  const data2Name = d3.select("#data2-select").property("value");
  const trendChart = d3.select("#trend-chart");
  trendChart.classed("visible", false);
  
  setTimeout(() => {
    trendChart.html("");
    const legend = d3.select("#trend-legend");
    legend.html("");
    if (!data1Name && !data2Name) return;
    
    const currentChartWidth = chartContainer.offsetWidth - 40;
    
    const margin = {top: 20, right: 100, bottom: 40, left: 100};
    const trendWidth = currentChartWidth - margin.left - margin.right;
    const trendHeight = 280 - margin.top - margin.bottom;
    const svg = trendChart.append("svg").attr("width", currentChartWidth).attr("height", trendHeight + margin.top + margin.bottom).append("g").attr("transform", `translate(${margin.left},${margin.top})`);
    
    const data1 = data1Name ? years.map(y => ({year: y, value: getNodeValue(data1Name, y)})) : [];
    const data2 = data2Name ? years.map(y => ({year: y, value: getNodeValue(data2Name, y)})) : [];
    const allValues = [...data1.map(d => d.value), ...data2.map(d => d.value)];
    const maxValue = d3.max(allValues) || 100;
    
    const x = d3.scaleLinear().domain([years[0], years[years.length - 1]]).range([0, trendWidth]);
    const y = d3.scaleLinear().domain([0, maxValue * 1.1]).range([trendHeight, 0]);
    
    svg.append("g").attr("transform", `translate(0,${trendHeight})`).call(d3.axisBottom(x).tickFormat(d3.format("d")).ticks(8)).style("font-size", "11px");
    svg.append("g").call(d3.axisLeft(y).tickFormat(d => d.toLocaleString())).style("font-size", "11px");
    svg.append("text").attr("transform", "rotate(-90)").attr("y", -55).attr("x", -trendHeight / 2).attr("text-anchor", "middle").style("font-size", "12px").style("fill", "#666").text("æ•¸å€¼ (ktoe)");
    
    const line = d3.line().x(d => x(d.year)).y(d => y(d.value)).curve(d3.curveMonotoneX);
    
    function colorDistance(color1, color2) {
      const rgb1 = d3.color(color1).rgb();
      const rgb2 = d3.color(color2).rgb();
      return Math.sqrt(Math.pow(rgb1.r - rgb2.r, 2) + Math.pow(rgb1.g - rgb2.g, 2) + Math.pow(rgb1.b - rgb2.b, 2));
    }
    
    const contrastColors = ["#e74c3c", "#f39c12", "#9b59b6", "#16a085", "#2980b9", "#c0392b"];
    
    if (data1Name && data1.length > 0) {
      let color1 = data1Name === "å†ç”Ÿèƒ½æºç¸½é‡" ? "#2e8b57" : (data1Name === "ç¸½èƒ½æºä¾›çµ¦" ? "#4a90e2" : (colorMap[data1Name] || "#668ab9"));
      const path1 = svg.append("path").datum(data1).attr("class", "trend-line line1").attr("d", line).attr("stroke", color1).attr("stroke-width", 3).attr("fill", "none");
      const totalLength1 = path1.node().getTotalLength();
      path1.attr("stroke-dasharray", totalLength1 + " " + totalLength1).attr("stroke-dashoffset", totalLength1).classed("animated", true).style("animation", `drawLine 1.5s ease-out forwards`);
      svg.selectAll(".dot1").data(data1).join("circle").attr("class", "trend-dot").attr("cx", d => x(d.year)).attr("cy", d => y(d.value)).attr("r", 4).attr("fill", color1).style("animation-delay", (d, i) => `${i * 0.02}s`).on("mousemove", (event, d) => {
        tooltip.style("display", "block").style("left", (event.pageX + 15) + "px").style("top", (event.pageY + 15) + "px").html(`<strong>${data1Name}</strong><br/>å¹´ä»½ï¼š${d.year}<br/>æ•¸å€¼ï¼š${d.value.toLocaleString()} ktoe`);
      }).on("mouseout", () => tooltip.style("display", "none"));
      legend.append("div").attr("class", "legend-item").html(`<div class="legend-color" style="background: ${color1}"></div><span>${data1Name}</span>`);
    }
    
    if (data2Name && data2.length > 0) {
      let color1 = data1Name === "å†ç”Ÿèƒ½æºç¸½é‡" ? "#2e8b57" : (data1Name === "ç¸½èƒ½æºä¾›çµ¦" ? "#4a90e2" : (colorMap[data1Name] || "#668ab9"));
      let color2 = data2Name === "å†ç”Ÿèƒ½æºç¸½é‡" ? "#2e8b57" : (data2Name === "ç¸½èƒ½æºä¾›çµ¦" ? "#4a90e2" : (colorMap[data2Name] || "#e67e22"));
      if (data1Name && colorDistance(color1, color2) < 100) {
        let maxDistance = 0;
        let bestColor = contrastColors[0];
        for (const c of contrastColors) {
          const dist = colorDistance(color1, c);
          if (dist > maxDistance) {
            maxDistance = dist;
            bestColor = c;
          }
        }
        color2 = bestColor;
      }
      const path2 = svg.append("path").datum(data2).attr("class", "trend-line line2").attr("d", line).attr("stroke", color2).attr("stroke-width", 3).attr("fill", "none");
      const totalLength2 = path2.node().getTotalLength();
      path2.attr("stroke-dasharray", totalLength2 + " " + totalLength2).attr("stroke-dashoffset", totalLength2).classed("animated", true).style("animation", `drawLine 1.5s ease-out forwards`);
      svg.selectAll(".dot2").data(data2).join("circle").attr("class", "trend-dot").attr("cx", d => x(d.year)).attr("cy", d => y(d.value)).attr("r", 4).attr("fill", color2).style("animation-delay", (d, i) => `${i * 0.02}s`).on("mousemove", (event, d) => {
        tooltip.style("display", "block").style("left", (event.pageX + 15) + "px").style("top", (event.pageY + 15) + "px").html(`<strong>${data2Name}</strong><br/>å¹´ä»½ï¼š${d.year}<br/>æ•¸å€¼ï¼š${d.value.toLocaleString()} ktoe`);
      }).on("mouseout", () => tooltip.style("display", "none"));
      legend.append("div").attr("class", "legend-item").html(`<div class="legend-color" style="background: ${color2}"></div><span>${data2Name}</span>`);
    }
    setTimeout(() => trendChart.classed("visible", true), 50);
  }, 300);
}

async function loadEvents() {
  try {
    const response = await fetch(`${csvBase}events.csv`);
    if (response.ok) {
      const text = await response.text();
      eventsData = d3.csvParse(text);
    }
  } catch (e) {
    console.log('No events file found');
  }
}

async function loadCategories() {
  try {
    const response = await fetch(`${csvBase}category.csv`);
    if (response.ok) {
      let text = await response.text();
      
      if (text.includes('ï¿½') || text.match(/[\u0080-\u009F]/)) {
        const blob = await (await fetch(`${csvBase}category.csv`)).blob();
        text = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.readAsText(blob, 'Big5');
        });
      }
      
      const data = d3.csvParse(text);
      data.forEach(row => {
        if (row['éƒ¨é–€'] && row['åˆ†é¡']) {
          categoryData[row['éƒ¨é–€']] = row['åˆ†é¡'];
        }
      });
    }
  } catch (e) {
    console.log('Failed to load category.csv');
  }
}

function updateEventsDisplay(year) {
  const eventsColumn = d3.select("#events-column");
  eventsColumn.html('<div id="events-hint">ğŸ’¡ é»æ“Šäº‹ä»¶æŸ¥çœ‹æ›´å¤šè³‡è¨Š</div>');
  
  if (!eventsData || eventsData.length === 0) return;
  
  const activeEvents = eventsData.filter(e => {
    const start = +e.start;
    const end = +e.end;
    return year >= start && year <= end;
  });
  
  if (activeEvents.length === 0) return;
  
  const slider = document.getElementById("yearSlider");
  const minYear = +slider.min;
  const maxYear = +slider.max;
  const yearRange = maxYear - minYear;
  
  // ä½¿ç”¨å®¹å™¨çš„å¯¦éš›é«˜åº¦
  const containerHeight = document.getElementById("timeline-content").offsetHeight;
  
  // å›ºå®šçš„é‚Šè·ï¼Œè®“äº‹ä»¶ä¸è¶…å‡ºå¯è¦‹ç¯„åœ
  const topMargin = 0;
  const bottomMargin = 78;
  const usableHeight = containerHeight - topMargin - bottomMargin;
  
  activeEvents.sort((a, b) => {
    const midA = (+a.start + +a.end) / 2;
    const midB = (+b.start + +b.end) / 2;
    return midA - midB;
  });
  
  const eventsByYear = new Map();
  
  activeEvents.forEach((event) => {
    const start = +event.start;
    const end = +event.end;
    const midYear = (start + end) / 2;
    const yearKey = `${start}-${end}`;
    
    if (!eventsByYear.has(yearKey)) {
      eventsByYear.set(yearKey, {
        midYear: midYear,
        start: start,
        end: end,
        events: []
      });
    }
    eventsByYear.get(yearKey).events.push(event);
  });
  
  const sortedYearGroups = Array.from(eventsByYear.values()).sort((a, b) => a.midYear - b.midYear);
  
  // è¨ˆç®—äº‹ä»¶æ°´å¹³ä½ç½®ï¼ˆç›¸åŒäº‹ä»¶åç¨±ä¿æŒç›¸åŒä½ç½®ï¼‰
const eventPositions = new Map();
const eventNameToOffset = new Map(); // è¨˜éŒ„æ¯å€‹äº‹ä»¶åç¨±çš„å›ºå®šä½ç½®
const occupiedRanges = [];

sortedYearGroups.forEach((yearGroup) => {
  yearGroup.events.forEach((event) => {
    const eventKey = `${event.event}-${yearGroup.start}-${yearGroup.end}`;
    const eventName = event.event;
    
    // å¦‚æœé€™å€‹äº‹ä»¶åç¨±å·²ç¶“æœ‰å›ºå®šä½ç½®ï¼Œç›´æ¥ä½¿ç”¨
    if (eventNameToOffset.has(eventName)) {
      const offset = eventNameToOffset.get(eventName);
      eventPositions.set(eventKey, offset);
      occupiedRanges.push({
        start: yearGroup.start,
        end: yearGroup.end,
        offset: offset,
        eventName: eventName
      });
    } else {
      // ç‚ºæ–°çš„äº‹ä»¶åç¨±æ‰¾ä½ç½®
      let offset = 0;
      let foundPosition = false;
      
      while (!foundPosition) {
        const conflicts = occupiedRanges.filter(range => 
          range.offset === offset &&
          !(yearGroup.end < range.start || yearGroup.start > range.end)
        );
        
        if (conflicts.length === 0) {
          foundPosition = true;
          eventPositions.set(eventKey, offset);
          eventNameToOffset.set(eventName, offset); // è¨˜éŒ„é€™å€‹äº‹ä»¶åç¨±çš„å›ºå®šä½ç½®
          occupiedRanges.push({
            start: yearGroup.start,
            end: yearGroup.end,
            offset: offset,
            eventName: eventName
          });
        } else {
          offset += 75;
        }
      }
    }
  });
});
  
  sortedYearGroups.forEach((yearGroup) => {
    // ç°¡å–®çš„æ¯”ä¾‹è¨ˆç®—
    const startYear = yearGroup.start;
    const endYear = yearGroup.end;
    
    // è¨ˆç®—å¹´ä»½åœ¨ç¯„åœä¸­çš„æ¯”ä¾‹
    const startRatio = (startYear - minYear) / yearRange;
    const endRatio = (endYear + 1 - minYear) / yearRange;
    
    // è½‰æ›æˆåƒç´ ä½ç½®
    const startPx = topMargin + (startRatio * usableHeight);
    const endPx = topMargin + (endRatio * usableHeight);
    
    const actualBarHeight = endPx - startPx;
    const isMultiYear = yearGroup.start !== yearGroup.end;
    
    yearGroup.events.forEach((event, index) => {
      const genre = event.genre ? event.genre.trim() : "";
      let barColor = "#1e90ff";
      
      if (genre) {
        if (genre.includes("æ ¸èƒ½")) barColor = colorMap["æ ¸èƒ½"] || "#c4a3c5";
        else if (genre.includes("å¤©ç„¶æ°£")) barColor = colorMap["å¤©ç„¶æ°£"] || "#dcdda3";  // â† åŠ é€™è¡Œ

        else if (genre.includes("ç«åŠ›") || genre.includes("ç…¤") || genre.includes("çŸ³æ²¹")) barColor = colorMap["ç…¤åŠç…¤ç”¢å“"] || "#013982";
        else if (genre.includes("æ°´åŠ›")) barColor = colorMap["æ°´åŠ›"] || "#1e90ff";
        else if (genre.includes("å¤ªé™½")) barColor = colorMap["å¤ªé™½å…‰é›»"] || "#ffa500";
        else if (genre.includes("é¢¨åŠ›")) barColor = colorMap["é¢¨åŠ›"] || "#00ced1";
        else if (genre.includes("åœ°ç†±")) barColor = colorMap["åœ°ç†±"] || "#dc143c";
        else if (genre.includes("ç”Ÿè³ª")) barColor = colorMap["ç”Ÿè³ªèƒ½åŠå»¢æ£„ç‰©"] || "#8b4513";
      }
      
      const eventKey = `${event.event}-${yearGroup.start}-${yearGroup.end}`;
      const leftOffset = eventPositions.get(eventKey) || 0;
      
      const eventItem = eventsColumn.append("div")
        .attr("class", "event-item")
        .style("top", `${startPx}px`)
        .style("left", `${leftOffset}px`);
      
      const eventBar = eventItem.append("div")
        .attr("class", "event-bar" + (isMultiYear ? " multi-year" : ""))
        .style("background", barColor);
      
      if (isMultiYear && actualBarHeight > 0) {
        eventBar.style("height", `${actualBarHeight}px`);
      }
      
      const eventContent = eventItem.append("div").attr("class", "event-content");
      
      const yearRow = eventContent.append("div")
        .attr("class", "event-year-row");
      
      yearRow.append("div")
        .attr("class", "event-year-number") 
        .text(yearGroup.start === yearGroup.end ? yearGroup.start : `${yearGroup.start}-${yearGroup.end}`);
      
      const eventName = eventContent.append("div")
  .attr("class", "event-name")
  .text(event.event)
  .style("transform", "translateY(0px)");

setTimeout(() => {
  const eventNameNode = eventName.node();
  const nameRect = eventNameNode.getBoundingClientRect();
  const nameBottom = nameRect.bottom;
  const nameTop = nameRect.top;
  const nameHeight = nameRect.height;
  const columnRect = document.getElementById("events-column").getBoundingClientRect();
  const columnBottom = columnRect.bottom;
  const columnTop = columnRect.top + 35; // æç¤ºæ–‡å­—é«˜åº¦åŠ ä¸€äº›é–“è·
  
  // æª¢æŸ¥æ˜¯å¦å¿«ç¢°åˆ°åº•éƒ¨ï¼ˆè·é›¢åº•éƒ¨å°‘æ–¼ 10pxï¼‰
  if (nameBottom > columnBottom - 10) {
    // å¾åº•éƒ¨å°é½Š
    const adjustment = nameBottom - (columnBottom);
    eventName.style("transform", `translateY(-${adjustment}px)`);
  }
  // æª¢æŸ¥é ‚éƒ¨ç¢°æ’
  else if (nameTop < columnTop) {
    const adjustment = columnTop - nameTop + 5;
    eventName.style("transform", `translateY(${adjustment}px)`);
  }
  // å¦å‰‡ä¿æŒé è¨­ï¼ˆå°é½Šå‚ç›´æ¢é ‚éƒ¨ï¼‰
  else {
    eventName.style("transform", `translateY(0px)`);
  }
}, 10);
      
      if (genre) {
        eventItem.style("cursor", "pointer")
          .on("click", function() {
            showInfoModal(genre);
          });
      }
    });
  });
}

async function loadAllCSV() {
  await loadEvents();
  await loadCategories();
  
  for (const y of years) {
    const rocYear = y - 1911;
    const urls = [
      `${csvBase}template${String(rocYear).padStart(3,"0")}.csv`,
      `${csvBase}template${rocYear}.csv`
    ];
    
    let loaded = false;
    for (const url of urls) {
      try {
        const response = await fetch(url);
        if (!response.ok) continue;
        
        let text = await response.text();
        
        if (text.includes('ï¿½') || text.match(/[\u0080-\u009F]/)) {
          const blob = await (await fetch(url)).blob();
          text = await new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.readAsText(blob, 'Big5');
          });
        }
        
        const data = d3.csvParse(text);
        if (data && data.length > 0) {
          dataByYear[y] = data;
          loaded = true;
          break;
        }
      } catch (e) {
        continue;
      }
    }
  }
  
  updateChart(1982);
  updateEventsDisplay(1982);
  collectAllNodeNames();
}

function filterDepartmentLevel(data) {
  return data.filter(d => {
    if (!d.Source || !d.Target) return false;
    const valueStr = d["Value(kKLOE)"];
    if (!valueStr) return false;
    const value = parseFloat(valueStr);
    if (isNaN(value) || value <= 0) return false;
    if (departments.includes(d.Target)) return true;
    if (d.Target.includes("ç³»çµ±") || d.Target.includes("è£½é€ èˆ‡åˆ†éŠ·") || d.Target.includes("ç”Ÿç”¢èˆ‡åˆ†éŠ·") || d.Target.includes("èƒ½æºéƒ¨é–€è‡ªç”¨") || d.Target.includes("é›»ç¶²æè€—")) return true;
    if (d.Source.includes("é›»åŠ›ç³»çµ±") || d.Source.includes("ç³»çµ±")) return true;
    const sourceKeywords = ["ç…¤", "åŸæ²¹", "çŸ³æ²¹", "å¤©ç„¶æ°£", "æ ¸èƒ½", "æ°´åŠ›", "åœ°ç†±", "å¤ªé™½", "é¢¨åŠ›", "ç”Ÿè³ª"];
    if (sourceKeywords.some(keyword => d.Source.includes(keyword))) return true;
    return false;
  });
}

function buildSankeyData(data) {
  const nodes = Array.from(new Set(data.flatMap(d => [d.Source, d.Target]))).map(name => ({ name }));
  const nodeMap = new Map(nodes.map((d, i) => [d.name, i]));
  const links = data.map(d => ({source: nodeMap.get(d.Source), target: nodeMap.get(d.Target), value: +d["Value(kKLOE)"]}));
  nodes.forEach(n => {
    if (energySources.some(s => n.name.includes(s.substring(0, 3))) || n.name.includes("æ ¸èƒ½") || n.name.includes("æ°´åŠ›") || n.name.includes("åœ°ç†±") || n.name.includes("å¤ªé™½") || n.name.includes("é¢¨åŠ›") || n.name.includes("ç”Ÿè³ª")) {
      n.layer = 0;
    } else if (departments.includes(n.name)) {
      n.layer = 2;
    } else {
      n.layer = 1;
    }
  });
  return { nodes, links };
}

function updateChart(year) {
  d3.select("#yearDisplay").text(year);
  svg.selectAll("*").remove();
  const rawData = dataByYear[year] || [];
  const currentData = filterDepartmentLevel(rawData);
  const prevData = filterDepartmentLevel(dataByYear[year - 1] || []);
  if (!currentData.length) return;
  
  const allData = dataByYear[year] || [];
  const primaryEnergySources = ["ç…¤åŠç…¤ç”¢å“", "åŸæ²¹åŠçŸ³æ²¹ç”¢å“", "å¤©ç„¶æ°£", "æ ¸èƒ½", "æ°´åŠ›", "åœ°ç†±", "å¤ªé™½å…‰é›»", "é¢¨åŠ›", "ç”Ÿè³ªèƒ½åŠå»¢æ£„ç‰©"];
  const totalEnergy = d3.sum(primaryEnergySources, nodeName => {
    return d3.sum(allData.filter(d => d.Source === nodeName && +d["Value(kKLOE)"] > 0), d => +d["Value(kKLOE)"]);
  });
  const coalEnergy = d3.sum(allData.filter(d => d.Source === "ç…¤åŠç…¤ç”¢å“" && +d["Value(kKLOE)"] > 0), d => +d["Value(kKLOE)"]);
  const renewableSources = ["æ°´åŠ›", "åœ°ç†±", "å¤ªé™½å…‰é›»", "é¢¨åŠ›", "ç”Ÿè³ªèƒ½åŠå»¢æ£„ç‰©"];
  const renewableEnergy = d3.sum(renewableSources, nodeName => {
    return d3.sum(allData.filter(d => d.Source === nodeName && +d["Value(kKLOE)"] > 0), d => +d["Value(kKLOE)"]);
  });
  const coalPercent = totalEnergy > 0 ? ((coalEnergy / totalEnergy) * 100).toFixed(1) : 0;
  const renewablePercent = totalEnergy > 0 ? ((renewableEnergy / totalEnergy) * 100).toFixed(1) : 0;
  
  d3.select("#totalEnergy").text(totalEnergy.toLocaleString());
  d3.select("#coalPercent").text(coalPercent + "%");
  d3.select("#renewablePercent").text(renewablePercent + "%");
  
  const graphData = buildSankeyData(currentData);
  const layerX = {0: 100, 1: chartWidth / 2, 2: chartWidth - 150};
  graphData.nodes.forEach(n => {n.fixedX = layerX[n.layer];});
  const sankeyData = sankey(graphData);
  sankeyData.nodes.forEach(n => {
    const targetX = layerX[n.layer];
    n.x0 = targetX;
    n.x1 = targetX + 35;
  });
  
  svg.append("g").attr("fill", "none").selectAll("path").data(sankeyData.links).join("path").attr("d", d3.sankeyLinkHorizontal()).attr("stroke", "#aaa").attr("stroke-width", d => Math.max(1, d.width)).attr("class", "link");
  const node = svg.append("g").selectAll("g").data(sankeyData.nodes).join("g").attr("class", d => clickableDepartments.includes(d.name) ? "node clickable" : "node");
  node.append("rect").attr("x", d => d.x0).attr("y", d => d.y0).attr("height", d => d.y1 - d.y0).attr("width", d => d.x1 - d.x0).attr("rx", 4).attr("ry", 4).attr("fill", d => colorMap[d.name] || d3.schemeCategory10[d.index % 10]).style("filter", "drop-shadow(0 2px 4px rgba(0, 0, 0, 0.15))");
  node.append("rect").attr("class", "node-hitarea").attr("x", d => d.x0 - 10).attr("y", d => d.y0 - 5).attr("height", d => (d.y1 - d.y0) + 10).attr("width", d => (d.x1 - d.x0) + 20);
  node.append("text").attr("x", d => d.x0 < chartWidth / 2 ? d.x1 + 6 : d.x0 - 6).attr("y", d => (d.y1 + d.y0) / 2).attr("dy", "0.35em").attr("text-anchor", d => d.x0 < chartWidth / 2 ? "start" : "end").text(d => d.name);
  node.on("mousemove", (event, d) => {
    const currentVal = d3.sum(currentData.filter(row => row.Source === d.name || row.Target === d.name), r => +r["Value(kKLOE)"]);
    const prevVal = d3.sum(prevData.filter(row => row.Source === d.name || row.Target === d.name), r => +r["Value(kKLOE)"]);
    const change = prevVal ? (((currentVal - prevVal) / prevVal) * 100).toFixed(1) : "N/A";
    let tooltipText = `<strong>${d.name}</strong><br/>${year} ç¸½é‡ï¼š${currentVal.toLocaleString()} ktoe<br/>èˆ‡å‰ä¸€å¹´è®ŠåŒ–ï¼š${change === "N/A" ? "ç„¡è³‡æ–™" : (change > 0 ? `å¢åŠ  ${change}%` : `ä¸‹é™ ${Math.abs(change)}%`)}`;
    if (clickableDepartments.includes(d.name)) tooltipText += `<br/><em style="color: #ff6b35;">é»æ“ŠæŸ¥çœ‹è©³ç´°è³‡æ–™</em>`;
    tooltip.style("display", "block").style("left", (event.pageX + 15) + "px").style("top", (event.pageY + 15) + "px").html(tooltipText);
  }).on("mouseout", () => tooltip.style("display", "none")).on("click", (event, d) => {
    if (clickableDepartments.includes(d.name)) {
      event.stopPropagation();
      showDepartmentModal(d.name, year);
    }
  }).style("cursor", d => clickableDepartments.includes(d.name) ? "pointer" : "default");
}

d3.select("#yearSlider").on("input", function() {
  const year = +this.value;
  updateChart(year);
  updateEventsDisplay(year);
});

d3.select("#data1-select").on("change", updateTrendChart);
d3.select("#data2-select").on("change", updateTrendChart);

loadAllCSV();
</script>
</body>
</html>
