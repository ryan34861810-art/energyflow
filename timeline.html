def filter_to_department_level(data):
    """éæ¿¾è³‡æ–™åˆ°éƒ¨é–€å±¤ç´šï¼Œåªç§»é™¤éƒ¨é–€ä¸‹çš„å­åˆ†é¡ï¼Œä¿ç•™æ‰€æœ‰éƒ¨é–€ç´šåˆ¥"""
    # å®šç¾©éƒ¨é–€ç´šåˆ¥çš„ç¯€é»ï¼ˆåŒ…å«æ‰€æœ‰ä¸»è¦éƒ¨é–€ï¼‰
    department_level = {
        'å·¥æ¥­éƒ¨é–€', 'é‹è¼¸éƒ¨é–€', 'è¾²æ¥­éƒ¨é–€', 'æœå‹™æ¥­éƒ¨é–€',
        'ä½å®…éƒ¨é–€', 'è½‰æ›æ•ˆç‡æå¤±', 'å•†æ¥­éƒ¨é–€'
    }

    print(f"\nğŸ¢ éæ¿¾åˆ°éƒ¨é–€å±¤ç´š...")

    filtered_data = []
    removed_count = 0

    for _, row in data.iterrows():
        source = row['Source']
        target = row['Target']

        # ç§»é™¤çš„æ¢ä»¶ï¼šsource æ˜¯éƒ¨é–€ï¼Œtarget æ˜¯è©²éƒ¨é–€çš„å­åˆ†é¡
        should_remove = False

        if source in department_level:
            # å¦‚æœä¾†æºæ˜¯éƒ¨é–€ï¼Œæª¢æŸ¥ç›®æ¨™æ˜¯å¦ç‚ºè©²éƒ¨é–€çš„å­åˆ†é¡
            # å­åˆ†é¡é€šå¸¸åŒ…å«æ‹¬è™Ÿã€ç‰¹å®šé—œéµå­—ï¼Œæˆ–ä¸æ˜¯å…¶ä»–éƒ¨é–€
            if target not in department_level:
                # ç›®æ¨™ä¸æ˜¯éƒ¨é–€ç´šåˆ¥ï¼Œå¾ˆå¯èƒ½æ˜¯å­åˆ†é¡
                should_remove = True

        if should_remove:
            removed_count += 1
        else:
            filtered_data.append(row)

    if removed_count > 0:
        filtered_df = pd.DataFrame(filtered_data)
        print(f"  ç§»é™¤äº† {removed_count} ç­†éƒ¨é–€å­åˆ†é¡æµå‘")
        print(f"  ä¿ç•™äº† {len(filtered_df)} ç­†éƒ¨é–€ç´šåˆ¥æµå‘")
        return filtered_df
    else:
        print(f"  è³‡æ–™å·²æ˜¯éƒ¨é–€ç´šåˆ¥ï¼Œç„¡éœ€éæ¿¾")
        return data


def ask_department_level():
    """è©¢å•ä½¿ç”¨è€…æ˜¯å¦åªä¿ç•™åˆ°éƒ¨é–€å±¤ç´š"""
    print("\nğŸ¤” æ˜¯å¦åªåˆ†æåˆ°éƒ¨é–€å±¤ç´šï¼Ÿ")
    print("   éƒ¨é–€å±¤ç´šåŒ…æ‹¬ï¼šå·¥æ¥­éƒ¨é–€ã€é‹è¼¸éƒ¨é–€ã€è¾²æ¥­éƒ¨é–€ã€æœå‹™æ¥­éƒ¨é–€ã€ä½å®…éƒ¨é–€ã€è½‰æ›æ•ˆç‡æå¤±ç­‰")
    print("   é¸æ“‡ã€Œæ˜¯ã€å°‡ä¸æœƒé¡¯ç¤ºéƒ¨é–€ä¸‹çš„å­åˆ†é¡ï¼ˆå¦‚å…¬è·¯é‹è¼¸ã€é‹¼éµæ¥­ç­‰ï¼‰")

    while True:
        choice = input("è«‹é¸æ“‡ (y/n): ").strip().lower()
        if choice in ['y', 'yes', 'æ˜¯', 'è¦']:
            return True
        elif choice in ['n', 'no', 'å¦', 'ä¸è¦']:
            return False
        else:
            print("âŒ è«‹è¼¸å…¥ y/n")


def ask_department_level():
    """è©¢å•ä½¿ç”¨è€…æ˜¯å¦åªä¿ç•™åˆ°éƒ¨é–€å±¤ç´š"""
    print("\nğŸ¤” æ˜¯å¦åªåˆ†æåˆ°éƒ¨é–€å±¤ç´šï¼Ÿ")
    print("   éƒ¨é–€å±¤ç´šåŒ…æ‹¬ï¼šå·¥æ¥­éƒ¨é–€ã€é‹è¼¸éƒ¨é–€ã€è¾²æ¥­éƒ¨é–€ã€æœå‹™æ¥­éƒ¨é–€ã€ä½å®…éƒ¨é–€ã€è½‰æ›æ•ˆç‡æå¤±ç­‰")
    print("   é¸æ“‡ã€Œæ˜¯ã€å°‡ä¸æœƒé¡¯ç¤ºæ›´ç´°çš„å­åˆ†é¡ï¼ˆå¦‚å…¬è·¯é‹è¼¸ã€é‹¼éµæ¥­ç­‰ï¼‰")

    while True:
        choice = input("è«‹é¸æ“‡ (y/n): ").strip().lower()
        if choice in ['y', 'yes', 'æ˜¯', 'è¦']:
            return True
        elif choice in ['n', 'no', 'å¦', 'ä¸è¦']:
            return False
        else:
            print("âŒ è«‹è¼¸å…¥ y/n")


import pandas as pd
from pyecharts import options as opts
from pyecharts.charts import Sankey
import os
from pathlib import Path
import glob
import re


def find_available_years():
    """å°‹æ‰¾æ‰€æœ‰å¯ç”¨çš„å¹´ä»½æª”æ¡ˆ"""
    available_files = []

    # æœå°‹ template + å¹´ä»½çš„æª”æ¡ˆ (åƒ…CSV)
    patterns = [
        'template*.csv'
    ]

    for pattern in patterns:
        files = glob.glob(pattern)
        for file in files:
            # æå–å¹´ä»½
            match = re.search(r'template(\d{2,4})', file)
            if match:
                year = match.group(1)
                # å¦‚æœæ˜¯2ä½æ•¸å¹´ä»½ï¼Œè½‰æ›ç‚º4ä½æ•¸ï¼ˆå‡è¨­æ˜¯æ°‘åœ‹å¹´ä»½ï¼‰
                if len(year) == 2:
                    year_int = int(year)
                    if year_int >= 50:  # æ°‘åœ‹50å¹´ä»¥å¾Œ
                        year_4digit = str(1911 + year_int)
                    else:  # æ°‘åœ‹100å¹´ä»¥å¾Œ
                        year_4digit = str(2011 + year_int)
                elif len(year) == 3:
                    # æ°‘åœ‹å¹´è½‰è¥¿å…ƒå¹´
                    year_4digit = str(1911 + int(year))
                else:
                    year_4digit = year

                available_files.append({
                    'file': file,
                    'year': year,
                    'year_4digit': year_4digit,
                    'display': f"{year_4digit}å¹´ (æª”æ¡ˆ: {file})"
                })

    # æŒ‰å¹´ä»½æ’åº
    available_files.sort(key=lambda x: x['year_4digit'])
    return available_files


def select_year_file():
    """è®“ä½¿ç”¨è€…é¸æ“‡å¹´ä»½æª”æ¡ˆ"""
    available_files = find_available_years()

    if not available_files:
        print("âŒ æ‰¾ä¸åˆ°ä»»ä½•å¹´ä»½æª”æ¡ˆï¼")
        print("è«‹ç¢ºä¿æª”æ¡ˆåç¨±æ ¼å¼ç‚ºï¼štemplate + å¹´ä»½ + å‰¯æª”å")
        print("ä¾‹å¦‚ï¼štemplate108.csv, template2023.csv ç­‰")
        return None

    print("ğŸ“‚ æ‰¾åˆ°ä»¥ä¸‹å¹´ä»½çš„èƒ½æºè³‡æ–™æª”æ¡ˆï¼š")
    print("-" * 50)

    for i, file_info in enumerate(available_files, 1):
        print(f"  {i}. {file_info['display']}")

    print("-" * 50)

    while True:
        try:
            choice = input(f"è«‹é¸æ“‡è¦åˆ†æçš„å¹´ä»½ (1-{len(available_files)}) æˆ–è¼¸å…¥ 'q' é›¢é–‹: ").strip()

            if choice.lower() == 'q':
                print("ğŸ‘‹ å†è¦‹ï¼")
                return None

            choice_num = int(choice)
            if 1 <= choice_num <= len(available_files):
                selected_file = available_files[choice_num - 1]
                print(f"âœ… å·²é¸æ“‡ï¼š{selected_file['display']}")
                return selected_file['file'], selected_file['year_4digit']
            else:
                print(f"âŒ è«‹è¼¸å…¥ 1 åˆ° {len(available_files)} ä¹‹é–“çš„æ•¸å­—")
        except ValueError:
            print("âŒ è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸å­—")
        except KeyboardInterrupt:
            print("\nğŸ‘‹ ç¨‹å¼å·²ä¸­æ–·")
            return None


def read_csv_with_encoding(file_path):
    """å˜—è©¦å¤šç¨®ç·¨ç¢¼è®€å–CSVæª”æ¡ˆ"""
    encodings = ['big5', 'cp950', 'gbk', 'utf-8', 'utf-8-sig']

    print(f"ğŸ”„ æ­£åœ¨è®€å–æª”æ¡ˆï¼š{file_path}")

    # æª¢æŸ¥æª”æ¡ˆæ˜¯å¦å­˜åœ¨
    if not Path(file_path).exists():
        print(f"âŒ æ‰¾ä¸åˆ°æª”æ¡ˆï¼š{file_path}")
        return None

    # åˆ¤æ–·æª”æ¡ˆé¡å‹
    file_extension = Path(file_path).suffix.lower()

    if file_extension == '.csv':
        # å˜—è©¦ä¸åŒç·¨ç¢¼è®€å–CSV
        for encoding in encodings:
            try:
                data = pd.read_csv(file_path, encoding=encoding)
                print(f"âœ… ä½¿ç”¨ {encoding} ç·¨ç¢¼æˆåŠŸï¼")
                return data
            except UnicodeDecodeError as e:
                print(f"âŒ {encoding} ç·¨ç¢¼å¤±æ•—ï¼š{e}")
                continue
            except Exception as e:
                print(f"âŒ {encoding} è®€å–éŒ¯èª¤ï¼š{e}")
                continue
    else:
        print(f"âŒ ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼ï¼š{file_extension}")
        print("åƒ…æ”¯æ´æ ¼å¼ï¼š.csv")
        return None

    print("âŒ æ‰€æœ‰è®€å–æ–¹å¼éƒ½å¤±æ•—ï¼")
    return None


def clean_energy_data(data):
    """æ¸…ç†èƒ½æºè³‡æ–™"""
    print("\nğŸ“Š åŸå§‹è³‡æ–™è³‡è¨Šï¼š")
    print(f"  è³‡æ–™å½¢ç‹€ï¼š{data.shape}")
    print(f"  æ¬„ä½åç¨±ï¼š{data.columns.tolist()}")

    # é¡¯ç¤ºå‰å¹¾è¡Œè³‡æ–™
    print("\nå‰5è¡Œè³‡æ–™ï¼š")
    print(data.head())

    # æª¢æŸ¥å¿…è¦æ¬„ä½æ˜¯å¦å­˜åœ¨
    required_columns = ['Source', 'Target', 'Value(KLOE)']
    missing_columns = [col for col in required_columns if col not in data.columns]

    if missing_columns:
        print(f"âŒ ç¼ºå°‘å¿…è¦æ¬„ä½ï¼š{missing_columns}")
        return None

    # æ¸…ç†è³‡æ–™
    clean_data = data.copy()

    # ç§»é™¤ç©ºå€¼è¡Œå’Œç©ºç™½Source/Target
    initial_count = len(clean_data)
    clean_data = clean_data.dropna(subset=['Source', 'Target'])
    clean_data = clean_data[clean_data['Source'].str.strip() != '']
    clean_data = clean_data[clean_data['Target'].str.strip() != '']

    # ç§»é™¤Valueç‚ºç©ºå€¼æˆ–å°æ–¼ç­‰æ–¼0çš„è¡Œ
    clean_data = clean_data.dropna(subset=['Value(KLOE)'])
    clean_data = clean_data[clean_data['Value(KLOE)'] > 0]

    # å»é™¤Sourceå’ŒTargetçš„å‰å¾Œç©ºç™½
    clean_data['Source'] = clean_data['Source'].str.strip()
    clean_data['Target'] = clean_data['Target'].str.strip()

    final_count = len(clean_data)
    print(f"\nğŸ§¹ è³‡æ–™æ¸…ç†çµæœï¼š")
    print(f"  åŸå§‹è³‡æ–™ï¼š{initial_count:,} ç­†")
    print(f"  æ¸…ç†å¾Œï¼š{final_count:,} ç­†")
    print(f"  ç§»é™¤ï¼š{initial_count - final_count:,} ç­†ç„¡æ•ˆè³‡æ–™")

    # æŒ‰æ•¸å€¼å¤§å°æ’åº
    clean_data = clean_data.sort_values('Value(KLOE)', ascending=False)

    return clean_data


def display_top_flows(data, top_n=10):
    """é¡¯ç¤ºå‰Nå¤§èƒ½æºæµå‘"""
    print(f"\nğŸ”¥ å‰{top_n}å¤§èƒ½æºæµå‘ï¼š")
    for i, (_, row) in enumerate(data.head(top_n).iterrows(), 1):
        source = row['Source']
        target = row['Target']
        value = row['Value(KLOE)']
        print(f"  {i:2d}. {source} â†’ {target}: {value:,.0f} KLOE")


def prepare_sankey_data(data):
    """æº–å‚™æ¡‘åŸºåœ–æ‰€éœ€çš„ç¯€é»å’Œé€£çµè³‡æ–™"""
    # å–å¾—æ‰€æœ‰å”¯ä¸€çš„ç¯€é»
    unique_nodes = set(data['Source']).union(set(data['Target']))
    nodes = [{"name": node} for node in sorted(unique_nodes)]

    print(f"\nğŸŒ ç¯€é»æ•¸é‡ï¼š{len(nodes)}")
    print("ç¯€é»åˆ—è¡¨ï¼š")
    for i, node in enumerate(sorted(unique_nodes), 1):
        print(f"  {i:2d}. {node}")

    # å»ºç«‹é€£çµ
    links = []
    for _, row in data.iterrows():
        # ä½¿ç”¨ KLOE å€¼ï¼Œå¦‚æœæœ‰ kKLOE æ¬„ä½å‰‡å„ªå…ˆä½¿ç”¨
        if 'Value(kKLOE)' in data.columns and pd.notna(row['Value(kKLOE)']):
            value = float(row['Value(kKLOE)'])
        else:
            # å°‡ KLOE è½‰æ›ç‚º kKLOE (é™¤ä»¥1000)
            value = float(row['Value(KLOE)'] / 1000)

        links.append({
            "source": row['Source'],
            "target": row['Target'],
            "value": value
        })

    print(f"ğŸ”— é€£çµæ•¸é‡ï¼š{len(links)}")

    return nodes, links


def create_sankey_chart(nodes, links, year, output_file):
    """å»ºç«‹æ¡‘åŸºåœ–"""
    sankey = (
        Sankey(init_opts=opts.InitOpts(
            width="1400px",
            height="900px",  # å¢åŠ é«˜åº¦ä»¥å®¹ç´æ¨™é¡Œ
            theme='westeros'
        ))
        .add(
            f"å°ç£èƒ½æºæµå‘ ({year}å¹´)",
            nodes=nodes,
            links=links,
            linestyle_opt=opts.LineStyleOpts(
                opacity=0.3,
                curve=0.5,
                color="source"
            ),
            label_opts=opts.LabelOpts(
                position="right",
                font_size=12,
                distance=8
            ),
            node_gap=20,
            pos_top="80px",  # å°‡æ¡‘åŸºåœ–å¾€ä¸‹ç§»ï¼Œé¿å…èˆ‡æ¨™é¡Œé‡ç–Š
            pos_bottom="60px"  # åº•éƒ¨ç•™ç©ºé–“çµ¦åœ–ä¾‹
        )
        .set_global_opts(
            title_opts=opts.TitleOpts(
                title=f"å°ç£èƒ½æºæµå‘åœ– ({year}å¹´)",
                subtitle="è³‡æ–™ä¾†æºï¼šèƒ½æºçµ±è¨ˆè³‡æ–™ | å–®ä½ï¼šåƒå…¬å™¸æ²¹ç•¶é‡",
                title_textstyle_opts=opts.TextStyleOpts(font_size=18),
                subtitle_textstyle_opts=opts.TextStyleOpts(font_size=12),
                pos_top="10px",  # æ¨™é¡Œæ›´é è¿‘é ‚éƒ¨
                pos_left="center"  # æ¨™é¡Œç½®ä¸­
            ),
            legend_opts=opts.LegendOpts(
                orient="horizontal",
                pos_top="bottom",
                pos_left="center"
            )
        )
    )

    # ç”¢ç”Ÿåœ–è¡¨
    sankey.render(output_file)
    return output_file


def display_statistics(data, year):
    """é¡¯ç¤ºçµ±è¨ˆè³‡è¨Š"""
    total_energy = data['Value(KLOE)'].sum()
    top_flow = data.iloc[0]

    print(f"\nğŸ“ˆ {year}å¹´çµ±è¨ˆè³‡è¨Šï¼š")
    print(f"  ç¸½èƒ½æºæµé‡ï¼š{total_energy:,.0f} å…¬å™¸æ²¹ç•¶é‡")
    print(f"  ä¸»è¦èƒ½æºä¾†æºï¼š{top_flow['Source']}")
    print(f"  æœ€å¤§æµå‘ï¼š{top_flow['Source']} â†’ {top_flow['Target']}")
    print(f"  æœ€å¤§æµé‡ï¼š{top_flow['Value(KLOE)']:,.0f} å…¬å™¸æ²¹ç•¶é‡")

    # é¡å¤–çµ±è¨ˆ
    print(f"  èƒ½æºä¾†æºç¨®é¡ï¼š{data['Source'].nunique()} ç¨®")
    print(f"  èƒ½æºå»å‘ç¨®é¡ï¼š{data['Target'].nunique()} ç¨®")
    print(f"  å¹³å‡æµé‡ï¼š{data['Value(KLOE)'].mean():,.0f} å…¬å™¸æ²¹ç•¶é‡")


def main():
    """ä¸»è¦åŸ·è¡Œå‡½æ•¸"""
    print("=" * 60)
    print("ğŸŒŸ å°ç£èƒ½æºæµå‘æ¡‘åŸºåœ–ç”Ÿæˆå™¨ - å¹´ä»½é¸æ“‡ç‰ˆ ğŸŒŸ")
    print("=" * 60)

    # é¸æ“‡å¹´ä»½æª”æ¡ˆ
    result = select_year_file()
    if result is None:
        return

    file_path, year = result

    # è®€å–è³‡æ–™
    data = read_csv_with_encoding(file_path)
    if data is None:
        return

    # æ¸…ç†è³‡æ–™
    clean_data = clean_energy_data(data)
    if clean_data is None or len(clean_data) == 0:
        print("âŒ æ²’æœ‰æœ‰æ•ˆçš„è³‡æ–™å¯ä»¥è™•ç†ï¼")
        return

    # è©¢å•æ˜¯å¦åªä¿ç•™åˆ°éƒ¨é–€å±¤ç´š
    use_department_level = ask_department_level()

    if use_department_level:
        final_data = filter_to_department_level(clean_data)
        print("âœ… ä½¿ç”¨éƒ¨é–€å±¤ç´šè³‡æ–™")
        output_file = f"taiwan_energy_sankey_{year}_department.html"
    else:
        final_data = clean_data
        print("âœ… ä½¿ç”¨å®Œæ•´è³‡æ–™ï¼ˆåŒ…å«å­åˆ†é¡ï¼‰")
        output_file = f"taiwan_energy_sankey_{year}_detailed.html"

    # é¡¯ç¤ºå‰å¹¾å¤§æµå‘
    display_top_flows(final_data)

    # æº–å‚™æ¡‘åŸºåœ–è³‡æ–™
    nodes, links = prepare_sankey_data(final_data)

    # å»ºç«‹æ¡‘åŸºåœ–
    create_sankey_chart(nodes, links, year, output_file)

    print(f"\nğŸ‰ {year}å¹´æ¡‘åŸºåœ–å·²æˆåŠŸç”¢ç”Ÿï¼")
    print(f"ğŸ“ æª”æ¡ˆå„²å­˜ç‚ºï¼š{output_file}")
    print(f"ğŸŒ è«‹ç”¨ç€è¦½å™¨é–‹å•Ÿé€™å€‹æª”æ¡ˆæŸ¥çœ‹äº’å‹•å¼åœ–è¡¨ï¼")

    # é¡¯ç¤ºçµ±è¨ˆè³‡è¨Š
    display_statistics(final_data, year)


# åŸ·è¡Œä¸»ç¨‹å¼
if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\nğŸ‘‹ ç¨‹å¼å·²ä¸­æ–·")
    except Exception as e:
        print(f"\nâŒ ç¨‹å¼åŸ·è¡ŒéŒ¯èª¤ï¼š{e}")
        print("è«‹æª¢æŸ¥æª”æ¡ˆæ ¼å¼å’Œå…§å®¹æ˜¯å¦æ­£ç¢º")
