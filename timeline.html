<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å°ç£èƒ½æºæµå‘æ™‚é–“è»¸è¦–è¦ºåŒ–</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
    font-family:'Microsoft JhengHei','Segoe UI',Arial,sans-serif;
    background:linear-gradient(135deg,#0f172a 0%,#1e293b 50%,#064e3b 100%);
    color:white;
    min-height:100vh;
    padding:20px;
}
.container{max-width:1400px;margin:0 auto;}
.header{text-align:center;margin-bottom:30px;}
.header h1{
    font-size:2.5em;
    background:linear-gradient(to right,#60a5fa,#34d399);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
}
.header p{color:#cbd5e1;font-size:1.2em;}
.timeline-container{text-align:center;margin-bottom:20px;}
.timeline-container input[type="range"]{
    width:80%;
    -webkit-appearance:none;
    height:10px;
    background:#334155;
    border-radius:5px;
    outline:none;
}
.timeline-container input[type="range"]::-webkit-slider-thumb{
    -webkit-appearance:none;
    width:20px;height:20px;
    border-radius:50%;
    background:#fff;
    cursor:pointer;
    box-shadow:0 0 6px rgba(0,0,0,0.3);
}
.year-labels{display:flex;justify-content:space-between;width:80%;margin:auto;margin-top:10px;font-size:14px;}
.year-label{cursor:pointer;transition:color 0.3s;}
.year-label:hover{color:#60a5fa;}
.year-display{font-size:2em;margin-bottom:10px;}
#sankeyChart{width:100%;height:700px;border-radius:20px;}
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>ğŸŒ¿ å°ç£èƒ½æºæµå‘è¦–è¦ºåŒ–</h1>
        <p>ä»¥æ™‚é–“è»¸æ¢ç´¢èƒ½æºæµè®ŠåŒ–</p>
    </div>
    <div class="timeline-container">
        <div class="year-display" id="yearDisplay">è¼‰å…¥ä¸­...</div>
        <input type="range" id="timelineSlider" min="0" max="0" value="0">
        <div class="year-labels" id="yearLabels"></div>
    </div>
    <div id="sankeyChart"></div>
</div>

<script>
// âš¡ ä½ çš„ GitHub raw æª”æ¡ˆç¶²å€ (æ”¹æˆä½ è‡ªå·±çš„ Repo)
const repoBase = 'https://raw.githubusercontent.com/ryan34861810-art/energyflow/main/';
const startIdx = 73;
const endIdx = 113;

// âš¡ é™å®šé¡¯ç¤ºçš„éƒ¨é–€
const departmentLevel = new Set([
    'å·¥æ¥­éƒ¨é–€','é‹è¼¸éƒ¨é–€','è¾²æ¥­éƒ¨é–€','æœå‹™æ¥­éƒ¨é–€',
    'ä½å®…éƒ¨é–€','è½‰æ›æ•ˆç‡æå¤±','å•†æ¥­éƒ¨é–€'
]);

let state = {
    files: {},
    years: [],
    currentYear: null,
    chart: echarts.init(document.getElementById('sankeyChart'))
};

// ğŸš€ æŠ“å–å–®ä¸€ CSV
async function fetchCSV(yearIndex) {
    const filename = `template${String(yearIndex).padStart(3, '0')}.csv`;
    const url = repoBase + filename;
    try {
        const res = await fetch(url);
        if (!res.ok) throw new Error('not found');
        const text = await res.text();
        return text;
    } catch (err) {
        console.log(`âš ï¸ æ‰¾ä¸åˆ° ${filename}ï¼Œå·²è·³é`);
        return null;
    }
}

// ğŸš€ è¼‰å…¥æ‰€æœ‰å¹´ä»½ CSV
async function loadAllCSVs() {
    for (let i = startIdx; i <= endIdx; i++) {
        const text = await fetchCSV(i);
        if (text) {
            const year = 2000 + i;
            state.files[year] = text;
        }
    }
    state.years = Object.keys(state.files).sort();
    if (state.years.length > 0) {
        state.currentYear = state.years[0];
        buildTimelineUI();
        updateChart();
    } else {
        document.getElementById('yearDisplay').textContent = 'âŒ æ²’æœ‰è®€åˆ°ä»»ä½•è³‡æ–™';
    }
}

// ğŸš€ è§£æ CSV æ–‡å­—æˆè³‡æ–™é™£åˆ—
function parseCSV(text) {
    const lines = text.trim().split('\n');
    const headers = lines[0].split(',').map(h => h.trim());
    const result = [];
    for (let i = 1; i < lines.length; i++) {
        const cols = lines[i].split(',');
        if (cols.length >= 3) {
            const row = {};
            headers.forEach((h, idx) => row[h] = cols[idx] ? cols[idx].trim() : '');
            result.push(row);
        }
    }
    return result;
}

// ğŸš€ éæ¿¾éƒ¨é–€å±¤ç´š
function filterToDepartmentLevel(data) {
    return data.filter(row =>
        departmentLevel.has(row.Source) && departmentLevel.has(row.Target)
    );
}

// ğŸš€ æ›´æ–°åœ–è¡¨
function updateChart() {
    const year = state.currentYear;
    const text = state.files[year];
    if (!text) return;

    let data = parseCSV(text);
    data = data.filter(d => d.Source && d.Target && !isNaN(parseFloat(d['Value(KLOE)'])) && parseFloat(d['Value(KLOE)']) > 0);
    data = filterToDepartmentLevel(data);

    const nodesSet = new Set();
    const links = [];
    data.forEach(d => {
        nodesSet.add(d.Source);
        nodesSet.add(d.Target);
        links.push({
            source: d.Source,
            target: d.Target,
            value: parseFloat(d['Value(KLOE)']) / 1000
        });
    });

    const nodes = Array.from(nodesSet).map(n => ({ name: n }));

    state.chart.setOption({
        tooltip: {
            trigger: 'item',
            triggerOn: 'mousemove',
            formatter: p => p.dataType === 'edge'
                ? `${p.data.source} â†’ ${p.data.target}<br/>æµé‡: ${p.value.toFixed(1)} kKLOE`
                : p.name
        },
        series: [{
            type: 'sankey',
            layout: 'none',
            emphasis: { focus: 'adjacency' },
            data: nodes,
            links: links,
            lineStyle: { color: 'gradient', curveness: 0.5, opacity: 0.4 },
            label: { color: '#fff', fontSize: 12 }
        }]
    });
    document.getElementById('yearDisplay').textContent = year + ' å¹´';
}

// ğŸš€ å»ºæ§‹æ™‚é–“è»¸ UI
function buildTimelineUI() {
    const slider = document.getElementById('timelineSlider');
    slider.max = state.years.length - 1;
    slider.value = 0;

    const labelsDiv = document.getElementById('yearLabels');
    labelsDiv.innerHTML = state.years.map(y => `<span class="year-label" data-year="${y}">${y}</span>`).join('');

    document.querySelectorAll('.year-label').forEach(label => {
        label.addEventListener('click', () => {
            state.currentYear = label.dataset.year;
            slider.value = state.years.indexOf(state.currentYear);
            updateChart();
        });
    });

    slider.addEventListener('input', e => {
        state.currentYear = state.years[e.target.value];
        updateChart();
    });
}

// ğŸš€ ç¸®æ”¾äº‹ä»¶
window.addEventListener('resize', () => {
    state.chart.resize();
});

// ğŸš€ å•Ÿå‹•
loadAllCSVs();
</script>
</body>
</html>
