import pandas as pd
from pyecharts import options as opts
from pyecharts.charts import Sankey, Tab
import glob
import re
from pathlib import Path

# ------------------- éæ¿¾éƒ¨é–€å±¤ç´š -------------------
def filter_to_department_level(data):
    department_level = {
        'å·¥æ¥­éƒ¨é–€', 'é‹è¼¸éƒ¨é–€', 'è¾²æ¥­éƒ¨é–€', 'æœå‹™æ¥­éƒ¨é–€',
        'ä½å®…éƒ¨é–€', 'è½‰æ›æ•ˆç‡æå¤±', 'å•†æ¥­éƒ¨é–€'
    }

    filtered_data = []
    for _, row in data.iterrows():
        source, target = row['Source'], row['Target']
        if source in department_level and target not in department_level:
            continue
        filtered_data.append(row)
    return pd.DataFrame(filtered_data)

# ------------------- è®€å– CSV -------------------
def read_csv(file_path):
    encodings = ['utf-8-sig', 'utf-8', 'big5', 'cp950', 'gbk']
    for enc in encodings:
        try:
            return pd.read_csv(file_path, encoding=enc)
        except:
            continue
    print(f"âŒ ç„¡æ³•è®€å– {file_path}")
    return None

# ------------------- æº–å‚™æ¡‘åŸºåœ–è³‡æ–™ -------------------
def prepare_sankey_data(data):
    nodes = [{"name": n} for n in sorted(set(data['Source']).union(set(data['Target'])))]
    links = []
    for _, row in data.iterrows():
        value = float(row['Value(KLOE)']/1000)
        links.append({"source": row['Source'], "target": row['Target'], "value": value})
    return nodes, links

# ------------------- ç”Ÿæˆå–®å¹´æ¡‘åŸºåœ– -------------------
def create_sankey_chart(nodes, links, year):
    return (
        Sankey(init_opts=opts.InitOpts(width="1200px", height="700px", theme='westeros'))
        .add(
            series_name=f"{year}å¹´èƒ½æºæµå‘",
            nodes=nodes,
            links=links,
            linestyle_opt=opts.LineStyleOpts(opacity=0.3, curve=0.5, color="source"),
            label_opts=opts.LabelOpts(position="right", font_size=12),
            node_gap=20
        )
        .set_global_opts(
            title_opts=opts.TitleOpts(
                title=f"å°ç£èƒ½æºæµå‘åœ– ({year}å¹´)",
                subtitle="è³‡æ–™ä¾†æºï¼šèƒ½æºçµ±è¨ˆè³‡æ–™ | å–®ä½ï¼šåƒå…¬å™¸æ²¹ç•¶é‡",
                pos_top="10px",
                pos_left="center",
                title_textstyle_opts=opts.TextStyleOpts(font_size=18),
                subtitle_textstyle_opts=opts.TextStyleOpts(font_size=12)
            ),
            legend_opts=opts.LegendOpts(orient="horizontal", pos_top="bottom", pos_left="center")
        )
    )

# ------------------- ä¸»ç¨‹å¼ -------------------
def main():
    tab = Tab()
    csv_files = glob.glob("template*.csv")
    csv_files.sort()

    for file_path in csv_files:
        match = re.search(r'template(\d+)', file_path)
        if not match:
            continue
        year_raw = match.group(1)
        year = str(int(year_raw)+1911) if len(year_raw)<=3 else year_raw  # æ°‘åœ‹è½‰è¥¿å…ƒ

        data = read_csv(file_path)
        if data is None or 'Source' not in data.columns or 'Target' not in data.columns or 'Value(KLOE)' not in data.columns:
            continue

        # éæ¿¾éƒ¨é–€å±¤ç´š
        data = filter_to_department_level(data)

        nodes, links = prepare_sankey_data(data)
        sankey_chart = create_sankey_chart(nodes, links, year)

        tab.add(sankey_chart, f"{year}å¹´")

    if len(tab.options) == 0:
        print("âŒ æ²’æœ‰æœ‰æ•ˆçš„è³‡æ–™å¯ç”Ÿæˆåœ–è¡¨")
        return

    output_file = "taiwan_energy_sankey_multi_year.html"
    tab.render(output_file)
    print(f"ğŸ‰ æˆåŠŸç”Ÿæˆå¤šå¹´ä»½äº’å‹•æ¡‘åŸºåœ– HTMLï¼š{output_file}")

if __name__ == "__main__":
    main()
