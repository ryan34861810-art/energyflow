<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å°ç£èƒ½æºæµå‘æ¡‘åŸºåœ– - æ™‚é–“è»¸ç‰ˆ</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body {
    font-family:'Microsoft JhengHei','Segoe UI',Arial,sans-serif;
    background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #064e3b 100%);
    min-height:100vh; padding:20px; color:white;
}
.container { max-width:1400px; margin:0 auto; }
.header { text-align:center; margin-bottom:30px; }
.header h1 {
    font-size:3em;
    background: linear-gradient(to right, #60a5fa, #34d399);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
.header p { color:#cbd5e1; font-size:1.2em; }
.timeline-container { margin-bottom: 30px; text-align:center; }
.timeline-container input[type="range"] {
    width: 80%; height: 12px; border-radius:6px; outline:none; -webkit-appearance:none; cursor:pointer;
}
.timeline-container input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance:none; width:24px; height:24px; border-radius:50%; background:white; cursor:pointer;
    box-shadow:0 2px 8px rgba(0,0,0,0.3);
}
.year-labels { display:flex; justify-content:space-between; margin-top:10px; font-size:14px; width:80%; margin:auto; }
.year-label { cursor:pointer; transition:color 0.3s; }
.year-label:hover { color:#60a5fa; }
.year-display { font-size:2em; margin-top:10px; margin-bottom:10px; }
#sankeyChart { width:100%; height:700px; border-radius:20px; }
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>ğŸŒŸ å°ç£èƒ½æºæµå‘æ¡‘åŸºåœ–</h1>
        <p>äº’å‹•å¼æ™‚é–“è»¸æ¢ç´¢èƒ½æºæµå‹•</p>
    </div>

    <div class="timeline-container">
        <div class="year-display" id="yearDisplay">å¹´ä»½</div>
        <input type="range" id="timelineSlider" min="0" max="0" value="0">
        <div class="year-labels" id="yearLabels"></div>
    </div>

    <div id="sankeyChart"></div>
</div>

<script>
const repoRawBase = 'https://raw.githubusercontent.com/ryan34861810-art/energyflow/main/';
const start = 73, end = 113;
const departmentLevel = new Set([
    'å·¥æ¥­éƒ¨é–€','é‹è¼¸éƒ¨é–€','è¾²æ¥­éƒ¨é–€','æœå‹™æ¥­éƒ¨é–€','ä½å®…éƒ¨é–€','è½‰æ›æ•ˆç‡æå¤±','å•†æ¥­éƒ¨é–€'
]);

let state = { files:{}, years:[], currentYear:null, chart:null };

state.chart = echarts.init(document.getElementById('sankeyChart'));

async function fetchCSV(year){
    const url = repoRawBase + `template${String(year).padStart(3,'0')}.csv`;
    try{
        const res = await fetch(url);
        if(!res.ok) throw 'not found';
        return await res.text();
    }catch(e){
        console.log(`template${String(year).padStart(3,'0')}.csv è·³é`);
        return null;
    }
}

async function loadAllCSVs(){
    for(let y=start; y<=end; y++){
        const text = await fetchCSV(y);
        if(text) state.files[2000+y] = text;
    }
    state.years = Object.keys(state.files).sort();
    if(state.years.length>0){
        state.currentYear = state.years[0];
        updateUI();
        updateChart();
    }
}

function parseCSV(text){
    const lines = text.trim().split('\n');
    const headers = lines[0].split(',').map(h=>h.trim());
    let data=[];
    for(let i=1;i<lines.length;i++){
        const values = lines[i].split(',');
        if(values.length>=3){
            let row={};
            headers.forEach((h,index)=>row[h]=values[index]?values[index].trim():'');
            data.push(row);
        }
    }
    return data;
}

function filterToDepartmentLevel(data){
    return data.filter(r=>departmentLevel.has(r.Source) && departmentLevel.has(r.Target));
}

function updateChart(){
    if(!state.currentYear) return;
    let data=parseCSV(state.files[state.currentYear]);
    data = data.filter(r=>r.Source && r.Target && !isNaN(parseFloat(r['Value(KLOE)'])) && parseFloat(r['Value(KLOE)'])>0);
    data = filterToDepartmentLevel(data);

    let nodes = new Set(), links=[];
    data.forEach(r=>{
        nodes.add(r.Source); nodes.add(r.Target);
        links.push({ source:r.Source, target:r.Target, value: parseFloat(r['Value(KLOE)'])/1000 });
    });

    state.chart.setOption({
        tooltip: {
            trigger:'item',
            triggerOn:'mousemove',
            formatter: p => p.dataType==='edge'? `${p.data.source} â†’ ${p.data.target}<br/>æµé‡: ${p.value.toFixed(1)} kKLOE` : p.name
        },
        series:[{
            type:'sankey',
            layout:'none',
            emphasis:{ focus:'adjacency' },
            data:Array.from(nodes).map(n=>({name:n})),
            links:links,
            lineStyle:{ color:'gradient', curveness:0.5, opacity:0.4 },
            label:{ color:'#fff', fontSize:12 }
        }]
    }, true);
}

function updateUI(){
    document.getElementById('yearDisplay').textContent = state.currentYear + 'å¹´';
    const slider = document.getElementById('timelineSlider');
    slider.max = state.years.length-1;
    slider.value = state.years.indexOf(state.currentYear);
    const percent = slider.value/(slider.max||1)*100;
    slider.style.background=`linear-gradient(to right, #3b82f6 0%, #3b82f6 ${percent}%, rgba(255,255,255,0.2) ${percent}%, rgba(255,255,255,0.2) 100%)`;

    const labelsDiv = document.getElementById('yearLabels');
    labelsDiv.innerHTML = state.years.map(y=>`<span class="year-label" data-year="${y}">${y}</span>`).join('');
    document.querySelectorAll('.year-label').forEach(l=>{
        l.addEventListener('click',()=>{ state.currentYear = l.dataset.year; updateUI(); updateChart(); });
    });
}

document.getElementById('timelineSlider').addEventListener('input', e=>{
    state.currentYear = state.years[parseInt(e.target.value)];
    updateUI();
    updateChart();
});

window.addEventListener('resize', ()=>{ state.chart.resize(); });

loadAllCSVs();
</script>
</body>
</html>
