<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台灣能源流向桑基圖 - 時間軸版</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <style>
        /* 這裡是你的 CSS 樣式 */
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🌟 台灣能源流向桑基圖</h1>
            <p>互動式時間軸探索能源流動</p>
        </div>

        <div class="control-panel" id="controlPanel">
            <div class="controls-row">
                <div class="controls-left">
                    <button class="btn" id="playBtn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                        </svg>
                        播放
                    </button>
                </div>
                <div class="year-display" id="yearDisplay">年份</div>
            </div>
            <div class="timeline">
                <input type="range" id="timelineSlider" min="0" max="0" value="0">
                <div class="year-labels" id="yearLabels"></div>
            </div>
        </div>

        <div class="stats-grid" id="statsGrid">
            <div class="stat-card blue">
                <div class="stat-label">總能源流量</div>
                <div class="stat-value" id="totalEnergy">0</div>
                <div class="stat-unit">千公噸油當量</div>
            </div>
            <div class="stat-card green">
                <div class="stat-label">能源來源</div>
                <div class="stat-value" id="sourceCount">0</div>
                <div class="stat-unit">種類</div>
            </div>
            <div class="stat-card purple">
                <div class="stat-label">能源去向</div>
                <div class="stat-value" id="targetCount">0</div>
                <div class="stat-unit">種類</div>
            </div>
            <div class="stat-card amber">
                <div class="stat-label">最大流向</div>
                <div class="stat-value" id="topFlow" style="font-size:1.2em;">--</div>
                <div class="stat-unit" id="topFlowTarget">--</div>
            </div>
        </div>

        <div class="chart-container" id="chartContainer">
            <div id="sankeyChart"></div>
        </div>

        <div class="info-box" id="infoBox">
            <strong>📖 使用說明：</strong>
            <ul>
                <li>拖動時間軸或點擊年份切換不同年度資料</li>
                <li>點擊「播放」按鈕自動循環播放所有年份</li>
                <li>桑基圖只顯示部門層級</li>
                <li>滑鼠懸停在連結和節點上查看詳細數值</li>
            </ul>
        </div>
    </div>

    <script>
        var state = {
            files: {},
            years: [],
            currentYear: null,
            isPlaying: false,
            showDepartmentOnly: true,
            chart: null
        };

        var departmentLevel = new Set([
            '工業部門','運輸部門','農業部門','服務業部門',
            '住宅部門','轉換效率損失','商業部門'
        ]);

        state.chart = echarts.init(document.getElementById('sankeyChart'));

        const csvFiles = {};
        for(let i=73;i<=113;i++){
            let numStr=i.toString().padStart(3,'0');
            csvFiles[numStr]=`https://raw.githubusercontent.com/ryan34861810-art/energyflow/main/template${numStr}.csv`;
        }

        async function loadAllCSV(){
            state.years=[];
            for(const year in csvFiles){
                try{
                    const response=await fetch(csvFiles[year]);
                    if(!response.ok) throw new Error('HTTP error '+response.status);
                    const text=await response.text();
                    state.files[year]=text;
                    state.years.push(year);
                }catch(err){
                    console.warn('讀取 CSV 失敗，跳過年份:', year, err);
                }
            }
            state.years.sort();
            if(state.years.length===0){ alert('沒有成功讀取任何年份資料！'); return; }
            state.currentYear=state.years[0];
            updateUI();
            updateChart();
        }

        function parseCSV(text){
            var lines=text.trim().split('\n');
            var headers=lines[0].split(',').map(h=>h.trim());
            var data=[];
            for(var i=1;i<lines.length;i++){
                var values=lines[i].split(',');
                if(values.length>=3){
                    var row={};
                    headers.forEach((h,index)=>{ row[h]=values[index]?values[index].trim():''; });
                    data.push(row);
                }
            }
            return data;
        }

        function filterToDepartmentLevel(data){
            return data.filter(row=>{
                return departmentLevel.has(row.Source)&&departmentLevel.has(row.Target);
            });
        }

        function updateUI(){
            document.getElementById('timelineSlider').max=state.years.length-1;
            document.getElementById('timelineSlider').value=state.years.indexOf(state.currentYear);
            document.getElementById('yearDisplay').textContent=state.currentYear;

            const labelsDiv=document.getElementById('yearLabels');
            labelsDiv.innerHTML='';
            state.years.forEach((y,i)=>{
                let span=document.createElement('span');
                span.className='year-label';
                span.textContent=y;
                span.style.color=(y===state.currentYear)?'#60a5fa':'#fff';
                span.onclick=()=>{ state.currentYear=y; updateUI(); updateChart(); }
                labelsDiv.appendChild(span);
            });
        }

        function updateChart(){
            const csvText=state.files[state.currentYear];
            const parsed=parseCSV(csvText);
            const filtered=filterToDepartmentLevel(parsed);

            const nodes=new Set();
            const links=[];
            filtered.forEach(row=>{
                nodes.add(row.Source); nodes.add(row.Target);
                links.push({source:row.Source,target:row.Target,value:+row.Value});
            });

            const option={
                tooltip:{ trigger:'item', triggerOn:'mousemove', formatter: function(params){ 
                    if(params.value) return `${params.source} → ${params.target}: ${params.value} 千公噸油當量`; 
                    return params.name; 
                }},
                series: [{
                    type:'sankey',
                    data:Array.from(nodes).map(n=>({name:n})),
                    links:links,
                    emphasis:{focus:'adjacency'},
                    lineStyle:{ color:'gradient', curveness:0.5 }
                }]
            };
            state.chart.setOption(option);

            // 更新統計數據
            const totalEnergy=links.reduce((sum,l)=>sum+l.value,0);
            document.getElementById('totalEnergy').textContent=totalEnergy.toLocaleString();
            document.getElementById('sourceCount').textContent=new Set(filtered.map(r=>r.Source)).size;
            document.getElementById('targetCount').textContent=new Set(filtered.map(r=>r.Target)).size;
            if(links.length>0){
                const topLink=links.reduce((max,l)=>l.value>max.value?l:max,links[0]);
                document.getElementById('topFlow').textContent=topLink.value;
                document.getElementById('topFlowTarget').textContent=topLink.Target;
            } else {
                document.getElementById('topFlow').textContent='--';
                document.getElementById('topFlowTarget').textContent='--';
            }
        }

        document.getElementById('timelineSlider').addEventListener('input',function(){
            const idx=parseInt(this.value);
            state.currentYear=state.years[idx];
            updateUI();
            updateChart();
        });

        document.getElementById('playBtn').addEventListener('click',function(){
            if(state.isPlaying){ state.isPlaying=false; this.textContent='▶ 播放'; }
            else{
                state.isPlaying=true;
                this.textContent='⏸ 暫停';
                let idx=state.years.indexOf(state.currentYear);
                function step(){
                    if(!state.isPlaying) return;
                    idx=(idx+1)%state.years.length;
                    state.currentYear=state.years[idx];
                    updateUI(); updateChart();
                    setTimeout(step,1500);
                }
                step();
            }
        });

        window.addEventListener('resize',()=>{ state.chart.resize(); });

        // 初始化
        loadAllCSV();

::contentReference[oaicite:14]{index=14}
 
