<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>能源流視覺化 - Timeline</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; margin: 0; background: #0f172a; color: white; }
        header { text-align: center; padding: 20px; background: #1e293b; }
        header h1 { margin: 0; font-size: 1.8rem; color: #60a5fa; }
        #controls { display: flex; justify-content: center; align-items: center; gap: 10px; margin: 15px 0; }
        #timelineContainer { text-align: center; margin-top: 10px; }
        #chart { width: 100%; height: 80vh; }
        .stats { display: flex; justify-content: center; gap: 20px; margin-top: 15px; color: #cbd5e1; }
        .stat-box { background: #1e293b; padding: 10px 15px; border-radius: 8px; }
        button { background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; }
        button:hover { background: #2563eb; }
        input[type="range"] { width: 300px; }
        #loadingOverlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: #60a5fa;
            font-size: 1.2rem;
        }
        .spinner {
            width: 50px; height: 50px;
            border: 5px solid #1e3a8a;
            border-top: 5px solid #60a5fa;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #errorBox {
            display: none;
            background: #b91c1c;
            color: white;
            text-align: center;
            padding: 12px;
            position: fixed;
            top: 0; left: 0;
            width: 100%;
            z-index: 10000;
        }
    </style>
</head>
<body>
    <div id="errorBox">❌ 資料載入失敗，請稍後再試。</div>
    <div id="loadingOverlay">
        <div class="spinner"></div>
        <div>資料載入中，請稍候...</div>
    </div>

    <header>
        <h1>能源流視覺化 Timeline</h1>
    </header>

    <div id="controls">
        <button id="playBtn">▶ 播放</button>
        <input type="range" id="yearSlider" min="0" max="0" value="0">
        <span id="yearLabel"></span>
        <label><input type="checkbox" id="deptFilter"> 僅顯示部門層級</label>
    </div>

    <div class="stats">
        <div class="stat-box">總能源流量：<span id="totalFlow">0</span> 千公噸油當量</div>
        <div class="stat-box">來源數：<span id="sourceCount">0</span></div>
        <div class="stat-box">去向數：<span id="targetCount">0</span></div>
        <div class="stat-box">最大流向：<span id="topFlow">--</span> → <span id="topFlowTarget">0</span></div>
    </div>

    <div id="chart"></div>

    <script>
        const state = {
            dataByYear: {},
            years: [],
            currentIndex: 0,
            playing: false,
            timer: null,
            chart: echarts.init(document.getElementById('chart'))
        };

        const csvUrl = 'https://raw.githubusercontent.com/你的帳號/你的repo/main/template.csv'; // ⬅️ 改成你的 GitHub Raw CSV 連結

        // 顯示錯誤訊息
        function showError(msg) {
            const box = document.getElementById('errorBox');
            box.textContent = `❌ ${msg}`;
            box.style.display = 'block';
        }

        // 載入 CSV
        fetch(csvUrl)
            .then(res => {
                if (!res.ok) throw new Error('無法載入資料');
                return res.text();
            })
            .then(text => {
                const rows = text.trim().split(/\r?\n/);
                const headers = rows.shift().split(',');
                const yearIndex = headers.indexOf('Year');
                const sourceIndex = headers.indexOf('Source');
                const targetIndex = headers.indexOf('Target');
                const valueIndex = headers.indexOf('Value(KLOE)');

                rows.forEach(r => {
                    const cols = r.split(',');
                    const year = cols[yearIndex];
                    if (!state.dataByYear[year]) state.dataByYear[year] = [];
                    state.dataByYear[year].push({
                        Source: cols[sourceIndex],
                        Target: cols[targetIndex],
                        Value: parseFloat(cols[valueIndex])
                    });
                });

                state.years = Object.keys(state.dataByYear).sort();
                document.getElementById('yearSlider').max = state.years.length - 1;
                updateChart();
                document.getElementById('loadingOverlay').style.display = 'none';
            })
            .catch(err => {
                console.error(err);
                document.getElementById('loadingOverlay').style.display = 'none';
                showError('資料載入失敗，請確認連結或稍後再試');
            });

        document.getElementById('yearSlider').addEventListener('input', e => {
            state.currentIndex = parseInt(e.target.value);
            updateChart();
        });

        document.getElementById('playBtn').addEventListener('click', () => {
            state.playing = !state.playing;
            document.getElementById('playBtn').textContent = state.playing ? '⏸ 暫停' : '▶ 播放';
            if (state.playing) {
                state.timer = setInterval(() => {
                    state.currentIndex = (state.currentIndex + 1) % state.years.length;
                    document.getElementById('yearSlider').value = state.currentIndex;
                    updateChart();
                }, 1500);
            } else {
                clearInterval(state.timer);
            }
        });

        function updateChart() {
            const year = state.years[state.currentIndex];
            const records = state.dataByYear[year];
            document.getElementById('yearLabel').textContent = year;

            let links = records;
            if (document.getElementById('deptFilter').checked) {
                links = records.filter(d => d.Source.endsWith('部門') || d.Target.endsWith('部門'));
            }

            const nodes = new Set();
            links.forEach(d => {
                nodes.add(d.Source);
                nodes.add(d.Target);
            });

            const total = links.reduce((sum, d) => sum + d.Value, 0);
            const topFlow = links.reduce((a, b) => a.Value > b.Value ? a : b, { Source: '--', Target: '--', Value: 0 });

            document.getElementById('totalFlow').textContent = (total/1000).toFixed(1);
            document.getElementById('sourceCount').textContent = new Set(links.map(d => d.Source)).size;
            document.getElementById('targetCount').textContent = new Set(links.map(d => d.Target)).size;
            document.getElementById('topFlow').textContent = `${topFlow.Source} → ${topFlow.Target}`;
            document.getElementById('topFlowTarget').textContent = (topFlow.Value/1000).toFixed(1);

            state.chart.setOption({
                tooltip: { trigger: 'item' },
                series: [{
                    type: 'sankey',
                    layout: 'none',
                    emphasis: { focus: 'adjacency' },
                    data: [...nodes].map(name => ({ name })),
                    links: links.map(l => ({ source: l.Source, target: l.Target, value: l.Value })),
                    lineStyle: { color: 'gradient', curveness: 0.5 },
                    label: { color: '#fff', fontSize: 12 }
                }]
            });
        }
    </script>
</body>
</html>
