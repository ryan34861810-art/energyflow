<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台灣能源流向桑基圖 - 時間軸版</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif; background: linear-gradient(135deg,#0f172a 0%,#1e293b 50%,#064e3b 100%); min-height:100vh; padding:20px; color:white; }
        .container { max-width:1400px; margin:0 auto; }
        .header { text-align:center; margin-bottom:40px; }
        .header h1 { font-size:3em; background:linear-gradient(to right,#60a5fa,#34d399); -webkit-background-clip:text; -webkit-text-fill-color:transparent; margin-bottom:10px; }
        .header p { color:#cbd5e1; font-size:1.2em; }
        .control-panel { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border:1px solid rgba(255,255,255,0.2); border-radius:20px; padding:30px; margin-bottom:30px; }
        .controls-row { display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; flex-wrap:wrap; gap:15px; }
        .controls-left { display:flex; gap:15px; align-items:center; flex-wrap:wrap; }
        .btn { background:#3b82f6; color:white; border:none; padding:12px 24px; border-radius:10px; cursor:pointer; font-size:16px; display:flex; align-items:center; gap:8px; transition: all 0.3s; }
        .btn:hover { background:#2563eb; transform:translateY(-2px); }
        .btn-success { background:#10b981; }
        .btn-success:hover { background:#059669; }
        .year-display { font-size:2.5em; font-weight:bold; }
        .timeline { margin-bottom:20px; }
        .timeline input[type="range"] { width:100%; height:12px; border-radius:6px; outline:none; -webkit-appearance:none; cursor:pointer; }
        .timeline input[type="range"]::-webkit-slider-thumb { -webkit-appearance:none; width:24px; height:24px; border-radius:50%; background:white; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,0.3); }
        .year-labels { display:flex; justify-content:space-between; margin-top:10px; font-size:14px; }
        .year-label { cursor:pointer; transition:color 0.3s; }
        .year-label:hover { color:#60a5fa; }
        .stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:20px; margin-bottom:30px; }
        .stat-card { padding:20px; border-radius:15px; backdrop-filter: blur(10px); }
        .stat-card.blue { background: rgba(59,130,246,0.2); border:1px solid rgba(59,130,246,0.3); }
        .stat-card.green { background: rgba(16,185,129,0.2); border:1px solid rgba(16,185,129,0.3); }
        .stat-card.purple { background: rgba(168,85,247,0.2); border:1px solid rgba(168,85,247,0.3); }
        .stat-card.amber { background: rgba(245,158,11,0.2); border:1px solid rgba(245,158,11,0.3); }
        .stat-label { font-size:14px; opacity:0.8; margin-bottom:8px; }
        .stat-value { font-size:2em; font-weight:bold; margin-bottom:5px; }
        .stat-unit { font-size:12px; opacity:0.7; }
        .chart-container { background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); border:1px solid rgba(255,255,255,0.1); border-radius:20px; padding:20px; margin-bottom:30px; }
        #sankeyChart { width:100%; height:700px; }
        .info-box { background: rgba(59,130,246,0.1); border:1px solid rgba(59,130,246,0.2); border-radius:15px; padding:20px; margin-top:20px; }
        .info-box ul { margin-left:20px; margin-top:10px; }
        .info-box li { margin:8px 0; }
        @media (max-width:768px) { .header h1 { font-size:2em; } .controls-row { flex-direction:column; align-items:stretch; } .year-display { font-size:2em; } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🌟 台灣能源流向桑基圖</h1>
            <p>互動式時間軸探索能源流動</p>
        </div>

        <div class="control-panel" id="controlPanel">
            <div class="controls-row">
                <div class="controls-left">
                    <button class="btn" id="playBtn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <polygon points="5 3 19 12 5 21 5 3"></polygon>
                        </svg>
                        播放
                    </button>
                </div>
                <div class="year-display" id="yearDisplay">年份</div>
            </div>
            <div class="timeline">
                <input type="range" id="timelineSlider" min="0" max="0" value="0">
                <div class="year-labels" id="yearLabels"></div>
            </div>
        </div>

        <div class="stats-grid" id="statsGrid">
            <div class="stat-card blue">
                <div class="stat-label">總能源流量</div>
                <div class="stat-value" id="totalEnergy">0</div>
                <div class="stat-unit">千公噸油當量</div>
            </div>
            <div class="stat-card green">
                <div class="stat-label">能源來源</div>
                <div class="stat-value" id="sourceCount">0</div>
                <div class="stat-unit">種類</div>
            </div>
            <div class="stat-card purple">
                <div class="stat-label">能源去向</div>
                <div class="stat-value" id="targetCount">0</div>
                <div class="stat-unit">種類</div>
            </div>
            <div class="stat-card amber">
                <div class="stat-label">最大流向</div>
                <div class="stat-value" id="topFlow" style="font-size:1.2em;">--</div>
                <div class="stat-unit" id="topFlowTarget">--</div>
            </div>
        </div>

        <div class="chart-container" id="chartContainer">
            <div id="sankeyChart"></div>
        </div>

        <div class="info-box" id="infoBox">
            <strong>📖 使用說明：</strong>
            <ul>
                <li>拖動時間軸或點擊年份切換不同年度資料</li>
                <li>點擊「播放」按鈕自動循環播放所有年份</li>
                <li>桑基圖只顯示部門層級</li>
                <li>滑鼠懸停在連結和節點上查看詳細數值</li>
            </ul>
        </div>
    </div>

    <script>
        var state = {
            files: {},
            years: [],
            currentYear: null,
            isPlaying: false,
            showDepartmentOnly: true,
            chart: null
        };

        var departmentLevel = new Set([
            '工業部門','運輸部門','農業部門','服務業部門',
            '住宅部門','轉換效率損失','商業部門'
        ]);

        state.chart = echarts.init(document.getElementById('sankeyChart'));

        const csvFiles = {};
        for(let i=73;i<=113;i++){
            let numStr=i.toString().padStart(3,'0');
            csvFiles[numStr]=`https://raw.githubusercontent.com/ryan34861810-art/repo/main/template${numStr}.csv`;
        }

        async function loadAllCSV(){
            state.years=[];
            for(const year in csvFiles){
                try{
                    const response=await fetch(csvFiles[year]);
                    if(!response.ok) throw new Error('HTTP error '+response.status);
                    const text=await response.text();
                    state.files[year]=text;
                    state.years.push(year);
                }catch(err){
                    console.warn('讀取 CSV 失敗，跳過年份:', year, err);
                }
            }
            state.years.sort();
            if(state.years.length===0){ alert('沒有成功讀取任何年份資料！'); return; }
            state.currentYear=state.years[0];
            updateUI();
            updateChart();
        }

        function parseCSV(text){
            var lines=text.trim().split('\n');
            var headers=lines[0].split(',').map(h=>h.trim());
            var data=[];
            for(var i=1;i<lines.length;i++){
                var values=lines[i].split(',');
                if(values.length>=3){
                    var row={};
                    headers.forEach((h,index)=>{ row[h]=values[index]?values[index].trim():''; });
                    data.push(row);
                }
            }
            return data;
        }

        function filterToDepartmentLevel(data){
            return data.filter(row=>{
                return departmentLevel.has(row.Source)&&departmentLevel.has(row.Target);
            });
        }

        function updateUI(){
            document.getElementById('timelineSlider').max=state.years.length-1;
            document.getElementById('timelineSlider').value=state.years.indexOf(state.currentYear);
            document.getElementById('yearDisplay').textContent=state.currentYear;

            const labelsDiv=document.getElementById('yearLabels');
            labelsDiv.innerHTML='';
            state.years.forEach((y,i)=>{
                let span=document.createElement('span');
                span.className='year-label';
                span.textContent=y;
                span.style.color=(y===state.currentYear)?'#60a5fa':'#fff';
                span.onclick=()=>{ state.currentYear=y; updateUI(); updateChart(); }
                labelsDiv.appendChild(span);
            });
        }

        function updateChart(){
            const csvText=state.files[state.currentYear];
            const parsed=parseCSV(csvText);
            const filtered=filterToDepartmentLevel(parsed);

            const nodes=new Set();
            const links=[];
            filtered.forEach(row=>{
                nodes.add(row.Source); nodes.add(row.Target);
                links.push({source:row.Source,target:row.Target,value:+row.Value});
            });

            const option={
                tooltip:{ trigger:'item', triggerOn:'mousemove', formatter: function(params){ 
                    if(params.value) return `${params.source} → ${params.target}: ${params.value} 千公噸油當量`; 
                    return params.name; 
                }},
                series: [{
                    type:'sankey',
                    data:Array.from(nodes).map(n=>({name:n})),
                    links:links,
                    emphasis:{focus:'adjacency'},
                    lineStyle:{ color:'gradient', curveness:0.5 }
                }]
            };
            state.chart.setOption(option);

            // 更新統計數據
            const totalEnergy=links.reduce((sum,l)=>sum+l.value,0);
            document.getElementById('totalEnergy').textContent=totalEnergy.toLocaleString();
            document.getElementById('sourceCount').textContent=new Set(filtered.map(r=>r.Source)).size;
            document.getElementById('targetCount').textContent=new Set(filtered.map(r=>r.Target)).size;
            if(links.length>0){
                const topLink=links.reduce((max,l)=>l.value>max.value?l:max,links[0]);
                document.getElementById('topFlow').textContent=topLink.value;
                document.getElementById('topFlowTarget').textContent=topLink.Target;
            } else {
                document.getElementById('topFlow').textContent='--';
                document.getElementById('topFlowTarget').textContent='--';
            }
        }

        document.getElementById('timelineSlider').addEventListener('input',function(){
            const idx=parseInt(this.value);
            state.currentYear=state.years[idx];
            updateUI();
            updateChart();
        });

        document.getElementById('playBtn').addEventListener('click',function(){
            if(state.isPlaying){ state.isPlaying=false; this.textContent='▶ 播放'; }
            else{
                state.isPlaying=true;
                this.textContent='⏸ 暫停';
                let idx=state.years.indexOf(state.currentYear);
                function step(){
                    if(!state.isPlaying) return;
                    idx=(idx+1)%state.years.length;
                    state.currentYear=state.years[idx];
                    updateUI(); updateChart();
                    setTimeout(step,1500);
                }
                step();
            }
        });

        window.addEventListener('resize',()=>{ state.chart.resize(); });

        // 初始化
        loadAllCSV();
    </script>
</body>
</html>
