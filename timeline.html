<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>èƒ½æºæµæ™‚é–“è»¸è¦–è¦ºåŒ–</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://unpkg.com/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
  <style>
    body {
      font-family: "Noto Sans TC", sans-serif;
      margin: 0;
      padding: 0;
      background: #f8f9fa;
    }
    header {
      background: #343a40;
      color: white;
      padding: 15px 20px;
    }
    header h1 { margin: 0; font-size: 20px; }
    .slider-container {
      display: flex;
      align-items: center;
      justify-content: center;
      background: #343a40;
      padding: 15px;
      gap: 15px;
    }
    #yearLabel {
      color: #ffc107;
      font-weight: bold;
      font-size: 18px;
      min-width: 80px;
      text-align: center;
    }
    #chart { width: 100%; height: 600px; }
    svg text { font-size: 12px; fill: #333; }
    .tooltip {
      position: absolute;
      background: white;
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      pointer-events: none;
      font-size: 13px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
  </style>
</head>
<body>
  <header>
    <h1>è‡ºç£èƒ½æºæµè¦–è¦ºåŒ–ï¼ˆéƒ¨é–€å±¤ç´šï¼‰</h1>
  </header>
  <div class="slider-container">
    <input type="range" id="yearSlider" min="1984" max="2024" step="1" value="1984" />
    <span id="yearLabel">1984</span>
  </div>
  <div id="chart"></div>
  <div class="tooltip" id="tooltip" style="opacity:0;"></div>

  <script>
    const repoRaw = "https://raw.githubusercontent.com/ryan34861810-art/energyflow/main/";
    const fileStart = 73;
    const fileEnd = 113;
    const DEPARTMENT_LEVELS = ["å·¥æ¥­éƒ¨é–€","é‹è¼¸éƒ¨é–€","è¾²æ¥­éƒ¨é–€","æœå‹™æ¥­éƒ¨é–€","ä½å®…éƒ¨é–€","è½‰æ›æ•ˆç‡æå¤±"];

    const years = [];
    for (let i = fileStart; i <= fileEnd; i++) {
      const year = i + 1911;
      years.push({ file: `template${i.toString().padStart(3, '0')}.csv`, year });
    }

    const yearSlider = d3.select("#yearSlider")
      .attr("min", years[0].year)
      .attr("max", years[years.length - 1].year)
      .on("input", function() {
        const y = +this.value;
        d3.select("#yearLabel").text(y);
        const match = years.find(yy => yy.year === y);
        if (match) loadYear(match.file, y);
      });

    const tooltip = d3.select("#tooltip");
    let yearData = {}; // {1984: Map(key,value)}

    async function loadYear(filename, year) {
      const url = repoRaw + filename;
      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error("è®€å–å¤±æ•—");
        const csvText = await response.text();
        const data = d3.csvParse(csvText);

        // ğŸ”¸ åƒ…ä¿ç•™éƒ¨é–€å±¤ç´šçš„æµå‘
        const filtered = data.filter(d =>
          DEPARTMENT_LEVELS.includes(d.Target.trim())
        );

        // å„²å­˜ä»Šå¹´è³‡æ–™
        const linkMap = new Map();
        filtered.forEach(d => {
          const key = `${d.Source}->${d.Target}`;
          linkMap.set(key, +d["Value(kKLOE)"]);
        });
        yearData[year] = linkMap;

        drawSankey(filtered, year);
      } catch (err) {
        console.log(`âŒ ${filename} ç„¡æ³•è®€å–ï¼š${err.message}`);
        d3.select("#chart").html(`<p style="text-align:center;">${year} å¹´è³‡æ–™è®€å–å¤±æ•—</p>`);
      }
    }

    function drawSankey(data, year) {
      d3.select("#chart").html("");
      const width = document.getElementById("chart").clientWidth;
      const height = 600;

      const svg = d3.select("#chart").append("svg")
        .attr("width", width)
        .attr("height", height);

      const nodes = Array.from(new Set(data.flatMap(d => [d.Source, d.Target]))).map(name => ({ name }));
      const nodeIndex = Object.fromEntries(nodes.map((n, i) => [n.name, i]));
      const links = data.map(d => ({
        source: nodeIndex[d.Source],
        target: nodeIndex[d.Target],
        sourceName: d.Source,
        targetName: d.Target,
        value: +d["Value(kKLOE)"]
      }));

      const sankey = d3.sankey()
        .nodeWidth(20)
        .nodePadding(20)
        .extent([[1, 1], [width - 1, height - 6]]);

      const graph = sankey({ nodes: nodes.map(d => Object.assign({}, d)), links });

      // ç¯€é»
      svg.append("g")
        .selectAll("rect")
        .data(graph.nodes)
        .join("rect")
        .attr("x", d => d.x0)
        .attr("y", d => d.y0)
        .attr("height", d => d.y1 - d.y0)
        .attr("width", d => d.x1 - d.x0)
        .attr("fill", d => DEPARTMENT_LEVELS.includes(d.name) ? "#007bff" : "#6c757d");

      // é€£çµ
      svg.append("g")
        .attr("fill", "none")
        .selectAll("path")
        .data(graph.links)
        .join("path")
        .attr("d", d3.sankeyLinkHorizontal())
        .attr("stroke", "#999")
        .attr("stroke-width", d => Math.max(1, d.width))
        .attr("opacity", 0.5)
        .on("mousemove", function(event, d) {
          const prevYear = year - 1;
          const key = `${d.sourceName}->${d.targetName}`;
          const currentVal = d.value;
          let diffText = "ç„¡è³‡æ–™";

          if (yearData[prevYear] && yearData[prevYear].has(key)) {
            const prevVal = yearData[prevYear].get(key);
            const diff = ((currentVal - prevVal) / prevVal) * 100;
            const sign = diff >= 0 ? "â†‘" : "â†“";
            const color = diff >= 0 ? "green" : "red";
            diffText = `<span style="color:${color}">${sign}${Math.abs(diff).toFixed(1)}%</span>`;
          }

          tooltip.transition().duration(100).style("opacity", 1);
          tooltip.html(`
            <strong>${d.sourceName} â†’ ${d.targetName}</strong><br>
            æµé‡ï¼š${currentVal.toLocaleString()} kKLOE<br>
            èˆ‡å‰ä¸€å¹´è®ŠåŒ–ï¼š${diffText}
          `)
          .style("left", (event.pageX + 10) + "px")
          .style("top", (event.pageY - 30) + "px");
        })
        .on("mouseleave", () => tooltip.transition().duration(200).style("opacity", 0));

      // æ¨™ç±¤
      svg.append("g")
        .style("font", "12px sans-serif")
        .selectAll("text")
        .data(graph.nodes)
        .join("text")
        .attr("x", d => d.x0 < width / 2 ? d.x1 + 6 : d.x0 - 6)
        .attr("y", d => (d.y1 + d.y0) / 2)
        .attr("dy", "0.35em")
        .attr("text-anchor", d => d.x0 < width / 2 ? "start" : "end")
        .text(d => d.name);

      // å¹´ä»½æ¨™é¡Œ
      svg.append("text")
        .attr("x", 20)
        .attr("y", 30)
        .attr("font-size", "20px")
        .attr("font-weight", "bold")
        .text(`${year} å¹´èƒ½æºæµ`);
    }

    // é è¨­è¼‰å…¥ç¬¬ä¸€å€‹å¹´ä»½
    loadYear(years[0].file, years[0].year);
  </script>
</body>
</html>
